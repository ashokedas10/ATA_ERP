<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Primary_sale_controller  extends CI_Controller {

	public function __construct()
		{
			parent::__construct();
			$this->load->helper('url');
			$this->load->helper('form');
			$this->load->library('email');
			//$this->load->model('authmod');
			//$this->authmod->is_admin_login();
			$this->load->model('project_model', 'projectmodel');
			$this->load->model('accounts_model');
			$this->load->model('modeltree');
			$this->load->library(array('form_validation', 'trackback', 
			'pagination', 'mylib'));
			//$this->load->helper(array('dompdf', 'file'));
			$this->load->library('numbertowords');
			$this->load->library('general_library');
			$this->load->library('pdf'); 
			$this->load->helper('file'); 
			
			//EXCEL...FINAL
			$this->load->library('excel');
			$this->login_validate();
			
			// 250watt panel 30 for --daily 6 unit current(AC)
			//then for 1 unit  need 30/6 = 5 no of 250 watt panel
			//= 1250 watt..then for 3 unit ==1250x3=around 4000 watt-4kwh
			//
			// https://github.com/chrisnharvey/CodeIgniter-PDF-Generator-Library
			//$this->load->library('To_excel');
}

public function gst_reports($operation_type='listing')
{
	//$this->excel->setActiveSheetIndex(0);
		$data['startingdate']=date('Y-m-d');
		$data['closingdate']=date('Y-m-d');
		
		if(isset($_POST) && $operation_type=='Download')
		{
			$startingdate=$data['startingdate']=$this->input->post('startingdate');
			$closingdate=$data['closingdate']=$this->input->post('closingdate');
			$sheet = $this->excel->getActiveSheet();
     
      // SHEET B2B
	  $i=1;
      $objWorkSheet1 = $this->excel->createSheet($i); //Setting index when creating
    
	  $objWorkSheet1->setCellValue('A1', 'Summary For B2B(4)')
                   ->setCellValue('A2', 'No. of Recipients!')
                   ->setCellValue('B2', 'No. of Invoices')
                   ->setCellValue('D2', 'Total Invoice Value');
	
	 $objWorkSheet1->setCellValue('A4', 'GSTIN/UIN of Recipient')
                   ->setCellValue('B4', 'Invoice Number')
                   ->setCellValue('C4', 'Invoice date')
                   ->setCellValue('D4', 'Invoice Value')
				   ->setCellValue('E4', 'Place Of Supply')
				   ->setCellValue('F4', 'Reverse Charge')
				   ->setCellValue('G4', 'Invoice Type')
				   ->setCellValue('H4', 'E-Commerce GSTIN')
				   ->setCellValue('I4', 'Rate')
				   ->setCellValue('J4', 'Taxable Value')
				   ->setCellValue('K4', 'Cess Amount');
	
				// DATA portion
				$cell=5;
				$records="select * from invoice_summary where  status='SELL'  ";
				if($startingdate<>'' and $closingdate<>'')
				{
					$records=$records." and invoice_date between 
					'".$startingdate."' and '".$closingdate."' ";							
				}		
				$records=$records." order by invoice_date";
				$records =$this->projectmodel->get_records_from_sql($records);	
				foreach ($records as $record)
				{
				
				$gstno='';
				$other_records=" select * from stockist where id=".$record->tbl_party_id;
				$other_records =
				$this->projectmodel->get_records_from_sql($other_records);	
				foreach ($other_records as $other_record)
				{
					$gstno=$other_record->GSTNO;
					$statename_code=$other_record->STATE_CODE.'-'.$other_record->STATE_NAME;
				}
				
				$gstrate=$taxable_amt=0;
				$other_records="select * from invoice_details 
				where invoice_summary_id=".$record->id."";
				$other_records =
				$this->projectmodel->get_records_from_sql($other_records);	
				foreach ($other_records as $other_record)
				{
					$gstrate=$other_record->vat_per;
					$taxable_amt=$taxable_amt+$other_record->taxable_amt;
				}
				$taxable_amt=round($taxable_amt*$gstrate/100,2);
				
				$month='';
				if(substr($record->invoice_date,5,2)=='01')
				{ $month='JAN';  }
				if(substr($record->invoice_date,5,2)=='02')
				{  $month='FEB';  }
				if(substr($record->invoice_date,5,2)=='03')
				{  $month='MAR';  }
				if(substr($record->invoice_date,5,2)=='04')
				{  $month='APR';  }
				if(substr($record->invoice_date,5,2)=='05')
				{  $month='MAY';  }
				if(substr($record->invoice_date,5,2)=='06')
				{  $month='JUN';  }
				if(substr($record->invoice_date,5,2)=='07')
				{  $month='JUL';  }
				if(substr($record->invoice_date,5,2)=='08')
				{ $month='AUG';   }
				if(substr($record->invoice_date,5,2)=='09')
				{  $month='SEP';  }
				if(substr($record->invoice_date,5,2)=='10')
				{  $month='OCT';  }
				if(substr($record->invoice_date,5,2)=='11')
				{  $month='NOV';  }
				if(substr($record->invoice_date,5,2)=='12')
				{  $month='DEC';  }
				
				
				$newdate=
				substr($record->invoice_date,8,2).'-'.
				$month.'-'.
				substr($record->invoice_date,2,2);
				
					if($gstno<>'')
					{
						$objWorkSheet1->setCellValue('A'.$cell, $gstno)
						   ->setCellValue('B'.$cell, $record->invoice_no)
						   ->setCellValue('C'.$cell, $newdate)
						   ->setCellValue('D'.$cell, $record->grandtot)
						   ->setCellValue('E'.$cell, $statename_code)
						   ->setCellValue('F'.$cell, 'N/Y')
						   ->setCellValue('G'.$cell, 'Regular')
						   ->setCellValue('H'.$cell, '')
						   ->setCellValue('I'.$cell, $gstrate)
						   ->setCellValue('J'.$cell, $taxable_amt)
						   ->setCellValue('K'.$cell, 'Cess Amount');
					
					    $cell=$cell+1;	   
					 }
				}
				
      			// Rename sheet
    			 $objWorkSheet1->setTitle("B2B");
	
	
	
			/*  $i=2;
			  $objWorkSheet = $this->excel->createSheet($i); 
			  //Setting index when creating
			  //Write cells
			  $objWorkSheet->setCellValue('A1', 'Hello'.$i)
						   ->setCellValue('B2', 'world!')
						   ->setCellValue('C1', 'Hello')
						   ->setCellValue('D2', 'world!');
			  // Rename sheet
			 $objWorkSheet ->setTitle("B2C");
			*/
 
			$filename='GST.xls'; //save our workbook as this file name
			header('Content-Type: application/vnd.ms-excel'); //mime type
			header('Content-Disposition: attachment;filename="'.$filename.'"'); 
			//tell browser what's the file name
			header('Cache-Control: max-age=0'); //no cache
						
			//save it to Excel5 format (excel 2003 .XLS file), 
			//change this to 'Excel2007' (and adjust the filename 
			//extension, also the header mime type)
			//if you want to save it as .XLSX Excel 2007 format
			$objWriter = PHPExcel_IOFactory::createWriter($this->excel, 'Excel5');  
			//force user to download the Excel file without writing it to server's HD
			$objWriter->save('php://output');

		}

		$view_path_name='primary_sale_view/reports/gst_reports';
	    $this->page_layout_display($view_path_name,$data);


}


public function expense_ratio_report($operation_type='listing')
{
			
			$layout_data=array();
			$data=array();
			$data['hq_id']='';
			$data['month_year_to']=$data['month_year_from']=date('Y-m-d');
			
			if(isset($_POST))
			{	
				if($operation_type=='listing')
				{
				$data['month_year_to']=$data['month_year_from']=date('Y-m-d');
				}	
				if($operation_type=='save')
				{
				$data['month_year_to']=$this->input->post('month_year_to');
				$data['month_year_from']=$this->input->post('month_year_from');
				}
			}
			
			$view_path_name='primary_sale_view/reports/expense_ratio_report';
	   		$this->page_layout_display($view_path_name,$data);	
				   
}	
	
	
public function hq_wise_sale_summary($operation_type='listing')
{
			
			$layout_data=array();
			$data=array();
			$data['month_year_to']=$data['month_year_from']=date('Y-m-d');
		
			if(isset($_POST))
			{	
				if($operation_type=='listing')
				{
				$data['month_year_to']=$data['month_year_from']=date('Y-m-d');
				}	
				if($operation_type=='save')
				{
				$data['month_year_to']=$this->input->post('month_year_to');
				$data['month_year_from']=$this->input->post('month_year_from');
				}
			}
			
			$view_path_name='primary_sale_view/reports/hq_wise_sale_summary';
	   		$this->page_layout_display($view_path_name,$data);	
				   
}	

public function hq_wise_sale_reports($operation_type='listing')
{
			
			$layout_data=array();
			$data=array();
			$data['hq_id']='';
		    $data['month_year_to']=$data['month_year_from']=date('Y-m-d');
			
			if(isset($_POST))
			{	
				if($operation_type=='listing')
				{
				$data['month_year_to']=$data['month_year_from']=date('Y-m-d');
				}	
				if($operation_type=='save')
				{
				$data['month_year_to']=$this->input->post('month_year_to');
				$data['month_year_from']=$this->input->post('month_year_from');
				}
			}
			
			 $view_path_name='primary_sale_view/reports/hq_wise_sale_report';
	   		$this->page_layout_display($view_path_name,$data);	
				   
}

public function hq_product_wise_monthly_target($operation='list')
{
		$data['month_year']=date('Y-m-d');
		
		if(isset($_POST) && $operation=='savedata')
		{
			$month_year=$data['month_year']=
			$data_save['month_year']=$this->input->post('month_year');
			$data_save['month_year_date']=$data_save['month_year'].'-01';
			
			$parentuid=$data['parentuid']=$this->input->post('parentuid');
			
			$records="select * from tbl_hierarchy_org where id in 
			(select childuid from tbl_organisation_chain
			where  child_desig_srl=5 and parentuid='$parentuid') 
			order by hierarchy_name ";
			$records = $this->projectmodel->get_records_from_sql($records);
			foreach ($records as $record)
			{ 
			$hqid=$record->id;
			
			$product_sql="select * from brands where 
			brandtype='BRAND' order by brand_name";
			$product_rows = $this->projectmodel->get_records_from_sql($product_sql);	
			foreach ($product_rows as $product_row)
			{
			$prd_id=$product_row->id;
			
			$data_save['hq_id']=$hqid;
			$data_save['product_id']=$prd_id;
			$data_save['target_qnty']=$this->input->post($prd_id.$hqid);
			
			$saveid='';
			$mr_target_product_wises="select * from mr_target_product_wise where 
			hq_id=".$hqid." and product_id=".$prd_id." and month_year='$month_year' ";
			$mr_target_product_wises = 
			$this->projectmodel->get_records_from_sql($mr_target_product_wises);	
			foreach ($mr_target_product_wises as $mr_target_product_wise)
			{$saveid=$mr_target_product_wise->id;}
			
				$this->projectmodel->save_records_model($saveid,
				'mr_target_product_wise',$data_save);
				
				/*$this->session->set_userdata('alert_msg',
				'One Record Inserted Successfully');*/
			
			}}
			
		redirect('primary_sale_controller/hq_product_wise_monthly_target/list/');
		
		}
		
		
		if(isset($_POST) && $operation=='list')
		{
				$data['month_year']=$this->input->post('month_year');
				$data['parentuid']=$this->input->post('hq_id');
		}
				
		$view_path_name='primary_sale_view/transaction/hq_product_wise_monthly_target';
	    $this->page_layout_display($view_path_name,$data);
		
}	

public function batch_wise_product_search($trantype='list',$product_id=0)
{
		$data['product_id']=0;
		$data['batchno']='';
		
		if($trantype=='list')
		{$data['product_id']=$product_id;}
		
		if(isset($_POST) && $trantype=='display')
		{
		$data['product_id']=$this->input->post('product_id');
		$data['batchno']=$this->input->post('batchno');
		}
	
	   $view_path_name='primary_sale_view/reports/batch_wise_product_search';
	   $this->page_layout_display($view_path_name,$data);
}

public function manager_wise_sale_sum()
{
		$data['month_year_from']=date('Y-m-d');
		$data['month_year_to']=date('Y-m-d');
		
		//product wise sale
		
		$login_emp_id=$this->session->userdata('billing_emp_id'); 
						
				$sql="select a.id
				from tbl_hierarchy_org a,tbl_employee_mstr b 
				where a.employee_id=".$login_emp_id." 
				and b.id=a.employee_id  
				and a.tbl_designation_id<5
				order by  hierarchy_name";
				$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
				foreach ($rowrecord as $row1)
				{$ownid=$row1->id;}
		
		
		$data['parentuid']=$ownid;
		
		if(isset($_POST))
		{
				$data['month_year_from']=$this->input->post('month_year_from');
				$data['month_year_to']=$this->input->post('month_year_to');
				$data['parentuid']=$this->input->post('hq_id');
		}
				
		$view_path_name='primary_sale_view/reports/manager_wise_sale_sum';
	    $this->page_layout_display($view_path_name,$data);
		
}	

public function party_ledger_all($operation_type='listing',$id=0)
{
			$this->login_validate();
			$layout_data=array();
			$data=array();
	 
	 		/*  $view_path_name='tour_program/hq_to_location_master';
	   		$this->report_page_layout_display($view_path_name,$data);*/
	   
	   	   $layout_data['data_info'] = 
		   $this->load->view('primary_sale_view/reports/party_ledger_all',$data, true);			
		   $layout_data['body'] = $this->load->view('common/body', $layout_data, true);		 
		   $this->load->view('layout_only_body', $layout_data);
		  
		/*
		$this->pdf->load_view('primary_sale_view/reports/party_ledger_all', $data);
		$this->pdf->render();
		$this->pdf->stream("pdf/operator_ppf.pdf");				
		write_file("pdf/operator_ppf.pdf", $this->pdf->output());
		*/
		   
}	



public function experiment()
{		
		$this->load->helper('xml');
		$dom = xml_dom();
		$book = xml_add_child($dom, 'book');		 
		xml_add_child($book, 'title', 'Hyperion');
		$author = xml_add_child($book, 'author', 'Dan Simmons');		
		xml_add_attribute($author, 'birthdate', '1948-04-04');
		xml_print($dom);
		
		
		//EXCEL IMPORT
		
		// for example $this->excel_reader->read('./uploads/file.xls');
		/*$this->load->library('excel_reader');
		 $excel_path=BASE_PATH_ADMIN.'uploads/excel/';
		$this->excel_reader->read($excel_path.'MASTER_STRUCTURE.xls');
		
		// Get the contents of the first worksheet
		echo $worksheet = $this->excel_reader->worksheets[0];
		
		print_r($worksheet);*/
		
		
		/* //load library phpExcel
		  $this->load->library('excel');
		  //here i used microsoft excel 2007
		   $objReader = PHPExcel_IOFactory::createReader('Excel2007');
		  //set to read only
		  $objReader->setReadDataOnly(true);
		  //load excel file
		  $excel_path=BASE_PATH_ADMIN.'uploads/excel/';
		  
		  $objPHPExcel = $objReader->load('MASTER_STRUCTURE.xlsx');
		  $objWorksheet = $objPHPExcel->setActiveSheetIndex(0);
		  
		  //load model
		  //$this->load->model("User_model");
		  //loop from first data until last data
		  for($i=2; $i<=77; $i++)
		  {
		   $name = $objWorksheet->getCellByColumnAndRow(0,$i)->getValue();
		   $address = $objWorksheet->getCellByColumnAndRow(1,$i)->getValue();
		   $data_user = array(
			"name" => $name,
			"username" => $address);
			
		  // $this->User_model->add_data($data_user);
		  }
		  print_r($data_user);
		  */
		  
		  //Here a function in model file
			/*function add_data($datauser)
			 {
			  $this->db->insert('data',$datauser);
			  return $this->db->insert_id();
			 } */
			 
	//EXCEL IMPORT	  
		  

//$this->load->library('excel');		  
//$this->load->library('excel');
	
//WORKING EXCEL CODE
		 
//activate worksheet number 1

/*$this->excel->setActiveSheetIndex(0);
//name the worksheet
$this->excel->getActiveSheet()->setTitle('test worksheet');
//set cell A1 content with some text
$this->excel->getActiveSheet()->setCellValue('A1', 'This is just some text value');
//change the font size
$this->excel->getActiveSheet()->getStyle('A1')->getFont()->setSize(20);
//make the font become bold
$this->excel->getActiveSheet()->getStyle('A1')->getFont()->setBold(true);
//merge cell A1 until D1
$this->excel->getActiveSheet()->mergeCells('A1:D1');
//set aligment to center for that merged cell (A1 to D1)
$this->excel->getActiveSheet()->getStyle('A1')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
 
$filename='just_some_random_name.xls'; //save our workbook as this file name
header('Content-Type: application/vnd.ms-excel'); //mime type
header('Content-Disposition: attachment;filename="'.$filename.'"'); //tell browser what's the file name
header('Cache-Control: max-age=0'); //no cache
 
//save it to Excel5 format (excel 2003 .XLS file), change this to 'Excel2007' (and adjust the filename extension, also the header mime type)
//if you want to save it as .XLSX Excel 2007 format
$objWriter = PHPExcel_IOFactory::createWriter($this->excel, 'Excel5');  
//force user to download the Excel file without writing it to server's HD
$objWriter->save('php://output');*/
		  
//WORKING EXCEL CODE		  
		  
		
		// excel export
		
		/*
		$excel_header['fld1'] = 'fld1';
		$excel_header['fld2'] = 'fld2';
		$excel_header['fld3'] = 'fld3';
		$excel_header['fld4'] = 'fld4';		
		
		$sql="select invoice_no,invoice_date,total_amt,status from invoice_summary ";
		$excel_data = $this->projectmodel->get_records_from_sql($sql);	
		$this->general_library->to_excel($excel_header,$excel_data, 'myfile');
		 */
		 
		
}
	
	
	function dbbackup()
    {
        
		$this->login_validate();
		// Load the DB utility class
        $this->load->dbutil();
        // Backup your entire database and assign it to a variable
        $backup =& $this->dbutil->backup(); 
        // Load the file helper and write the file to your server
        $this->load->helper('file');
        $date = date('Ymd');
        write_file('./backup/filename'.$date.'.zip', $backup); 
        $this->load->library('email');
        $config['mailtype'] = "html";        
        $this->email->initialize($config);    
 
        $this->email->from('admin@twebsite.com', 'Website Name Backup');
        $this->email->to('email@webmaster.com');
        $date1 = date('Y-m-d');
        $this->email->subject('Site Backup');
        $this->email->attach('../backup/filename'.$date.'.zip');    
        $this->email->message('Backup for Date '.$date1);    
 
        $this->email->send();
        //Now delete the file
        unlink('../backup/filename'.$date.'.zip');
 
    }
	
	
	private function login_validate(){
       if($this->session->userdata('login_userid')=='')
		{ $this->logout();}
	   	else
	   {
	         $COMP_ID='';
			 $sqlemp="select * from company_details where id=1";
			 $rowrecordemp = $this->projectmodel->get_records_from_sql($sqlemp);	
			 foreach ($rowrecordemp as $rowemp)
			 {$this->session->set_userdata('COMP_ID', $rowemp->COMP_ID);}	
	   }	
	  
    }	
	
	public function next_child_hierarchy()
	{
	$data_list['parentid'] =$this->input->post('parentid');
	$data_list['desigid'] =$this->input->post('desigid');
	$data_list['ajaxname'] ='NEXT_CHILD';
	$this->load->view('primary_sale_view/ajax_view', $data_list);
	}
	
	public function showstockist()
	{
	 
	 $data_list['parentid'] =$this->input->post('parentid');
	 $data_list['desigid'] =$this->input->post('desigid');
	$data_list['ajaxname'] ='SHOW_STOCKIST';
	$this->load->view('primary_sale_view/ajax_view', $data_list);
	}
	
	public function show_stockist_list()
	{	 
	 $data_list['hq_id'] =$this->input->post('hq_id');	
	 $data_list['ajaxname'] ='show_stockist_list';
	 $this->load->view('primary_sale_view/ajax_view', $data_list);
	}
	
	
	public function credit_bill_ajax()
	{
		  $data_list['tbl_party_id'] =$this->input->post('tbl_party_id');
		 $data_list['ajaxname'] =$this->input->post('ajaxname');
		 $this->load->view('primary_sale_view/ajax_view', $data_list);
	}
	
	public function stockist_wise_mr()
	{
		  $data_list['tbl_party_id'] =$this->input->post('tbl_party_id');
		 $data_list['ajaxname'] =$this->input->post('ajaxname');
		 $this->load->view('primary_sale_view/ajax_view', $data_list);
	}
	
	public function stockist_bill_type()
	{
		 $data_list['tbl_party_id'] =$this->input->post('tbl_party_id');
		 $data_list['ajaxname'] =$this->input->post('ajaxname');
		 $this->load->view('primary_sale_view/ajax_view', $data_list);
	}
	
	public function load_stockist()
	{
		 $data_list['hqval'] =$this->input->post('hqval');
		 $data_list['ajaxname'] =$this->input->post('ajaxname');
		 $this->load->view('primary_sale_view/ajax_view', $data_list);
	}
	
	
	
	/*AJAX SECTION*/
		
	public function show_batch()
	{
	 $data_list['product_id'] =$this->input->post('product_id');
	 $data_list['status']=$this->input->post('status');
	 $data_list['tbl_party_id']=$this->input->post('tbl_party_id');
	
	if($this->input->post('status')=='PRCHS_RTN')
	{$data_list['ajaxname'] ='PRCHS_RTN_BATCH';}
	
	if($this->input->post('status')=='SELL')
	{$data_list['ajaxname'] ='SELL_BATCH';}
	
	if($this->input->post('status')=='SELL_RTN')
	{$data_list['ajaxname'] ='SELL_RTN_BATCH';}
	
	$this->load->view('primary_sale_view/ajax_view', $data_list);	
	
	}
	
	public function product_batch_ajax()
	{
	$data_list['product_id'] =$this->input->post('product_id');
	$data_list['batchno'] =$this->input->post('batchno');
	$data_list['status']=$this->input->post('status');
	$data_list['tbl_party_id']=$this->input->post('tbl_party_id');
	$data_list['invoice_details_id_batch']=
	$this->input->post('invoice_details_id_batch');
	
	
	if($this->input->post('status')=='PURCHASE')
	{$data_list['ajaxname'] ='PURCHASE_PRODUCT_BATCH';}
	
	if($this->input->post('status')=='PRCHS_RTN')
	{$data_list['ajaxname'] ='SHOW_BATCH_DETAILS';}
	
	if($this->input->post('status')=='SELL')
	{$data_list['ajaxname'] ='SHOW_BATCH_DETAILS_SELL';}
	
	if($this->input->post('status')=='SELL_RTN')
	{$data_list['ajaxname'] ='SHOW_BATCH_DETAILS_SELL_RTN';}
			
	$this->load->view('primary_sale_view/ajax_view', $data_list);	
	
	}
	
	
	public function show_batch_sample()
	{
	$data_list['product_id'] =$this->input->post('product_id');
	$data_list['status']=$this->input->post('status');
	$data_list['tbl_party_id']=$this->input->post('tbl_party_id');
	$data_list['ajaxname'] ='SAMPLE_BATCH';
	$this->load->view('primary_sale_view/ajax_view', $data_list);
	}
	
	public function product_batch_ajax_sample()
	{
	$data_list['product_id'] =$this->input->post('product_id');
	$data_list['batchno'] =$this->input->post('batchno');
	$data_list['status']=$this->input->post('status');
	$data_list['tbl_party_id']=$this->input->post('tbl_party_id');
	$data_list['ajaxname'] ='SHOW_BATCH_DETAILS_SAMPLE_ISU';		
	$this->load->view('primary_sale_view/ajax_view', $data_list);	
	
	}	
		
		
	public function rcv_ajax()
	{
	//echo $this->input->post('barcodeval');
	$data_list['ajaxname'] ='RCV_DUE_INVOICE';
	$data_list['partyid'] =$this->input->post('partyid');
	$this->load->view('primary_sale_view/ajax_view', $data_list);
	}
	
	
	public function exp_ajax()
	{
	//echo $this->input->post('barcodeval');
	$data_list['ajaxname'] ='EXP';
	$data_list['partyid'] =$this->input->post('partyid');
	$this->load->view('primary_sale_view/ajax_view', $data_list);
	}
			
	/*AJAX SECTION END*/
	
	public function stock_opening($displaytype='list',$id=0)	
	 {
	 
		$this->login_validate();
		$layout_data=array();
		$data=array();
		$this->session->set_userdata('invoice_summary_id','');	
	
		/*CHANGE HERE*/
		$viewname='stock_opening';
		$table_name='invoice_summary';
		$redirectlist='primary_sale_controller/stock_opening/'.
		$this->uri->segment(2).'/'.$displaytype.'/';
		$viewnamepath='primary_sale_view/transaction/'.$viewname;
		$data['product_del'] = 
		ADMIN_BASE_URL."primary_sale_controller/stock_opening/";
		
		/*CHANGE HERE*/
		$data['product_addedit'] = 
		ADMIN_BASE_URL.'primary_sale_controller/stock_opening/addeditview/'; 
		
		//vendor list ....
		$where_array = array('status ' => 'PARTY');
		$data['vendorlist'] = 
		$this->projectmodel->get_all_record('tbl_party',$where_array);
				
		$where_array = array('id >' => 0,'brandtype '=> 'BRAND');
		$data['productlist'] =
		$this->projectmodel->get_all_record('brands',$where_array);
					
		$where_array = array('status' => 
		'PURCHASE','STOCK_ENTRY_STATUS' => 'OPENING');
		
		$data['projectlist'] = 
		$this->projectmodel->get_all_record('invoice_summary',$where_array);
			
		$data['user_name'] = $this->session->userdata('user_name');
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
				
		if($displaytype=='list')
				{
					$data['records']="";
					$data['productid'] ="0";
					//redirect('primary_sale_controller/purchase_section/list/');
				}
		if($displaytype=='addeditview')
				{
					$where_array = array('id' => $id);
					$data['records'] = 
					$this->projectmodel->get_all_record($table_name,$where_array);
					$data['productid'] =$id;
				}
				
		if($displaytype=='addedit') //add --update
				{
					$where_array = array('id' => $id);
					$data['records'] = 
					$this->projectmodel->get_all_record($table_name,$where_array);			
					$data['productid'] =$id;
					
			// add edit section start
				if(isset($_POST))
				{	
					
					$values=$this->input->post();
					$data['productid'] =$values['id'];
					$TRANTYPE=$this->input->post('status');
					
					$invoice_summary_id=$this->input->post('id');
					$invoice_details_id=$this->input->post('invoice_details_id');
				
					//VALIDATION SECTION
					$this->form_validation->set_rules('invoice_date','Invoice Date','required');
					$this->form_validation->set_rules('tbl_party_id','Party Name','required');
					if($this->form_validation->run()==FALSE )
					{
						$this->session->set_userdata('alert_msg', validation_errors());
						redirect('primary_sale_controller/stock_opening/'.
						$invoice_summary_id.'/'.$invoice_details_id.'/');
					}
					//VALIDATION SECTION
						
				else  //validation pass
				{
									
					$save_data['id']=$this->input->post('id');
					$save_data['status']=$this->input->post('status');
					
					$save_data['invoice_no']=$this->input->post('invoice_no');
					$save_data['invoice_date']=$this->input->post('invoice_date');
					$save_data['challan_no']=$this->input->post('challan_no');	
					$save_data['challan_date']=$this->input->post('challan_date');	
					$save_data['orderno']=$this->input->post('orderno');	
					$save_data['orderdate']=$this->input->post('orderdate');	
					$save_data['trno']=$this->input->post('trno');	
					$save_data['trdate']=$this->input->post('trdate');						
					$save_data['tbl_party_id']=$this->input->post('tbl_party_id');
					$save_data['vehicle_no']=$this->input->post('vehicle_no');
					$save_data['comment']=$this->input->post('comment');
					$save_data['STOCK_ENTRY_STATUS']='OPENING';
									
					$save_data['total_amt']=$this->input->post('total_amt');	
					$save_data['disc_per']=$this->input->post('disc_per');	
					$save_data['tot_discount']=$this->input->post('tot_discount');	
					$save_data['totvatamt']=$this->input->post('totvatamt');	
					$save_data['grandtot']=$this->input->post('grandtot');	
									
					$save_data['total_adjust_amt']=0;
					
															
					if($values['id']==0) // insert data....
					{
						$TRANTYPE=$this->input->post('status');
						$this->projectmodel->save_records_model($values['id'],
						$table_name,$save_data);
						$invoiceid=$this->db->insert_id();
						$this->session->set_userdata('alert_msg',
						'One Record Inserted Successfully');
					}	
					
					if($values['id']>0)// update data....
					{
						$this->projectmodel->save_records_model($values['id'],
						$table_name,$save_data);
						$invoiceid=$values['id'];
						$this->session->set_userdata('alert_msg', 
						'One Record Updated Successfully');						
					}
			
				
				//INVOICE DETAIL DECTION
		
				$inv_details['status']=$save_data['status'];
				$inv_details['batchno']=$this->input->post('batchno');
				$inv_details['exp_monyr']=$this->input->post('exp_monyr');	
				$inv_details['mfg_monyr']=$this->input->post('mfg_monyr');
				$inv_details['qnty']=$this->input->post('qnty');
				$inv_details['freeqty']=$this->input->post('freeqty');	
				$inv_details['totqnty']=$inv_details['qnty']+$inv_details['freeqty'];
				$inv_details['rate']=$this->input->post('rate');	
				$inv_details['srate']=$this->input->post('srate');
				$inv_details['ptr']=$this->input->post('ptr');
				$inv_details['mrp']=$this->input->post('mrp');	
				$inv_details['vat_per']=$this->input->post('vat_per');
				/*$inv_details['vatamt']=
				$inv_details['totqnty']*$inv_details['mrp']*
				$this->input->post('vat_per')/100;*/
				
				$inv_details['ed']=$this->input->post('ed');
				
				$totamt=$inv_details['qnty']*$inv_details['rate'];
				$inv_details['subtotal']=round($totamt,2);
					
				$inv_details['invoice_summary_id']=$invoiceid;
				$inv_details['id']=$this->input->post('invoice_detail_id');
				$inv_details['product_id']=$this->input->post('product_id');
				
				
				if($inv_details['product_id']<>'')
				{
				$pieces_ids = explode("-", $inv_details['product_id']);
				$inv_details['pkg']=$pieces_ids[0];
				$inv_details['product_id']=$pieces_ids[1];
				$this->projectmodel->save_records_model($inv_details['id'],
				'invoice_details',$inv_details);
				}	
				
				if($inv_details['totqnty']==0)
				{
				$sql="delete from  invoice_details  
				 where invoice_summary_id=".$invoiceid." and  
				 id=".$inv_details['id'];
				$this->db->query($sql);				
				}
				
				$sqlqty="select * from invoice_details where 
				invoice_summary_id=".$invoiceid;
				$avlqty = $this->projectmodel->get_records_from_sql($sqlqty);
				
				if(count($avlqty)==0)
				{
					$sql="delete from  invoice_summary  
					 where id=".$invoiceid." ";
					$this->db->query($sql);				
				}
				
				
				/*$inv_details['vatamt']=
				$inv_details['totqnty']*$inv_details['mrp']*
				$this->input->post('vat_per')/100;*/
				
				$subtotal=0;
				$totvatamt=0;
				$grandtot=0;
				$tot_discount=0;
				
				$sqlqty="select SUM(subtotal) subtotal,SUM(vatamt) vatamt
				from invoice_details where invoice_summary_id=".$invoiceid;
				$avlqty = $this->projectmodel->get_records_from_sql($sqlqty);
				foreach ($avlqty as $rowq){	
				$subtotal=$rowq->subtotal;
				$tot_discount=$subtotal*$save_data['disc_per']/100;
				$totvatamt=$rowq->vatamt;
				$grandtot=$subtotal-$tot_discount;
				}
				
				$grandtot=sprintf("%01.2f",$grandtot);
				$grandtot1=sprintf("%01.0f",$grandtot);
				$rnd=$grandtot-$grandtot1;
				$rnd=sprintf("%01.2f",$rnd);
				
				if($rnd>=.5)
				{ $grandtot=$grandtot+$rnd;	}
				else
				{ $grandtot=$grandtot-$rnd;	}
								
				$sql="update invoice_summary set 
				 total_amt='$subtotal',tot_discount='$tot_discount',
				 totvatamt='$totvatamt',grandtot='$grandtot',rndoff='$rnd' 
				 where id=".$invoiceid;
				$this->db->query($sql);
				
			
				redirect('primary_sale_controller/stock_opening/addeditview/'.
				$invoiceid.'/0/');
						
								
		}
	  }		
	}
		
		$layout_data['data_info'] = $this->load->view($viewnamepath,$data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout', $layout_data);
		$this->session->set_userdata('alert_msg', '');	
		
 }
	
	
	
	
		
	public function purchase_section($displaytype='list',$id=0)	
	 {
	
	 	 
	 
		$this->login_validate();
		$layout_data=array();
		$data=array();
		$this->session->set_userdata('invoice_summary_id','');	
	
		/*CHANGE HERE*/
		$viewname='purchase';
		$table_name='invoice_summary';
		$redirectlist='primary_sale_controller/purchase_section/'.
		$this->uri->segment(2).'/'.$displaytype.'/';
		$viewnamepath='primary_sale_view/transaction/'.$viewname;
		$data['product_del'] = 
		ADMIN_BASE_URL."primary_sale_controller/purchase_section/";
		
		/*CHANGE HERE*/
		$data['product_addedit'] = 
		ADMIN_BASE_URL.'primary_sale_controller/purchase_section/addeditview/'; 
		
		//vendor list ....
		$where_array = array('status ' => 'PARTY');
		$data['vendorlist'] = 
		$this->projectmodel->get_all_record('tbl_party',$where_array);
				
		$where_array = array('id >' => 0,'brandtype '=> 'BRAND');
		$data['productlist'] =
		$this->projectmodel->get_all_record('brands',$where_array);
					
		$where_array = array('status' => 'PURCHASE',
		'STOCK_ENTRY_STATUS' => 'NOT_OPENING');
		$data['projectlist'] = 
		$this->projectmodel->get_all_record('invoice_summary',$where_array);
			
		$data['user_name'] = $this->session->userdata('user_name');
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
				
		if($displaytype=='list')
				{
					$data['records']="";
					$data['productid'] ="0";
					//redirect('primary_sale_controller/purchase_section/list/');
				}
		if($displaytype=='addeditview')
				{
					$where_array = array('id' => $id);
					$data['records'] = 
					$this->projectmodel->get_all_record($table_name,$where_array);
					$data['productid'] =$id;
				}
				
		if($displaytype=='addedit') //add --update
				{
					$where_array = array('id' => $id);
					$data['records'] = 
					$this->projectmodel->get_all_record($table_name,$where_array);			
					$data['productid'] =$id;
					
			// add edit section start
				if(isset($_POST))
				{	
					
					$values=$this->input->post();
					$data['productid'] =$values['id'];
					$TRANTYPE=$this->input->post('status');
					
					$invoice_summary_id=$this->input->post('id');
					$invoice_details_id=$this->input->post('invoice_details_id');
				
					//VALIDATION SECTION
					$this->form_validation->set_rules('invoice_date','Invoice Date','required');
					$this->form_validation->set_rules('tbl_party_id','Party Name','required');
					if($this->form_validation->run()==FALSE )
					{
						$this->session->set_userdata('alert_msg', validation_errors());
						redirect('primary_sale_controller/purchase_section/'.
						$invoice_summary_id.'/'.$invoice_details_id.'/');
					}
					//VALIDATION SECTION
						
				else  //validation pass
				{
									
					$save_data['id']=$this->input->post('id');
					$save_data['status']=$this->input->post('status');
					
					$save_data['invoice_no']=$this->input->post('invoice_no');
					$save_data['invoice_date']=$this->input->post('invoice_date');
					$save_data['challan_no']=$this->input->post('challan_no');	
					$save_data['challan_date']=$this->input->post('challan_date');	
					$save_data['orderno']=$this->input->post('orderno');	
					$save_data['orderdate']=$this->input->post('orderdate');	
					$save_data['trno']=$this->input->post('trno');	
					$save_data['trdate']=$this->input->post('trdate');						
					$save_data['tbl_party_id']=$this->input->post('tbl_party_id');
					$save_data['vehicle_no']=$this->input->post('vehicle_no');
					$save_data['comment']=$this->input->post('comment');
					
					$save_data['excise_duty_description']=
					$this->input->post('excise_duty_description');
					$save_data['excise_duty_total']=
					$this->input->post('excise_duty_total');
									
					$save_data['total_amt']=$this->input->post('total_amt');	
					$save_data['disc_per']=$this->input->post('disc_per');	
					$save_data['tot_discount']=$this->input->post('tot_discount');	
					$save_data['totvatamt']=$this->input->post('totvatamt');
					
					$save_data['vat_ledger_id']=$this->input->post('vat_ledger_id');
					
					$cst_percentage=$save_data['cst_percentage']=0;
					$sqlinv="select * from  acc_group_ledgers where id=".
					$save_data['vat_ledger_id'] ;
					$taxes =$this->projectmodel->get_records_from_sql($sqlinv);		
					foreach ($taxes as $tax)
					{$cst_percentage=$save_data['cst_percentage']=$tax->default_value;  }
					
					$save_data['OTHER_CHARGES_DETAILS']=
					$this->input->post('OTHER_CHARGES_DETAILS');	
					
					$OTHER_CHARFE_AMT=
					$save_data['OTHER_CHARFE_AMT']=
					$this->input->post('OTHER_CHARFE_AMT');	
					
					$save_data['grandtot']=$this->input->post('grandtot')+
					$OTHER_CHARFE_AMT;	
					
									
					$save_data['total_adjust_amt']=0;
						
										
					if($values['id']==0) // insert data....
					{
						$TRANTYPE=$this->input->post('status');
						$this->projectmodel->save_records_model($values['id'],
						$table_name,$save_data);
						$invoiceid=$this->db->insert_id();
						$this->session->set_userdata('alert_msg',
						'One Record Inserted Successfully');
					}	
					
					if($values['id']>0)// update data....
					{
						$this->projectmodel->save_records_model($values['id'],
						$table_name,$save_data);
						$invoiceid=$values['id'];
						$this->session->set_userdata('alert_msg', 
						'One Record Updated Successfully');						
					}
			
				
				//INVOICE DETAIL DECTION
		
				$inv_details['status']=$save_data['status'];
				$inv_details['batchno']=$this->input->post('batchno');
				$inv_details['exp_monyr']=$this->input->post('exp_monyr');	
				$inv_details['mfg_monyr']=$this->input->post('mfg_monyr');
				$inv_details['qnty']=$this->input->post('qnty');
				$inv_details['freeqty']=$this->input->post('freeqty');	
				$inv_details['totqnty']=$inv_details['qnty']+$inv_details['freeqty'];
				$inv_details['rate']=$this->input->post('rate');	
				$inv_details['srate']=$this->input->post('srate');
				$inv_details['ptr']=$this->input->post('ptr');
				$inv_details['mrp']=$this->input->post('mrp');	
				$inv_details['vat_per']=$this->input->post('vat_per');
				/*$inv_details['vatamt']=
				$inv_details['totqnty']*$inv_details['mrp']*
				$this->input->post('vat_per')/100;*/
				
				$inv_details['ed']=$this->input->post('ed');
				
				$totamt=$inv_details['qnty']*$inv_details['rate'];
				$inv_details['subtotal']=round($totamt,2);
					
				$inv_details['invoice_summary_id']=$invoiceid;
				$inv_details['id']=$this->input->post('invoice_detail_id');
				$inv_details['product_id']=$this->input->post('product_id');
				
				
				if($inv_details['product_id']<>'')
				{
				$pieces_ids = explode("-", $inv_details['product_id']);
				$inv_details['pkg']=$pieces_ids[0];
				$inv_details['product_id']=$pieces_ids[1];
				$this->projectmodel->save_records_model($inv_details['id'],
				'invoice_details',$inv_details);
				}	
				
				if($inv_details['totqnty']==0)
				{
				$sql="delete from  invoice_details  
				 where invoice_summary_id=".$invoiceid." and  
				 id=".$inv_details['id'];
				$this->db->query($sql);				
				}
				
				$sqlqty="select * from invoice_details where 
				invoice_summary_id=".$invoiceid;
				$avlqty = $this->projectmodel->get_records_from_sql($sqlqty);
				
				if(count($avlqty)==0)
				{
					$sql="delete from  invoice_summary  
					 where id=".$invoiceid." ";
					$this->db->query($sql);				
				}
				
				
				/*$inv_details['vatamt']=
				$inv_details['totqnty']*$inv_details['mrp']*
				$this->input->post('vat_per')/100;*/
				
				$subtotal=0;
				$totvatamt=0;
				$grandtot=0;
				$tot_discount=0;
				
				$sqlqty="select SUM(subtotal) subtotal,SUM(vatamt) vatamt
				from invoice_details where invoice_summary_id=".$invoiceid;
				$avlqty = $this->projectmodel->get_records_from_sql($sqlqty);
				foreach ($avlqty as $rowq){	
				$subtotal=$rowq->subtotal;
				$tot_discount=$subtotal*$save_data['disc_per']/100;
				$totvatamt=$rowq->vatamt;
				
				}
				$ST=$subtotal-$tot_discount;
				$totvatamt=($ST)*$cst_percentage/100;
				
				$grandtot=$ST+$totvatamt+$OTHER_CHARFE_AMT;
				
				
				$grandtot=sprintf("%01.2f",$grandtot);
				$grandtot1=sprintf("%01.0f",$grandtot);
				$rnd=$grandtot-$grandtot1;
				$rnd=sprintf("%01.2f",$rnd);
				
				if($rnd>=.5)
				{ $grandtot=$grandtot+$rnd;	}
				else
				{ $grandtot=$grandtot-$rnd;	}
								
				$sql="update invoice_summary set 
				 total_amt='$subtotal',tot_discount='$tot_discount',
				 totvatamt='$totvatamt',grandtot='$grandtot',rndoff='$rnd' 
				 where id=".$invoiceid;
				$this->db->query($sql);
				
				$this->accounts_model->ledger_transactions($invoiceid,'PURCHASE');
			    //$this->accounts_model->ledger_transactions_delete($id_header,'SELL');	
			
				redirect('primary_sale_controller/purchase_section/addeditview/'.
				$invoiceid.'/0/');
						
								
		}
	  }		
	}
		
		$layout_data['data_info'] = $this->load->view($viewnamepath,$data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout', $layout_data);
		$this->session->set_userdata('alert_msg', '');	
		
 }
	
/*PURCHASE SECTION END*/

/*PURCHASE RETURN SECTION*/	

public function purchase_rtn_func($displaytype='list',$id=0)	
	 {
	 	
		$layout_data=array();
		$data=array();
		/*CHANGE HERE*/
		$viewname='purchase_rtn';
		$table_name='invoice_summary';
		$redirectlist='primary_sale_controller/purchase_rtn_func/'.
		$this->uri->segment(2).'/'.$displaytype.'/';
		
		$viewnamepath='primary_sale_view/transaction/'.$viewname;
		$data['product_del'] = ADMIN_BASE_URL.
		"primary_sale_controller/purchase_rtn_func/";
			
		/*CHANGE HERE*/
		$data['product_addedit'] = 
		ADMIN_BASE_URL.'primary_sale_controller/purchase_rtn_func/addeditview/'; 
		
		$data['print_view'] = 
		ADMIN_BASE_URL.'primary_sale_controller/purchase_rtn_func/print_view/'; 
		
		$where_array = array('id >' => 0);
		$data['vendorlist'] = $this->projectmodel->get_all_record('tbl_party',$where_array);
					
		$where_array = array('status' => 'PRCHS_RTN');
		$data['projectlist'] = 
		$this->projectmodel->get_all_record('invoice_summary',$where_array);
							
		$where_array = array('id >' => 0,'brandtype '=> 'BRAND');
		$data['productlist'] = $this->projectmodel->get_all_record('brands',$where_array);
		$data['user_name'] = $this->session->userdata('user_name');
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
						
		if($displaytype=='list')
				{
					$data['records']="";
					$data['productid'] ="0";
					//redirect('primary_sale_controller/purchase_section/list/');
				}
		if($displaytype=='addeditview')
				{
					
					$where_array = array('id' => $id);
					$data['records'] = 
					$this->projectmodel->get_all_record($table_name,$where_array);
					$data['productid'] =$id;
				}
				
		if($displaytype=='addedit') //add --update
				{
					$where_array = array('id' => $id);
					$data['records'] = 
					$this->projectmodel->get_all_record($table_name,$where_array);			
					$data['productid'] =$id;
					
					// add edit section start
					if(isset($_POST))
					{	
				
			$values=$this->input->post();
			$data['productid'] =$values['id'];
			$TRANTYPE=$this->input->post('status');
			$invoice_summary_id=$this->input->post('id');
			$invoice_details_id=$this->input->post('invoice_details_id');
					
			if($TRANTYPE<>'SELL')
			{
			$this->form_validation->set_rules('invoice_no','Invoice No','required');}
			$this->form_validation->set_rules('invoice_date','Invoice Date','required');
			$this->form_validation->set_rules('tbl_party_id','Party Name','required');
				
			if($this->form_validation->run()==FALSE )
			{
				$this->session->set_userdata('alert_msg', validation_errors());
				redirect('primary_sale_controller/purchase_rtn_func/'.
						$invoice_summary_id.'/'.$invoice_details_id.'/');
			}
			else  //validation pass
			{
				
					$save_data['id']=$this->input->post('id');
					$save_data['status']=$this->input->post('status');
					
					$save_data['invoice_no']=$this->input->post('invoice_no');
					$save_data['invoice_date']=$this->input->post('invoice_date');
					$save_data['challan_no']=$this->input->post('challan_no');	
					$save_data['challan_date']=$this->input->post('challan_date');	
					$save_data['orderno']=$this->input->post('orderno');	
					$save_data['orderdate']=$this->input->post('orderdate');	
					$save_data['trno']=$this->input->post('trno');	
					$save_data['trdate']=$this->input->post('trdate');						
					$save_data['tbl_party_id']=$this->input->post('tbl_party_id');
					$save_data['vehicle_no']=$this->input->post('vehicle_no');
					$save_data['comment']=$this->input->post('comment');
									
					$save_data['total_amt']=$this->input->post('total_amt');	
					$save_data['disc_per']=$this->input->post('disc_per');	
					$save_data['tot_discount']=$this->input->post('tot_discount');	
					$save_data['totvatamt']=$this->input->post('totvatamt');	
					$save_data['grandtot']=$this->input->post('grandtot');	
					
					$save_data['rtn_invoice_summary_id1']=$this->input->post('cn1');
					$save_data['rtn_invoice_summary_id2']=$this->input->post('cn2');
					$save_data['rtn_invoice_summary_id3']=$this->input->post('cn3');
					$save_data['rtn_invoice_summary_id4']=$this->input->post('cn4');
										
										
										
					if($values['id']==0) // insert data....
					{
						$TRANTYPE=$this->input->post('status');
						$this->projectmodel->save_records_model($values['id'],
						$table_name,$save_data);
						$invoiceid=$this->db->insert_id();
						$this->session->set_userdata('alert_msg',
						'One Record Inserted Successfully');
					}	
					
					if($values['id']>0)// update data....
					{
						$this->projectmodel->save_records_model($values['id'],
						$table_name,$save_data);
						$invoiceid=$values['id'];
						$this->session->set_userdata('alert_msg', 
						'One Record Updated Successfully');						
					}
			
				
				//INVOICE DETAIL DECTION
		
				$inv_details['status']=$save_data['status'];
				$inv_details['batchno']=$this->input->post('batchno');
				$inv_details['exp_monyr']=$this->input->post('exp_monyr');	
				$inv_details['qnty']=$this->input->post('qnty');
				$inv_details['freeqty']=$this->input->post('freeqty');	
				$inv_details['totqnty']=$inv_details['qnty']+$inv_details['freeqty'];
				$inv_details['rate']=$this->input->post('rate');	
				$inv_details['srate']=$this->input->post('srate');
				$inv_details['ptr']=$this->input->post('ptr');
				$inv_details['mrp']=$this->input->post('mrp');	
				$inv_details['vat_per']=$this->input->post('vat_per');
				$inv_details['ed']=$this->input->post('ed');
				
				$totamt=$inv_details['qnty']*$inv_details['rate'];
				$inv_details['subtotal']=round($totamt,2);
					
				$inv_details['invoice_summary_id']=$invoiceid;
				$inv_details['id']=$this->input->post('invoice_detail_id');
				$inv_details['product_id']=$this->input->post('product_id');
				
				$inv_details['vatamt']=
				$inv_details['totqnty']*$inv_details['mrp']*
				$this->input->post('vat_per')/100;
				
				if($inv_details['product_id']>0)
				{
				$pieces_ids = explode("-", $inv_details['product_id']);
				$inv_details['pkg']=$pieces_ids[0];
				$inv_details['product_id']=$pieces_ids[1];
				$this->projectmodel->save_records_model($inv_details['id'],
				'invoice_details',$inv_details);
				}	
				
				
				
				/*$inv_details['vatamt']=
				$inv_details['totqnty']*$inv_details['mrp']*
				$this->input->post('vat_per')/100;*/
				
				$subtotal=0;
				$totvatamt=0;
				$grandtot=0;
				$tot_discount=0;
				
				$sqlqty="select SUM(subtotal) subtotal,SUM(vatamt) vatamt
				from invoice_details where invoice_summary_id=".$invoiceid;
				$avlqty = $this->projectmodel->get_records_from_sql($sqlqty);
				foreach ($avlqty as $rowq){	
				$subtotal=$rowq->subtotal;
				$tot_discount=$subtotal*$save_data['disc_per']/100;
				$totvatamt=$rowq->vatamt;
				$grandtot=$subtotal-$tot_discount+$totvatamt;
				}
				
				$grandtot=sprintf("%01.2f",$grandtot);
				$grandtot1=sprintf("%01.0f",$grandtot);
				$rnd=$grandtot-$grandtot1;
				$rnd=sprintf("%01.2f",$rnd);
				
				if($rnd>=.5)
				{ $grandtot=$grandtot+$rnd;	}
				else
				{ $grandtot=$grandtot-$rnd;	}
								
				$sql="update invoice_summary set 
				 total_amt='$subtotal',tot_discount='$tot_discount',
				 totvatamt='$totvatamt',grandtot='$grandtot',rndoff='$rnd' 
				 where id=".$invoiceid;
				$this->db->query($sql);
				
				
			
				redirect('primary_sale_controller/purchase_rtn_func/addeditview/'.
				$invoice_summary_id.'/0/');
					
	
		}
	  }		
	}
			
		$layout_data['data_info'] = $this->load->view($viewnamepath,$data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout', $layout_data);
		$this->session->set_userdata('alert_msg', '');	
}


/*SELL SECTION*/

public function update_invoice_sum_table($invoiceid=0,$disc_per=0,$BILL_TYPE)	
 {
 
 	    $subtotal=0;
		$totvatamt=0;
		$grandtot=0;
		$tot_discount=0;
	
		$sqlqty="select SUM(subtotal) subtotal,SUM(vatamt) vatamt
		,SUM(totqnty * ed) toted 
		from invoice_details where invoice_summary_id=".$invoiceid;
		$avlqty = $this->projectmodel->get_records_from_sql($sqlqty);
		foreach ($avlqty as $rowq){	
		$subtotal=$rowq->subtotal;
		$tot_discount=$subtotal*$disc_per/100;
		$totvatamt=$rowq->vatamt;
		$toted=$rowq->toted;
		$grandtot=$subtotal-$tot_discount+$totvatamt;
		}
		
		$grandtot=sprintf("%01.2f",$grandtot);
		$grandtot1=sprintf("%01.0f",$grandtot);
		$rnd=$grandtot-$grandtot1;
		$rnd=sprintf("%01.2f",$rnd);
	
		if($rnd>=.5)
		{ $grandtot=$grandtot+$rnd;	}
		else
		{ $grandtot=$grandtot-$rnd;	}
			
		if($BILL_TYPE=='CST_BILL')
		{$totvatamt=($subtotal-$tot_discount)*2/100;
		$grandtot=$subtotal-$tot_discount+$totvatamt;
		}	
		
		if($BILL_TYPE=='BENGAL_CHEM_BILL')
		{ $totvatamt=($subtotal+$toted)*5/100;
		$grandtot=$subtotal+$toted+$totvatamt;
		}	
			
						
		 $sql="update invoice_summary set 
		 total_amt='$subtotal',tot_discount='$tot_discount',
		 totvatamt='$totvatamt',grandtot='$grandtot',rndoff='$rnd' 
		 where id=".$invoiceid;
		 $this->db->query($sql);

 }


private function general_update($id_header=0)	
{

	$sqlinv="select * from  invoice_summary where status='SELL' ";
	$rows =$this->projectmodel->get_records_from_sql($sqlinv);	
	foreach ($rows as $row)
	{ 	
		$id_header=$row->id;
		$save_hdr['cst_percentage']=$row->cst_percentage;
							
		if($save_hdr['cst_percentage']>0)
		{
		$save_hdr['BILL_TYPE']="CST_BILL";
		$inv_details['vat_per']=$save_hdr['cst_percentage'];
		}
		else
		{$save_hdr['BILL_TYPE']="VATBILL";}
											
		$save_hdr['hq_id']=$row->hq_id;
						
		$save_hdr['emp_id']=0;			
		$sql="select a.id 
		from tbl_employee_mstr a,tbl_hierarchy_org b
		where a.id=b.employee_id and  b.id=".$save_hdr['hq_id']." ";
		$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
		foreach ($rowrecord as $row1)
		{$save_hdr['emp_id']=$row1->id;}
		
		$this->projectmodel->save_records_model($id_header,'invoice_summary',$save_hdr);
		
			//DETAILS ...
			$sqlinv_dtl="select * from  invoice_details 
			where invoice_summary_id=".$id_header;
			$rows_dtl =$this->projectmodel->get_records_from_sql($sqlinv_dtl);	
			foreach ($rows_dtl as $row_dtl)
			{
				if($save_hdr['cst_percentage']>0)
				{$inv_details['vat_per']=$save_hdr['cst_percentage'];}
				else
				{$inv_details['vat_per']=$row_dtl->vat_per;}
				
				$inv_details['vat_ledger_id']=0;
				
				if($save_hdr['BILL_TYPE']=="VATBILL")
				{$taxtype="VATGROUP";}
				
				if($save_hdr['BILL_TYPE']=="CST_BILL")
				{$taxtype="CSTGROUP";}
				
				$parent_id=-1;
				$sql="select * from  acc_group_ledgers where VOUCHER_TYPE='".$taxtype."' " ;
				$products = $this->projectmodel->get_records_from_sql($sql);		
				foreach ($products as $product)
				{$parent_id=$parent_id.','.$product->id;}
				
				$sqlinv="select * from  acc_group_ledgers 
				where parent_id in (".$parent_id.") and default_value=".
				$inv_details['vat_per'] ;
				$taxes =$this->projectmodel->get_records_from_sql($sqlinv);	
				foreach ($taxes as $tax)
				{$inv_details['vat_ledger_id']=$tax->id;}
				
				$this->projectmodel->save_records_model($row_dtl->id,
				'invoice_details',$inv_details);
			}
		
		$this->transaction_update($id_header,'sale');	
	}
	

}

public function trip_expense_sms($invoiceid,$mobno,$sms_type='SELL')
{
	$authKey='151466AMTRz3XIjhBg590d7cac';
	$senderId='MediCM';
	
	if($sms_type=='SELL')
	{
		$retail_name='';
		$sql="select * from invoice_summary where id=".$invoiceid." ";
		$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
		foreach ($rowrecord as $row1)
		{ 
			$invoice_no=$row1->invoice_no;
			$invoice_date=$row1->invoice_date;
			$grandtot=$row1->grandtot;
			$due_payment_date=$row1->due_payment_date;
			$tbl_party_id=$row1->tbl_party_id;
			$lrdate=$row1->lrdate;
			
			$previous_due=$this->projectmodel->stockist_wise_due($tbl_party_id);
			$hq_id=$row1->hq_id;
			
			$no_of_case=$row1->no_of_case;
			$transporter=$row1->transporter;
		}
		
		$sql="select * from stockist where id=".$tbl_party_id." ";
		$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
		foreach ($rowrecord as $row1)
		{
		$retail_name=$row1->retail_name;
		$mobno=$row1->retail_contact;
		}
		
		/*$sms_msg='Invoice Has been generated for '.$retail_name.' 
		 No :'.$invoice_no.' |Dated:'.$invoice_date.
		'|Total(Rs) :'.$grandtot.' |Pay Due Date:'.$due_payment_date.' - 
		Regards Medichem india Pvt.Ltd';*/
		
		$sms_msg='To '.$retail_name.', on 
		'.$lrdate.' despatched your order goods of '.$no_of_case.
		' through '.$transporter.'. MEDICHEM.';
		
		
		if($mobno<>'')
		{$this->general_library->send_sms($mobno,$sms_msg,$authKey,$senderId);}
		
		
		$sql="select * from tbl_hierarchy_org where id=".$hq_id." ";
		$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
		foreach ($rowrecord as $row1)
		{
		$hq_emp_id=$row1->employee_id;
		$under_tbl_hierarchy_org=$row1->under_tbl_hierarchy_org;
		}
		
		$sql="select * from tbl_hierarchy_org where id=".$under_tbl_hierarchy_org." ";
		$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
		foreach ($rowrecord as $row1)
		{$asm_emp_id=$row1->employee_id;}
		
		
		$sql="select * from tbl_employee_mstr where id=".$hq_emp_id." ";
		$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
		foreach ($rowrecord as $row1)
		{$mobno=$row1->contactno;}
		
		if($mobno<>'')
		{$this->general_library->send_sms($mobno,$sms_msg,$authKey,$senderId);}
		
		$sql="select * from tbl_employee_mstr where id=".$asm_emp_id." ";
		$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
		foreach ($rowrecord as $row1)
		{$mobno=$row1->contactno;}
		
		if($mobno<>'')
		{$this->general_library->send_sms($mobno,$sms_msg,$authKey,$senderId);}
		
	}
	
}

public function invoice_mail($id_header,$mail_type='GSTBILL')
{
		
			 $sqlemp="select * from company_details where id=1";
			 $rowrecordemp = $this->projectmodel->get_records_from_sql($sqlemp);	
			 foreach ($rowrecordemp as $rowemp)
			 { 
				 $COMPNAME=$rowemp->NAME;
				 $MOB_NOS=$rowemp->MOB_NOS;
				 $sent_to=$rowemp->EMAIL_IDS;
				 $company_mailid=$rowemp->company_mailid;
				 $authKey=$rowemp->SMS_KEY;
				 $senderId=$rowemp->SMS_SENDERID;
			 }	
			 
			//tran header
			$APPROVE_STATUS='NOT_APPROVED';
			$sqlinv="select * from  invoice_summary where id=".$id_header;
			$rows =$this->projectmodel->get_records_from_sql($sqlinv);	
			foreach ($rows as $row)
			{
			$tbl_party_id=$row->tbl_party_id;
			$APPROVE_STATUS=$row->APPROVE_STATUS;
			$invno=$row->invoice_no;
			$invoice_date=$row->invoice_date;
			}	
			
		   if($mail_type=='GSTBILL' && $APPROVE_STATUS=='APPROVED')
		   {		
				$data_print['table_name']='invoice_summary';
				$data_print['table_id']=$id_header;
				$company_mailid=$company_mailid;
				//PDF SECTION	
				$report_path='primary_sale_view/invoice_other_print_diamond/';
				$this->pdf->load_view($report_path.'invoice_print_sell', $data_print);
				$this->pdf->render();
				//$this->pdf->stream("pdf/invoice.pdf");				
				write_file("pdf/invoice.pdf", $this->pdf->output());				
				
				//MAIL SECTION		
				$this->email->initialize(array('mailtype' => 'html')); 
				$this->email->from($company_mailid,$COMPNAME);
				$this->email->to($sent_to); 
				$this->email->cc('ashokedas@gmail.com'); 
				//$this->email->bcc('them@their-example.com');
				$this->email->subject('Invoice From United Lab :#'.
				$invno.' /'.$invoice_date);
				$email =$this->load->view($report_path.'invoice_print_sell',
				$data_print, TRUE);
				$this->email->message($email);	
				$this->email->attach('pdf/invoice.pdf');    
				$this->email->send();
			}
					
}



public function send_sms_custom()	
{
	$view_path_name='projectview/send_sms';	
	$authKey='151466AMTRz3XIjhBg590d7cac';
	$senderId='MediCM';
	$data['mobile_nos']='';;
	$data['comment']='';
	$data['SMS_BALANCE']='';
	
if(isset($_POST))
	{
		$mobile_nos=$data['mobile_nos']=$this->input->post('mobile_nos');;
		$sms_msg=$data['comment']=$this->input->post('comment');		
		if($mobile_nos<>'')
		{$this->general_library->send_sms($mobile_nos,$sms_msg,$authKey,$senderId);}
	}
		//https://control.msg91.com/api/balance.php?authkey=151466AMTRz3XIjhBg590d7cac&type=4
		
		/*  $ch = curl_init();        
        curl_setopt($ch, CURLOPT_URL, "https://control.msg91.com/api/balance.php?authkey=151466AMTRz3XIjhBg590d7cac&type=4");       
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);        
        $data['SMS_BALANCE']= = curl_exec($ch);      
        curl_close($ch);    */ 
		
		
	$this->page_layout_display($view_path_name,$data);

}



// SELL ENTRY
public function sell_section($displaytype='list',$id_header=0,
$id_detail=0,$approve_status='APPROVED')	
{
	/*
	$sql="select * from invoice_summary where status='SELL'";			
	$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
	foreach ($rowrecord as $row1)
	{
	$id_header=$row1->id;
	$status=$row1->status;
	$this->accounts_model->ledger_transactions($id_header,$status);
	}
	*/
		
		
		//GENERAL SETUP
		$data['tran_link'] = ADMIN_BASE_URL.'primary_sale_controller/sell_section/'; 
		$view_path_name='primary_sale_view/transaction/invoice_view_sell';		
		
			$where_array = array('parent_id ' => 0);
			$data['tax_list'] = 
			$this->projectmodel->get_all_record('acc_group_ledgers',$where_array);
					
						
			$where_array = array('id >' => 0,'brandtype '=> 'BRAND');
			$data['productlist'] = 
			$this->projectmodel->get_all_record('brands',$where_array);
		
			$where_array = array('id' => 0);
			$data['ac_tran_list'] = 
			$this->projectmodel->get_all_record('invoice_details',$where_array);
			
			$where_array = array('id >' => 0);
			$data['vendorlist'] = 
			$this->projectmodel->get_all_record('stockist',$where_array);
			
			//DISPLAY LIST AT BUTTON
			
			$dat1=$this->general_library->get_date(date('Y-m-d'),0,-4,0);
		    $dat=date('Y-m-d');
			
			$sqlinv="select * from  invoice_summary where status='SELL'	 and
			invoice_date between '$dat1' and '$dat' order by  invoice_date desc,
			id desc";		
			$data['projectlist'] =$this->projectmodel->get_records_from_sql($sqlinv);
			
			
			if($displaytype=='approved_link')
			{
				$sql="update invoice_summary set APPROVE_STATUS='".$approve_status."' 
				 where id=".$id_header;
				$this->db->query($sql);	
				
				$this->invoice_mail($id_header,'GSTBILL');
									
				redirect('primary_sale_controller/sell_section/addeditview/'.
				$id_header.'/0/');
			}
			
			
			if($displaytype=="mail_sms")
			{
				
				//tran header
				$sqlinv="select * from  invoice_summary where id=".$id_header;
				$rows =$this->projectmodel->get_records_from_sql($sqlinv);	
				foreach ($rows as $row)
				{
				$tbl_party_id=$row->tbl_party_id;
				}
						
				$sql="select * from stockist where id=".$tbl_party_id." ";
				$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
				foreach ($rowrecord as $row1)
				 {
				 $retail_email=$row1->retail_email;
				 $retail_contact=$row1->retail_contact;
				 $retail_name=$row1->retail_name;
				 }
				
				$data_print['table_name']='invoice_summary';
				$data_print['table_id']=$id_header;
				$COMPNAME="Medichem India Pvt.Ltd";
				$company_mailid="info@medichem.co.in";
				//PDF SECTION	
				$report_path='primary_sale_view/invoice_other_print_diamond/';
				$this->pdf->load_view($report_path.'invoice_print_sell', $data_print);
				$this->pdf->render();
				//$this->pdf->stream("pdf/invoice.pdf");				
				write_file("pdf/invoice.pdf", $this->pdf->output());				
				
				//$retail_email="ashokedas@gmail.com";
				//MAIL SECTION		
				$this->email->initialize(array('mailtype' => 'html')); 
				$this->email->from($company_mailid,$COMPNAME);
				$this->email->to($retail_email); 
				$this->email->cc('ashokedas@gmail.com'); 
				//$this->email->bcc('them@their-example.com');
				$this->email->subject('Invoice From Medichem :#'.
				$invno.' /'.$invoice_date);
				$email =$this->load->view($report_path.'invoice_print_sell',
				$data_print, TRUE);
				$this->email->message($email);	
				$this->email->attach('pdf/invoice.pdf');    
				$this->email->send();
				
				
				//SMS SECTION
				$mobno='8054000029';
				$this->trip_expense_sms($id_header,$mobno,'SELL');
				
				$this->session->set_userdata('alert_msg',
					'Mail Sent to '.$retail_name);
				
			redirect('primary_sale_controller/sell_section/addeditview/'.
					$id_header.'/0/');
		}
			
		
		//GENERAL SETUP END
		
		if($displaytype=="list")
		{
			//HEADER TABLE
			$data['invoice_summary_id']=0;
			
			$data['invoice_no']=$data['challan_no']=$data['orderno']=
			$data['trno']=$data['lrno']=$data['destination']=$data['transporter']=
			$data['no_of_case']=$data['comment']='';
			$data['invoice_date']=$data['challan_date']=$data['orderdate']=
			$data['trdate']=$data['lrdate']=date('Y-m-d');
			$data['product_type']='OLDDIV';
			$data['BILL_TYPE']=$data['tbl_party_id']='';
			$data['hq_id']=0;
			$data['due_payment_date']=$data['pending_credit_limit']='';
			$data['total_amt']=$data['disc_per']='';
			$data['cash_disc']=$data['tot_discount']=$data['tot_cash_discount']='';
			$data['bank_charge_chqno']=$data['bank_charge_chqdate']='';
			$data['bank_charge_chqamt']=$data['bank_charge_fine']='';
			$data['interest_charge']=$data['freight_charge']='';
			$data['rnd']=$data['grandtot']='';
			$data['totvatamt']=0;
			
			//DETAIL TABLE
			$data['product_id']=0;
			$data['qnty']=$data['freeqty']=$data['replace_qnty']='';
			$data['batchno']=$data['exp_monyr']=$data['mfg_monyr']=$data['rate']='';
			$data['mrp']=$data['ptr']=$data['srate']=$data['vat_per']=$data['ed']='';
			$data['disc_per']=$data['subtotal']='';
			
			//GENERAL UPDATION SECTION
			//$this->general_update();				
			//GENERAL UPDATION SECTION end 
			
		}
		
		
		if($displaytype=='addeditview')
		{
			$data['invoice_summary_id']=0;
			$data['invoice_no']=$data['challan_no']=$data['orderno']=
			$data['trno']=$data['lrno']=$data['destination']=$data['transporter']=
			$data['no_of_case']=$data['comment']='';
			$data['invoice_date']=$data['challan_date']=$data['orderdate']=
			$data['trdate']=$data['lrdate']=date('Y-m-d');			
			$data['product_type']='OLDDIV';
				
				//tran header
				$sqlinv="select * from  invoice_summary where id=".$id_header;
				$rows =$this->projectmodel->get_records_from_sql($sqlinv);	
				foreach ($rows as $row)
				{ 	
					$data['invoice_summary_id']=$id_header;
					$data['invoice_no']=$row->invoice_no;
					$data['challan_no']=$row->challan_no;
					$data['orderno']=$row->orderno;
					$data['trno']=$row->trno;
					$data['lrno']=$row->lrno;
					$data['destination']=$row->destination;
					$data['transporter']=$row->transporter;
					$data['no_of_case']=$row->no_of_case;
					$data['comment']=$row->comment;
					$data['invoice_date']=$row->invoice_date;
					$data['challan_date']=$row->challan_date;
					$data['orderdate']=$row->orderdate;
					$data['trdate']=$row->trdate;
					$data['lrdate']=$row->lrdate;		
					$data['product_type']=$row->product_type;	
					$data['tbl_party_id']=$row->tbl_party_id;	
					$data['totvatamt']=$row->totvatamt;	
					
					$data['due_payment_date']=$row->due_payment_date;
					$data['pending_credit_limit']=$row->pending_credit_limit;
					$data['hq_id']=$row->hq_id;
					$data['total_amt']=$row->total_amt;
					$data['disc_per']=$row->disc_per;
					$data['cash_disc']=$row->cash_disc;
					$data['tot_discount']=$row->tot_discount;
					$data['tot_cash_discount']=$row->tot_cash_discount;
					
					$data['bank_charge_chqno']=$row->bank_charge_chqno;
					$data['bank_charge_chqdate']=$row->bank_charge_chqdate;
					$data['bank_charge_chqamt']=$row->bank_charge_chqamt;
					$data['bank_charge_fine']=$row->bank_charge_fine;
					$data['interest_charge']=$row->interest_charge;
					$data['freight_charge']=$row->freight_charge;
					$data['BILL_TYPE']=$row->BILL_TYPE;
					
					$data['rnd']=$row->rndoff;
					$data['grandtot']=$row->grandtot;
									
				}
				
				//tran details
				$data['product_id']=0;
				$data['qnty']=$data['freeqty']=$data['replace_qnty']='';
				$data['batchno']=$data['exp_monyr']=$data['mfg_monyr']=$data['rate']='';
				$data['mrp']=$data['ptr']=$data['srate']=$data['vat_per']=$data['ed']='';
				$data['disc_per']=$data['subtotal']='';
				
				$where_array = array('invoice_summary_id' => $id_header);
				$data['ac_tran_list'] = 
				$this->projectmodel->get_all_record('invoice_details',$where_array);
								
				$sqlinv="select * from  invoice_details where id=".$id_detail;
				$rows =$this->projectmodel->get_records_from_sql($sqlinv);	
				foreach ($rows as $row)
				{ 	
					$data['product_id']=$row->product_id;
					$data['batchno']=$row->batchno;
					$data['qnty']=$row->qnty;
					$data['freeqty']=$row->freeqty;
					$data['exp_monyr']=$row->exp_monyr;
					$data['mfg_monyr']=$row->mfg_monyr;
					$data['rate']=$row->rate;
					$data['mrp']=$row->mrp;
					$data['ptr']=$row->ptr;
					$data['srate']=$row->srate;
					$data['vat_per']=$row->vat_per;
					$data['ed']=$row->ed;
					$data['subtotal']=$row->subtotal;
					$data['disc_per']=$row->disc_per;
				}
				
			
			
		}
		
		if(isset($_POST) and $displaytype=='save')
		{
			
			//HEADER ENTRY part
			
			$save_hdr['invoice_no']=$this->input->post('invoice_no');;
			$save_hdr['challan_no']=$this->input->post('challan_no');
			$save_hdr['orderno']=$this->input->post('orderno');
			$save_hdr['trno']=$this->input->post('trno');
			$save_hdr['lrno']=$this->input->post('lrno');
			$save_hdr['destination']=$this->input->post('destination');
			$save_hdr['no_of_case']=$this->input->post('no_of_case');
			$save_hdr['comment']=$this->input->post('comment');
			$closingdate=$save_hdr['invoice_date']=$this->input->post('invoice_date');
			$save_hdr['challan_date']=$this->input->post('challan_date');
			$save_hdr['orderdate']=$this->input->post('orderdate');
			$save_hdr['trdate']=$this->input->post('trdate');
			$save_hdr['lrdate']=$this->input->post('lrdate');	
			$save_hdr['product_type']=$this->input->post('product_type');
			$save_hdr['tbl_party_id']=$this->input->post('tbl_party_id');	
			$save_hdr['bank_charge_chqno']=$this->input->post('bank_charge_chqno');
			$save_hdr['bank_charge_chqdate']=
			$this->input->post('bank_charge_chqdate');
			$save_hdr['bank_charge_chqamt']=
			$this->input->post('bank_charge_chqamt');
			$save_hdr['bank_charge_fine']=$this->input->post('bank_charge_fine');
			$save_hdr['interest_charge']=$this->input->post('interest_charge');
			$save_hdr['freight_charge']=$this->input->post('freight_charge');
			$save_hdr['status']=$this->input->post('status');
			$save_hdr['product_type']=$this->input->post('product_type');	
			$save_hdr['transporter']=$this->input->post('transporter');	
			
			//checking part
			if($save_hdr['tbl_party_id']=="" or $save_hdr['invoice_no']=="" or
			$save_hdr['invoice_date']=="" )
				{
					$this->session->set_userdata('alert_msg',
					'Please Enter Party , Invoice No and Invoice Date');
					redirect('primary_sale_controller/sell_section/list/0/0/');
				}
				
						
			
			if($this->input->post('hq_id')<>'')
			{
				$save_hdr['hq_id']=$this->input->post('hq_id');				
				$save_hdr['emp_id']=0;			
				$sql="select a.id 
				from tbl_employee_mstr a,tbl_hierarchy_org b
				where a.id=b.employee_id and  b.id=".$save_hdr['hq_id']." ";
				$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
				foreach ($rowrecord as $row1)
				{$save_hdr['emp_id']=$row1->id;}
			}	
								
			//credit date calculation
			$CREDIT_LIMIT=0;
			$CREDIT_DAYS=0;
			$TRANSPORTER='';
			$BILL_TYPE='VATBILL';
			$sql="select * from stockist where id=".$save_hdr['tbl_party_id']." ";
			$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
			foreach ($rowrecord as $row1)
			{
				$CREDIT_LIMIT=$row1->CREDIT_LIMIT;
				$CREDIT_DAYS=$row1->CREDIT_DAYS;
				$BILL_TYPE=$row1->BILL_TYPE;
				$TRANSPORTER=$row1->TRANSPORTER;
			}
			
			if ( $this->session->userdata('COMP_ID')=='MEDICHEM') 
			{$save_hdr['transporter']=$TRANSPORTER; }
			
			$save_hdr['due_payment_date']=
			$this->general_library->get_date($save_hdr['lrdate'],
			$CREDIT_DAYS,0,0);	
			$save_hdr['pending_credit_limit']='';
			$save_hdr['BILL_TYPE']=$BILL_TYPE;
			$save_hdr['disc_per']=$this->input->post('disc_per');
			$save_hdr['cash_disc']=$this->input->post('cash_disc');
				
			if($id_header==0) 
			{					
				$this->projectmodel->save_records_model($id_header,
				'invoice_summary',$save_hdr);
				$id_header=$this->db->insert_id();
				$this->session->set_userdata('alert_msg',
				'One Record Inserted Successfully');
			}	
			
			if($id_header>0)// update data....
			{
				$this->projectmodel->save_records_model($id_header,
				'invoice_summary',$save_hdr);
				$this->session->set_userdata('alert_msg', 
				'One Record Updated Successfully');						
			}
				
			//HEADER ENTRY part		
				
				
			//tran details
			$inv_details['invoice_summary_id']=$id_header;
			$inv_details['id']=$id_detail;
			$product_id=$inv_details['product_id']=$this->input->post('product_id');
			
			$inv_details['mrp_incl_tax']=0;
			
			if($inv_details['product_id']>0)
			{
				$sql="select * from brands where id=".
				$inv_details['product_id']." ";
				
				$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
				foreach ($rowrecord as $row1)
				{$inv_details['mrp_incl_tax']=$row1->mrp_incl_tax;}
				
				$inv_details['status']=$this->input->post('status');
				$batchno=$inv_details['batchno']=$this->input->post('batchno');
				$inv_details['exp_monyr']=$this->input->post('exp_monyr');	
				$inv_details['mfg_monyr']=$this->input->post('mfg_monyr');	
				$inv_details['qnty']=$this->input->post('qnty');
				$inv_details['freeqty']=$this->input->post('freeqty');	
				$inv_details['replace_qnty']=$this->input->post('replace_qnty');	
				
				$totqty=$inv_details['qnty']+
				$inv_details['freeqty']+$inv_details['replace_qnty'];
				
					$open_ptrn_qnty=$open_sellrtnexp_qnty=
					$open_sellrtn_qnty=$open_sell_qnty=$open_purchase_qnty
					=$openqty=$closingqty=$sellrtnexp_qnty=0;					
					$fromdate='2012-01-01';		
					$pkg='.';	
					//period transaction
					$sampleqty=0;
					$sqlsample="select sum(qnty) qnty from sample_tran_details where
					invoice_summary_id in (select id from sample_tran_summary where 
					status='SAMPLE_RCV' and invoice_date between '$fromdate' and 
					'$closingdate') and product_id=".$product_id." 
					and batchno='$batchno' " ;
					$sampleqty = 
					$this->projectmodel->get_records_from_sql($sqlsample);
					foreach ($sampleqty as $sampleqty1)
					{$sampleqty=$sampleqty1->qnty;}
					
					$ptrn_qnty=$sellrtnexp_qnty=
					$sellrtn_qnty=$sell_qnty=$purchase_qnty=0;
										
					$purchase_qnty = $this->projectmodel->batchwise_stock($fromdate,
					$closingdate,$product_id,$batchno,$pkg,'PURCHASE');
					
					$sell_qnty = $this->projectmodel->batchwise_stock($fromdate,
					$closingdate,$product_id,$batchno,$pkg,'SELL');
					
					$sellrtn_qnty = $this->projectmodel->batchwise_stock($fromdate,
					$closingdate,$product_id,$batchno,$pkg,'SELL_RTN');
					
					$ptrn_qnty = $this->projectmodel->batchwise_stock($fromdate,
					$closingdate,$product_id,$batchno,$pkg,'PRCHS_RTN');
														
					$totavailableqty=$closingqty+$purchase_qnty-$sell_qnty-
					$ptrn_qnty+$sellrtn_qnty+$sellrtnexp_qnty-$sampleqty;
				
				
				if($totqty>$totavailableqty)
				{
					$this->session->set_userdata('alert_msg',
					'Total Entered Qnty Greater than Available qty');
					redirect('primary_sale_controller/sell_section/addeditview/'.
					$id_header.'/0/');
				}
				
				
				if($inv_details['batchno']=="" )
				{
					$this->session->set_userdata('alert_msg',
					'Please Enter batch and Qnty');
					
					redirect('primary_sale_controller/sell_section/addeditview/'.
					$id_header.'/0/');
				}
				
				
				
				$inv_details['totqnty']=$inv_details['qnty']+
				$inv_details['freeqty']+$inv_details['replace_qnty'];
				$inv_details['srate']=$inv_details['rate']=
				$this->input->post('srate');	
				$inv_details['ptr']=$this->input->post('ptr');
				$inv_details['mrp']=$this->input->post('mrp');
				$inv_details['ed']=$this->input->post('ed');
				$totamt=$inv_details['qnty']*$inv_details['rate'];
				$inv_details['subtotal']=round($totamt,2);	
				$inv_details['vat_ledger_id']=$this->input->post('vat_ledger_id');
				$inv_details['disc_per']=$this->input->post('disc_per');
				
				$tax_per=$inv_details['vat_per']=0;
				$sql="select default_value from acc_group_ledgers where 
				id=".$inv_details['vat_ledger_id']." ";			
				$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
				foreach ($rowrecord as $row1)
				{$tax_per=$inv_details['vat_per']=$row1->default_value;}
				
				$inv_details['vatamt']=0;
				
						
				if($id_detail==0) 
				{					
					$this->projectmodel->save_records_model('',
					'invoice_details',$inv_details);
					//$id_detail=$this->db->insert_id();
					$this->session->set_userdata('alert_msg',
					'One Record Inserted Successfully');
				}	
				
				if($id_detail>0)// update data....
				{
					$this->projectmodel->save_records_model($id_detail,
					'invoice_details',$inv_details);
					$this->session->set_userdata('alert_msg', 
					'One Record Updated Successfully');						
				}
			}
			
			$this->transaction_update($id_header,'sale');	
			
			if ( $this->session->userdata('COMP_ID')=='MEDICHEM') 
			{$this->accounts_model->ledger_transactions($id_header,'SELL');}
			
		redirect('primary_sale_controller/sell_section/addeditview/'.$id_header.'/0/');
		
		}		
		
		
		
		if($displaytype=='delete')
		{
		$sql="delete from invoice_details  where id=".$id_detail;
		$this->db->query($sql);
		$this->transaction_update($id_header,'sale');		
		$this->accounts_model->ledger_transactions_delete($id_header,'SELL');
		redirect('primary_sale_controller/sell_section/addeditview/'.$id_header.'/0/');
		}
		
		
		//DELETE ALL 	SC/C/1195/16-17
		if($displaytype=='deleteAll')
		{
			$sql="delete from  invoice_details  where invoice_summary_id=".$id_header;
			$this->db->query($sql);	
			$this->session->set_userdata('alert_msg','Invoice has been deleted!');
					
			$sql="delete from  invoice_summary  where id=".$id_header;
			$this->db->query($sql);	
		    $this->accounts_model->ledger_transactions_delete($id_header,'SELL');
			redirect('primary_sale_controller/sell_section/list/0/0/');
		}
		
		$this->page_layout_display($view_path_name,$data);
}





private function transaction_update($id_header=0,$trantype='')	
{
	
	if($id_header>0 && $trantype=='sale')
	{
		$bank_charge_fine=0;
		$freight_charge=0;
		$interest_charge=0;
		
		$sql="select * from invoice_summary where id=".$id_header;			
		$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
		foreach ($rowrecord as $row_hdr)
		{
			$BILL_TYPE=$row_hdr->BILL_TYPE;
			$disc_per=$row_hdr->disc_per;
			$bank_charge_fine=$row_hdr->bank_charge_fine;
			$freight_charge=$row_hdr->freight_charge;
			$interest_charge=$row_hdr->interest_charge;
			$cash_disc=$row_hdr->cash_disc;
		}
		
		$save_hdr['total_amt']=0;
		$save_hdr['tot_discount']=0;
		$save_hdr['totvatamt']=0;

					
		$sql="select * from invoice_details where invoice_summary_id=".$id_header;			
		$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
		foreach ($rowrecord as $row1)
		{
			
			// FOR UNITED LAB SECTION 
			if ( $this->session->userdata('COMP_ID')=='UNITEDLAB') 
			{
				$inv_details['ptr']=$row1->ptr;
				$inv_details['srate']=$row1->srate;
				$inv_details['rate']=
				$row1->srate-($row1->srate*$row1->disc_per/100);				
				$inv_details['subtotal']=$inv_details['rate']*$row1->qnty;
				$inv_details['disc_amt']=0;	
				//$taxable_qnty=$row1->qnty+$row1->freeqty;
				$taxable_qnty=$row1->qnty;
				$inv_details['taxable_amt']=$taxable_qnty*$inv_details['rate'];
			}
			if ( $this->session->userdata('COMP_ID')=='MEDICHEM') 
			{

					$inv_details['ptr']=$row1->ptr;					
					$inv_details['rate']=$inv_details['srate']=
					$row1->ptr-($row1->ptr*$row1->disc_per/100);					
					$inv_details['subtotal']=$inv_details['srate']*$row1->qnty;					
					$inv_details['disc_amt']=0;
					//$row1->ptr*$row1->qnty*$row1->disc_per/100;	
										
					$taxable_qnty=$row1->qnty;
					$inv_details['taxable_amt']=$taxable_qnty*$inv_details['srate'];	
				
					
			}
			if ( $this->session->userdata('COMP_ID')=='DIAMONDDRUGS') 
			{
				$inv_details['ptr']=$row1->ptr;
				$taxable_qnty=$row1->qnty;
				//$taxable_qnty=$row1->qnty+$row1->freeqty;
				//$ptr_percentage=$row1->freeqty/$taxable_qnty;
				
				//$inv_details['rate']=$row1->ptr*(1-$ptr_percentage);
				
				$inv_details['srate']=
				$inv_details['ptr']-($inv_details['ptr']*$row1->disc_per/100);
				
				$inv_details['cash_disc']=$cash_disc;
				$inv_details['subtotal']=$inv_details['srate']*$row1->qnty;
				//qnty discount				
				$inv_details['disc_amt']=0;
				//$inv_details['srate']*$row1->qnty*$row1->disc_per/100;	
				
				//TAXABLE PORTION
				//AFTER CASH DISCOUNT
				$inv_details['taxable_amt']=
				$taxable_qnty*$inv_details['srate']*(1-$inv_details['cash_disc']/100);	
			}

			//GST PORTION
			if($BILL_TYPE=='VATBILL')
			{
				$inv_details['cgst_rate']=$row1->vat_per/2;
				$inv_details['sgst_rate']=$row1->vat_per/2;
				$inv_details['igst_rate']=0;
			}
			else
			{
				$inv_details['cgst_rate']=0;
				$inv_details['sgst_rate']=0;
				$inv_details['igst_rate']=$row1->vat_per;
			}	
		
			$inv_details['cgst_amt']=
			$inv_details['taxable_amt']*$inv_details['cgst_rate']/100;
			$inv_details['sgst_amt']=
			$inv_details['taxable_amt']*$inv_details['sgst_rate']/100;
			$inv_details['igst_amt']=
			$inv_details['taxable_amt']*$inv_details['igst_rate']/100;
			
			//TOTAL TAX AMOUNT
			$inv_details['vatamt']=$inv_details['cgst_amt']+
			$inv_details['sgst_amt']+$inv_details['igst_amt'];
								
			$this->projectmodel->save_records_model($row1->id,
			'invoice_details',$inv_details);
		
			
			//UPDATE SUMMARY TABLE										
			$save_hdr['total_amt']=$save_hdr['total_amt']+$inv_details['subtotal'];
			$save_hdr['tot_discount']=$save_hdr['tot_discount']+$inv_details['disc_amt'];
			$save_hdr['tot_cash_discount']= 
			($save_hdr['total_amt']-$save_hdr['tot_discount'])*$cash_disc/100;
			
			$save_hdr['totvatamt']=$save_hdr['totvatamt']+$inv_details['vatamt'];		

			$grandtot=$save_hdr['total_amt']-$save_hdr['tot_discount']-
			$save_hdr['tot_cash_discount']+$save_hdr['totvatamt']+
			$bank_charge_fine-$freight_charge+$interest_charge;
			
			$grandtot=sprintf("%01.2f",$grandtot);
			$grandtot1=sprintf("%01.0f",$grandtot);
			$rndoff=$grandtot-$grandtot1;
			$save_hdr['rndoff']=sprintf("%01.2f",$rndoff);	
			$save_hdr['grandtot']=$grandtot-$rndoff;
			
			$this->projectmodel->save_records_model($id_header,
			'invoice_summary',$save_hdr);	
			
				
		}
		
	}



		if($id_header>0 && $trantype=='SAMPLE_ISU')
		{
				$save_hdr['total_amt']=0;
				$sql="select * from sample_tran_details where 
				invoice_summary_id=".$id_header;			
				$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
				foreach ($rowrecord as $row1)
				{
					$save_hdr['total_amt']=
					$save_hdr['total_amt']+$row1->subtotal;
					$grandtot=$save_hdr['total_amt'];
					
					$grandtot=sprintf("%01.2f",$grandtot);
					$grandtot1=sprintf("%01.0f",$grandtot);
					$rndoff=$grandtot-$grandtot1;
					$save_hdr['rndoff']=sprintf("%01.2f",$rndoff);	
					$save_hdr['grandtot']=$grandtot-$rndoff;
				}
			
				$this->projectmodel->save_records_model($id_header,
				'sample_tran_summary',$save_hdr);	
		
		}
		
		if($id_header>0 && $trantype=='SAMPLE_RCV')
		{
				$save_hdr['total_amt']=0;
				$sql="select * from sample_tran_details where 
				invoice_summary_id=".$id_header;			
				$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
				foreach ($rowrecord as $row1)
				{
					$save_hdr['total_amt']=
					$save_hdr['total_amt']+$row1->subtotal;
					$grandtot=$save_hdr['total_amt'];
					
					$grandtot=sprintf("%01.2f",$grandtot);
					$grandtot1=sprintf("%01.0f",$grandtot);
					$rndoff=$grandtot-$grandtot1;
					$save_hdr['rndoff']=sprintf("%01.2f",$rndoff);	
					$save_hdr['grandtot']=$grandtot-$rndoff;
				}
			
				$this->projectmodel->save_records_model($id_header,
				'sample_tran_summary',$save_hdr);	
		
		}


}
		

	
/*SAMPLE  SECTION*/

// SELL ENTRY
public function  sample_rcv($displaytype='list',$id_header=0,
$id_detail=0,$approve_status='APPROVED')	
{
	 	//GENERAL SETUP
		$data['tran_link'] = ADMIN_BASE_URL.'primary_sale_controller/sample_rcv/'; 
		$view_path_name='primary_sale_view/transaction/sample_rcv';		
				
						
			$where_array = array('id >' => 0,'brandtype '=> 'BRAND');
			$data['productlist'] = 
			$this->projectmodel->get_all_record('brands',$where_array);
		
			$where_array = array('id' => 0);
			$data['ac_tran_list'] = 
			$this->projectmodel->get_all_record('sample_tran_details',$where_array);
			
			if ( $this->session->userdata('COMP_ID')=='MEDICHEM') {
			$where_array = array('id' => 35);
			$data['vendorlist'] = 
			$this->projectmodel->get_all_record('tbl_party',$where_array);
			}
			
			if ( $this->session->userdata('COMP_ID')=='UNITEDLAB') {
			$where_array = array('id' => 1);
			$data['vendorlist'] = 
			$this->projectmodel->get_all_record('tbl_party',$where_array);
			}
			
			//DISPLAY LIST AT BUTTON
			$dat=date('Y-m-d');
			$dat1=$this->general_library->get_date(date('Y-m-d'),0,-4,0);
		
			$sqlinv="select * from  sample_tran_summary where status='SAMPLE_RCV'		
			order by  invoice_date desc";		
			$data['projectlist'] =$this->projectmodel->get_records_from_sql($sqlinv);
			
			
		//GENERAL SETUP END
		
		if($displaytype=="list")
		{
			//HEADER TABLE
			$data['invoice_summary_id']=0;
			$data['invoice_no']=$data['challan_no']=$data['orderno']=
			$data['trno']=$data['lrno']=$data['destination']=$data['transporter']=
			$data['no_of_case']=$data['comment']='';
			$data['invoice_date']=$data['challan_date']=$data['orderdate']=
			$data['trdate']=$data['lrdate']=date('Y-m-d');
			//$data['product_type']='OLDDIV';
			$data['BILL_TYPE']=$data['tbl_party_id']='';
			$data['hq_id']=0;
			$data['due_payment_date']=$data['pending_credit_limit']='';
			$data['total_amt']='';
			$data['rnd']=$data['grandtot']='';
			$data['totvatamt']=0;
			
			//DETAIL TABLE
			$data['product_id']=0;
			$data['qnty']=$data['freeqty']=$data['replace_qnty']='';
			$data['batchno']=$data['exp_monyr']=$data['mfg_monyr']=$data['rate']='';
			$data['mrp']=$data['ptr']=$data['srate']=$data['vat_per']=$data['ed']='';
			$data['subtotal']='';
			
			
			//GENERAL UPDATION SECTION
			//$this->general_update();				
			//GENERAL UPDATION SECTION end 
			
		}
		
		
		if($displaytype=='addeditview')
		{
			$data['invoice_summary_id']=0;
			$data['invoice_no']=$data['challan_no']=$data['orderno']=
			$data['trno']=$data['lrno']=$data['destination']=$data['transporter']=
			$data['no_of_case']=$data['comment']='';
			$data['invoice_date']=$data['challan_date']=$data['orderdate']=
			$data['trdate']=$data['lrdate']=date('Y-m-d');			
			//$data['product_type']='OLDDIV';
				
				//tran header
				$sqlinv="select * from  sample_tran_summary where id=".$id_header;
				$rows =$this->projectmodel->get_records_from_sql($sqlinv);	
				foreach ($rows as $row)
				{ 	
					$data['invoice_summary_id']=$id_header;
					$data['invoice_no']=$row->invoice_no;
					$data['challan_no']=$row->challan_no;
					$data['orderno']=$row->orderno;
					$data['trno']=$row->trno;
					$data['lrno']=$row->lrno;
					$data['destination']=$row->destination;
					$data['transporter']=$row->transporter;
					$data['no_of_case']=$row->no_of_case;
					$data['comment']=$row->comment;
					$data['invoice_date']=$row->invoice_date;
					$data['challan_date']=$row->challan_date;
					$data['orderdate']=$row->orderdate;
					$data['trdate']=$row->trdate;
					$data['lrdate']=$row->lrdate;		
					//$data['product_type']=$row->product_type;	
					$data['tbl_party_id']=$row->tbl_party_id;	
					$data['totvatamt']=$row->totvatamt;	
					
					$data['due_payment_date']=$row->due_payment_date;
					$data['pending_credit_limit']=$row->pending_credit_limit;
					//$data['hq_id']=$row->hq_id;
					$data['total_amt']=$row->total_amt;
					//$data['disc_per']=$row->disc_per;
					//$data['cash_disc']=$row->cash_disc;
					//$data['tot_discount']=$row->tot_discount;
					//$data['tot_cash_discount']=$row->tot_cash_discount;
					
					$data['rnd']=$row->rndoff;
					$data['grandtot']=$row->grandtot;
									
				}
				
				//tran details
				$data['product_id']=0;
				$data['qnty']=$data['freeqty']=$data['replace_qnty']='';
				$data['batchno']=$data['exp_monyr']=$data['mfg_monyr']=$data['rate']='';
				$data['mrp']=$data['ptr']=
				$data['srate']=$data['vat_per']=$data['ed']='';
				$data['subtotal']='';
				
				$where_array = array('invoice_summary_id' => $id_header);
				$data['ac_tran_list'] = 
				$this->projectmodel->get_all_record('sample_tran_details',$where_array);
								
				$sqlinv="select * from  sample_tran_details where id=".$id_detail;
				$rows =$this->projectmodel->get_records_from_sql($sqlinv);	
				foreach ($rows as $row)
				{ 	
					$data['product_id']=$row->product_id;
					$data['batchno']=$row->batchno;
					$data['qnty']=$row->qnty;
					$data['freeqty']=$row->freeqty;
					$data['exp_monyr']=$row->exp_monyr;
					$data['mfg_monyr']=$row->mfg_monyr;
					$data['rate']=$data['srate']=$row->srate;
					$data['mrp']=$row->mrp;
					$data['ptr']=$row->ptr;
					$data['srate']=$row->srate;
					$data['vat_per']=$row->vat_per;
					$data['ed']=$row->ed;
					$data['subtotal']=$row->subtotal;
				}
				
			
			
		}
		
		if(isset($_POST) and $displaytype=='save')
		{
			
			//HEADER ENTRY part
			
			$save_hdr['invoice_no']=$this->input->post('invoice_no');;
			$save_hdr['challan_no']=$this->input->post('challan_no');
			$save_hdr['orderno']=$this->input->post('orderno');
			$save_hdr['trno']=$this->input->post('trno');
			$save_hdr['lrno']=$this->input->post('lrno');
			$save_hdr['destination']=$this->input->post('destination');
			$save_hdr['no_of_case']=$this->input->post('no_of_case');
			$save_hdr['comment']=$this->input->post('comment');
			$save_hdr['invoice_date']=$this->input->post('invoice_date');
			$save_hdr['challan_date']=$this->input->post('challan_date');
			$save_hdr['orderdate']=$this->input->post('orderdate');
			$save_hdr['trdate']=$this->input->post('trdate');
			$save_hdr['lrdate']=$this->input->post('lrdate');	
			//$save_hdr['product_type']=$this->input->post('product_type');
			$save_hdr['tbl_party_id']=$this->input->post('tbl_party_id');	
			$save_hdr['status']='SAMPLE_RCV';
			
			
			//checking part
			if($save_hdr['tbl_party_id']=="" or $save_hdr['invoice_no']=="" or
			$save_hdr['invoice_date']=="" )
				{
					$this->session->set_userdata('alert_msg',
					'Please Enter Party , Invoice No and Invoice Date');
					redirect('primary_sale_controller/sample_rcv/list/0/0/');
				}
				
		
			if($id_header==0) 
			{					
				$this->projectmodel->save_records_model($id_header,
				'sample_tran_summary',$save_hdr);
				$id_header=$this->db->insert_id();
				$this->session->set_userdata('alert_msg',
				'One Record Inserted Successfully');
			}	
			
			if($id_header>0)// update data....
			{
				$this->projectmodel->save_records_model($id_header,
				'sample_tran_summary',$save_hdr);
				$this->session->set_userdata('alert_msg', 
				'One Record Updated Successfully');						
			}
				
			//HEADER ENTRY part		
				
				
			//tran details
			$inv_details['invoice_summary_id']=$id_header;
			$inv_details['id']=$id_detail;
			$inv_details['product_id']=$this->input->post('product_id');
			//$inv_details['mrp_incl_tax']=0;
			
			if($inv_details['product_id']>0)
			{
								
				$inv_details['status']='SAMPLE_RCV';
				$inv_details['batchno']=$this->input->post('batchno');
				$inv_details['exp_monyr']=$this->input->post('exp_monyr');	
				$inv_details['mfg_monyr']=$this->input->post('mfg_monyr');	
				$inv_details['qnty']=$this->input->post('qnty');
				
				if($inv_details['batchno']=="" )
				{
					$this->session->set_userdata('alert_msg',
					'Please Enter batch and Qnty');
					redirect('primary_sale_controller/sample_rcv/addeditview/'.
					$id_header.'/0/');
				}
				
				
				$inv_details['freeqty']=$this->input->post('freeqty');	
				//$inv_details['replace_qnty']=$this->input->post('replace_qnty');	
				$inv_details['totqnty']=$inv_details['qnty'];
				$inv_details['srate']=$inv_details['rate']=
				$this->input->post('srate');	
				$inv_details['ptr']=$this->input->post('ptr');
				$inv_details['mrp']=$this->input->post('mrp');
				$inv_details['ed']=$this->input->post('ed');
				$totamt=$inv_details['qnty']*$inv_details['rate'];
				$inv_details['subtotal']=round($totamt,2);	
								
				$inv_details['vatamt']=0;
				
						
				if($id_detail==0) 
				{					
					$this->projectmodel->save_records_model('',
					'sample_tran_details',$inv_details);
					//$id_detail=$this->db->insert_id();
					$this->session->set_userdata('alert_msg',
					'One Record Inserted Successfully');
				}	
				
				if($id_detail>0)// update data....
				{
					$this->projectmodel->save_records_model($id_detail,
					'sample_tran_details',$inv_details);
					$this->session->set_userdata('alert_msg', 
					'One Record Updated Successfully');						
				}
			}
			
			$this->transaction_update($id_header,'SAMPLE_RCV');	
			
			//$this->accounts_model->ledger_transactions($id_header,'SELL');
					
			redirect('primary_sale_controller/sample_rcv/addeditview/'.$id_header.'/0/');
		
		}		
		
		
		
		if($displaytype=='delete')
		{
		$sql="delete from sample_tran_details  where id=".$id_detail;
		$this->db->query($sql);
		$this->transaction_update($id_header,'SAMPLE_RCV');														
		redirect('primary_sale_controller/sample_rcv/addeditview/'.$id_header.'/0/');
		}
		
		
		//DELETE ALL 	SC/C/1195/16-17
		if($displaytype=='deleteAll')
		{
			$sql="delete from  sample_tran_details 
			 where invoice_summary_id=".$id_header;
			$this->db->query($sql);	
			$this->session->set_userdata('alert_msg','Invoice has been deleted!');
					
			$sql="delete from  sample_tran_summary  where id=".$id_header;
			$this->db->query($sql);	
			
			redirect('primary_sale_controller/sample_rcv/list/0/0/');
		}
		
		
		$this->page_layout_display($view_path_name,$data);
}



public function  sample_issue($displaytype='list',$id_header=0,
$id_detail=0,$approve_status='APPROVED')	
{
	 	//GENERAL SETUP
		$data['tran_link'] = ADMIN_BASE_URL.'primary_sale_controller/sample_issue/'; 
		$view_path_name='primary_sale_view/transaction/sample_issue';		
				
						
			$where_array = array('id >' => 0,'brandtype '=> 'BRAND');
			$data['productlist'] = 
			$this->projectmodel->get_all_record('brands',$where_array);
		
			$where_array = array('id' => 0);
			$data['ac_tran_list'] = 
			$this->projectmodel->get_all_record('sample_tran_details',$where_array);
			
			$sqlqty="select * from tbl_hierarchy_org where tbl_designation_id>1 and 
			tbl_designation_id<=5 ";
			$data['vendorlist'] = $this->projectmodel->get_records_from_sql($sqlqty);	
			
			//DISPLAY LIST AT BUTTON
			$dat=date('Y-m-d');
			$dat1=$this->general_library->get_date(date('Y-m-d'),0,-4,0);
		
			$sqlinv="select * from  sample_tran_summary where status='SAMPLE_ISU'		
			order by  invoice_date desc";		
			$data['projectlist'] =$this->projectmodel->get_records_from_sql($sqlinv);
			
			
		//GENERAL SETUP END
		
		if($displaytype=="list")
		{
			//HEADER TABLE
			$data['invoice_summary_id']=0;
			
			$data['invoice_no']=$data['challan_no']=$data['orderno']=
			$data['trno']=$data['lrno']=$data['destination']=$data['transporter']=
			$data['no_of_case']=$data['comment']='';
			$data['invoice_date']=$data['challan_date']=$data['orderdate']=
			$data['trdate']=$data['lrdate']=date('Y-m-d');
			//$data['product_type']='OLDDIV';
			$data['BILL_TYPE']=$data['tbl_party_id']='';
			$data['hq_id']=0;
			$data['due_payment_date']=$data['pending_credit_limit']='';
			$data['total_amt']='';
			$data['rnd']=$data['grandtot']='';
			$data['totvatamt']=0;
			
			//DETAIL TABLE
			$data['product_id']=0;
			$data['qnty']=$data['freeqty']=$data['replace_qnty']='';
			$data['batchno']=$data['exp_monyr']=$data['mfg_monyr']=$data['rate']='';
			$data['mrp']=$data['ptr']=$data['srate']=$data['vat_per']=$data['ed']='';
			$data['subtotal']='';
			
			
			//GENERAL UPDATION SECTION
			//$this->general_update();				
			//GENERAL UPDATION SECTION end 
			
		}
		
		
		if($displaytype=='addeditview')
		{
			$data['invoice_summary_id']=0;
			$data['invoice_no']=$data['challan_no']=$data['orderno']=
			$data['trno']=$data['lrno']=$data['destination']=$data['transporter']=
			$data['no_of_case']=$data['comment']='';
			$data['invoice_date']=$data['challan_date']=$data['orderdate']=
			$data['trdate']=$data['lrdate']=date('Y-m-d');			
			//$data['product_type']='OLDDIV';
				
				//tran header
				$sqlinv="select * from  sample_tran_summary where id=".$id_header;
				$rows =$this->projectmodel->get_records_from_sql($sqlinv);	
				foreach ($rows as $row)
				{ 	
					$data['invoice_summary_id']=$id_header;
					$data['invoice_no']=$row->invoice_no;
					$data['challan_no']=$row->challan_no;
					$data['orderno']=$row->orderno;
					$data['trno']=$row->trno;
					$data['lrno']=$row->lrno;
					$data['destination']=$row->destination;
					$data['transporter']=$row->transporter;
					$data['no_of_case']=$row->no_of_case;
					$data['comment']=$row->comment;
					$data['invoice_date']=$row->invoice_date;
					$data['challan_date']=$row->challan_date;
					$data['orderdate']=$row->orderdate;
					$data['trdate']=$row->trdate;
					$data['lrdate']=$row->lrdate;		
					//$data['product_type']=$row->product_type;	
					$data['tbl_party_id']=$row->tbl_party_id;	
					$data['totvatamt']=$row->totvatamt;	
					
					$data['due_payment_date']=$row->due_payment_date;
					$data['pending_credit_limit']=$row->pending_credit_limit;
					//$data['hq_id']=$row->hq_id;
					$data['total_amt']=$row->total_amt;
					//$data['disc_per']=$row->disc_per;
					//$data['cash_disc']=$row->cash_disc;
					//$data['tot_discount']=$row->tot_discount;
					//$data['tot_cash_discount']=$row->tot_cash_discount;
					
					$data['rnd']=$row->rndoff;
					$data['grandtot']=$row->grandtot;
									
				}
				
				//tran details
				$data['product_id']=0;
				$data['qnty']=$data['freeqty']=$data['replace_qnty']='';
				$data['batchno']=$data['exp_monyr']=$data['mfg_monyr']=$data['rate']='';
				$data['mrp']=$data['ptr']=$data['srate']=$data['vat_per']=$data['ed']='';
				$data['subtotal']='';
				
				$where_array = array('invoice_summary_id' => $id_header);
				$data['ac_tran_list'] = 
				$this->projectmodel->get_all_record('sample_tran_details',$where_array);
								
				$sqlinv="select * from  sample_tran_details where id=".$id_detail;
				$rows =$this->projectmodel->get_records_from_sql($sqlinv);	
				foreach ($rows as $row)
				{ 	
					$data['product_id']=$row->product_id;
					$data['batchno']=$row->batchno;
					$data['qnty']=$row->qnty;
					$data['freeqty']=$row->freeqty;
					$data['exp_monyr']=$row->exp_monyr;
					$data['mfg_monyr']=$row->mfg_monyr;
					$data['rate']=$row->rate;
					$data['mrp']=$row->mrp;
					$data['ptr']=$row->ptr;
					$data['srate']=$row->srate;
					$data['vat_per']=$row->vat_per;
					$data['ed']=$row->ed;
					$data['subtotal']=$row->subtotal;
				}
				
			
			
		}
		
		if(isset($_POST) and $displaytype=='save')
		{
			
			//HEADER ENTRY part
			
			$save_hdr['invoice_no']=$this->input->post('invoice_no');;
			$save_hdr['challan_no']=$this->input->post('challan_no');
			$save_hdr['orderno']=$this->input->post('orderno');
			$save_hdr['trno']=$this->input->post('trno');
			$save_hdr['lrno']=$this->input->post('lrno');
			$save_hdr['destination']=$this->input->post('destination');
			$save_hdr['no_of_case']=$this->input->post('no_of_case');
			$save_hdr['comment']=$this->input->post('comment');
			$save_hdr['invoice_date']=$this->input->post('invoice_date');
			$save_hdr['challan_date']=$this->input->post('challan_date');
			$save_hdr['orderdate']=$this->input->post('orderdate');
			$save_hdr['trdate']=$this->input->post('trdate');
			$save_hdr['lrdate']=$this->input->post('lrdate');	
			//$save_hdr['product_type']=$this->input->post('product_type');
			$save_hdr['tbl_party_id']=$this->input->post('tbl_party_id');	
			$save_hdr['status']='SAMPLE_ISU';
			
			
			//checking part
			if($save_hdr['tbl_party_id']=="" or $save_hdr['invoice_no']=="" or
			$save_hdr['invoice_date']=="" )
				{
					$this->session->set_userdata('alert_msg',
					'Please Enter Party , Invoice No and Invoice Date');
					redirect('primary_sale_controller/sample_issue/list/0/0/');
				}
				
		
			if($id_header==0) 
			{					
				$this->projectmodel->save_records_model($id_header,
				'sample_tran_summary',$save_hdr);
				$id_header=$this->db->insert_id();
				$this->session->set_userdata('alert_msg',
				'One Record Inserted Successfully');
			}	
			
			if($id_header>0)// update data....
			{
				$this->projectmodel->save_records_model($id_header,
				'sample_tran_summary',$save_hdr);
				$this->session->set_userdata('alert_msg', 
				'One Record Updated Successfully');						
			}
				
			//HEADER ENTRY part		
				
				
			//tran details
			$inv_details['invoice_summary_id']=$id_header;
			$inv_details['id']=$id_detail;
			$inv_details['product_id']=$this->input->post('product_id');
			
			//$inv_details['mrp_incl_tax']=0;
			
			if($inv_details['product_id']>0)
			{
								
				$inv_details['status']='SAMPLE_ISU';
				$inv_details['batchno']=$this->input->post('batchno');
				$inv_details['exp_monyr']=$this->input->post('exp_monyr');	
				$inv_details['mfg_monyr']=$this->input->post('mfg_monyr');	
				$inv_details['qnty']=$this->input->post('qnty');
				
				if($inv_details['batchno']=="" )
				{
					$this->session->set_userdata('alert_msg',
					'Please Enter batch and Qnty');
					
					redirect('primary_sale_controller/sample_issue/addeditview/'.
					$id_header.'/0/');
				}
				
				
				$inv_details['freeqty']=$this->input->post('freeqty');	
				//$inv_details['replace_qnty']=$this->input->post('replace_qnty');	
				$inv_details['totqnty']=$inv_details['qnty'];
				$inv_details['srate']=$inv_details['rate']=
				$this->input->post('rate');	
				$inv_details['ptr']=$this->input->post('ptr');
				$inv_details['mrp']=$this->input->post('mrp');
				$inv_details['ed']=$this->input->post('ed');
				$totamt=$inv_details['qnty']*$inv_details['rate'];
				$inv_details['subtotal']=round($totamt,2);	
								
				$inv_details['vatamt']=0;
				
						
				if($id_detail==0) 
				{					
					$this->projectmodel->save_records_model('',
					'sample_tran_details',$inv_details);
					//$id_detail=$this->db->insert_id();
					$this->session->set_userdata('alert_msg',
					'One Record Inserted Successfully');
				}	
				
				if($id_detail>0)// update data....
				{
					$this->projectmodel->save_records_model($id_detail,
					'sample_tran_details',$inv_details);
					$this->session->set_userdata('alert_msg', 
					'One Record Updated Successfully');						
				}
			}
			
			$this->transaction_update($id_header,'SAMPLE_ISU');	
			
			//$this->accounts_model->ledger_transactions($id_header,'SELL');
					
			redirect('primary_sale_controller/sample_issue/addeditview/'.$id_header.'/0/');
		
		}		
		
		
		
		if($displaytype=='delete')
		{
		$sql="delete from sample_tran_details  where id=".$id_detail;
		$this->db->query($sql);
		$this->transaction_update($id_header,'SAMPLE_ISU');														
		redirect('primary_sale_controller/sample_issue/addeditview/'.$id_header.'/0/');
		}
		
		
		//DELETE ALL 	SC/C/1195/16-17
		if($displaytype=='deleteAll')
		{
			$sql="delete from  sample_tran_details  
			where invoice_summary_id=".$id_header;
			$this->db->query($sql);	
			$this->session->set_userdata('alert_msg','Invoice has been deleted!');
			$sql="delete from  sample_tran_summary  where id=".$id_header;
			$this->db->query($sql);	
			
			redirect('primary_sale_controller/sample_issue/list/0/0/');
		}
		
		
		$this->page_layout_display($view_path_name,$data);
}



/*SAMPLE  SECTION END*/
	
private function create_invoice_no($finyr,$TRANTYPE,$tbl_party_id)
{
		// FOR FORBEST
	/*	if($TRANTYPE<>'SAMPLE_RCV' && $TRANTYPE<>'SAMPLE_ISU')
		{
			$sql="select * from stockist where 	id=".$tbl_party_id." ";
			$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
			foreach ($rowrecord as $row1)
			{ $retail_field=$row1->retail_field;}	
						
			 $sql="select * from tbl_hierarchy_org where id=".$retail_field." ";
			$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
			foreach ($rowrecord as $row1)
			{ $city_id=$row1->city_id;}	
			
			 $sql="select * from head_q where id=".$city_id." ";
			$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
			foreach ($rowrecord as $row1)
			{ $state=$row1->state;}	
		}
		else
		{
		$state='West_Bengal';
		}*/
				
		//serial no 
	/*	$sql="select * from auto_invoice_mstr where finyr='".$finyr."' 
		and TRANTYPE='$TRANTYPE' and state='$state' ";*/
		
		// FOR FORBEST
		
		
		$sql="select * from auto_invoice_mstr where finyr='".$finyr."' 
		and TRANTYPE='$TRANTYPE' ";
		$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
		foreach ($rowrecord as $row1)
		{   $statecode=$row1->statecode;
			$srl=$row1->srl; 
		}	
		
		 $inv_cn_no=$statecode.'/'.$srl.'/'.$finyr;
		
		 $sql="update auto_invoice_mstr set 
		 srl=$srl+1 where  finyr='".$finyr."' and TRANTYPE='$TRANTYPE'  ";
		 $this->db->query($sql);
		 
	    return $inv_cn_no;
	
}	
	
/*SELL SECTION END */
	

/*SELL RETURN SECTION*/

public function sell_rtn_stockist_section_NEW($displaytype='list',$id_header=0,
$id_detail=0,$approve_status='APPROVED')	
{
	/*$sql="select * from invoice_summary where status='SELL'";			
	$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
	foreach ($rowrecord as $row1)
	{
	$id_header=$row1->id;
	$status=$row1->status;
	$this->accounts_model->ledger_transactions($id_header,$status);
	}*/
		
		
		//GENERAL SETUP
		$data['tran_link'] = ADMIN_BASE_URL.'primary_sale_controller/sell_rtn_stockist_section/'; 
		$view_path_name='primary_sale_view/transaction/sell_rtn_from_stockist';		
		
			$where_array = array('parent_id ' => 0);
			$data['tax_list'] = 
			$this->projectmodel->get_all_record('acc_group_ledgers',$where_array);
					
						
			$where_array = array('id >' => 0,'brandtype '=> 'BRAND');
			$data['productlist'] = 
			$this->projectmodel->get_all_record('brands',$where_array);
		
			$where_array = array('id' => 0);
			$data['ac_tran_list'] = 
			$this->projectmodel->get_all_record('invoice_details',$where_array);
			
			$where_array = array('id >' => 0);
			$data['vendorlist'] = 
			$this->projectmodel->get_all_record('stockist',$where_array);
			
			//DISPLAY LIST AT BUTTON
			
			$dat1=$this->general_library->get_date(date('Y-m-d'),0,-4,0);
		    $dat=date('Y-m-d');
			
			$sqlinv="select * from  invoice_summary where status='SELL'	 and
			invoice_date between '$dat1' and '$dat' order by  invoice_date desc";		
			$data['projectlist'] =
			$this->projectmodel->get_records_from_sql($sqlinv);
			
			
						
		//GENERAL SETUP END
		
		if($displaytype=="list")
		{
			//HEADER TABLE
			$data['invoice_summary_id']=0;
			
			$data['invoice_no']=$data['challan_no']=$data['orderno']=
			$data['trno']=$data['lrno']=$data['destination']=$data['transporter']=
			$data['no_of_case']=$data['comment']='';
			$data['invoice_date']=$data['challan_date']=$data['orderdate']=
			$data['trdate']=$data['lrdate']=date('Y-m-d');
			$data['product_type']='OLDDIV';
			$data['BILL_TYPE']=$data['tbl_party_id']='';
			$data['hq_id']=0;
			$data['due_payment_date']=$data['pending_credit_limit']='';
			$data['total_amt']=$data['disc_per']='';
			$data['cash_disc']=$data['tot_discount']=$data['tot_cash_discount']='';
			$data['bank_charge_chqno']=$data['bank_charge_chqdate']='';
			$data['bank_charge_chqamt']=$data['bank_charge_fine']='';
			$data['interest_charge']=$data['freight_charge']='';
			$data['rnd']=$data['grandtot']='';
			$data['totvatamt']=0;
			
			//DETAIL TABLE
			$data['product_id']=0;
			$data['qnty']=$data['freeqty']=$data['replace_qnty']='';
			$data['batchno']=$data['exp_monyr']=$data['mfg_monyr']=$data['rate']='';
			$data['mrp']=$data['ptr']=$data['srate']=$data['vat_per']=$data['ed']='';
			$data['disc_per']=$data['subtotal']='';
			
			
			//GENERAL UPDATION SECTION
			//$this->general_update();				
			//GENERAL UPDATION SECTION end 
			
		}
		
		
		if($displaytype=='addeditview')
		{
			$data['invoice_summary_id']=0;
			$data['invoice_no']=$data['challan_no']=$data['orderno']=
			$data['trno']=$data['lrno']=$data['destination']=$data['transporter']=
			$data['no_of_case']=$data['comment']='';
			$data['invoice_date']=$data['challan_date']=$data['orderdate']=
			$data['trdate']=$data['lrdate']=date('Y-m-d');			
			$data['product_type']='OLDDIV';
				
				//tran header
				$sqlinv="select * from  invoice_summary where id=".$id_header;
				$rows =$this->projectmodel->get_records_from_sql($sqlinv);	
				foreach ($rows as $row)
				{ 	
					$data['invoice_summary_id']=$id_header;
					$data['invoice_no']=$row->invoice_no;
					$data['challan_no']=$row->challan_no;
					$data['orderno']=$row->orderno;
					$data['trno']=$row->trno;
					$data['lrno']=$row->lrno;
					$data['destination']=$row->destination;
					$data['transporter']=$row->transporter;
					$data['no_of_case']=$row->no_of_case;
					$data['comment']=$row->comment;
					$data['invoice_date']=$row->invoice_date;
					$data['challan_date']=$row->challan_date;
					$data['orderdate']=$row->orderdate;
					$data['trdate']=$row->trdate;
					$data['lrdate']=$row->lrdate;		
					$data['product_type']=$row->product_type;	
					$data['tbl_party_id']=$row->tbl_party_id;	
					$data['totvatamt']=$row->totvatamt;	
					
					$data['due_payment_date']=$row->due_payment_date;
					$data['pending_credit_limit']=$row->pending_credit_limit;
					$data['hq_id']=$row->hq_id;
					$data['total_amt']=$row->total_amt;
					$data['disc_per']=$row->disc_per;
					$data['cash_disc']=$row->cash_disc;
					$data['tot_discount']=$row->tot_discount;
					$data['tot_cash_discount']=$row->tot_cash_discount;
					
					$data['bank_charge_chqno']=$row->bank_charge_chqno;
					$data['bank_charge_chqdate']=$row->bank_charge_chqdate;
					$data['bank_charge_chqamt']=$row->bank_charge_chqamt;
					$data['bank_charge_fine']=$row->bank_charge_fine;
					$data['interest_charge']=$row->interest_charge;
					$data['freight_charge']=$row->freight_charge;
					$data['BILL_TYPE']=$row->BILL_TYPE;
					
					$data['rnd']=$row->rndoff;
					$data['grandtot']=$row->grandtot;
									
				}
				
				//tran details
				$data['product_id']=0;
				$data['qnty']=$data['freeqty']=$data['replace_qnty']='';
				$data['batchno']=$data['exp_monyr']=$data['mfg_monyr']=$data['rate']='';
				$data['mrp']=$data['ptr']=$data['srate']=$data['vat_per']=$data['ed']='';
				$data['disc_per']=$data['subtotal']='';
				
				$where_array = array('invoice_summary_id' => $id_header);
				$data['ac_tran_list'] = 
				$this->projectmodel->get_all_record('invoice_details',$where_array);
								
				$sqlinv="select * from  invoice_details where id=".$id_detail;
				$rows =$this->projectmodel->get_records_from_sql($sqlinv);	
				foreach ($rows as $row)
				{ 	
					$data['product_id']=$row->product_id;
					$data['batchno']=$row->batchno;
					$data['qnty']=$row->qnty;
					$data['freeqty']=$row->freeqty;
					$data['exp_monyr']=$row->exp_monyr;
					$data['mfg_monyr']=$row->mfg_monyr;
					$data['rate']=$row->rate;
					$data['mrp']=$row->mrp;
					$data['ptr']=$row->ptr;
					$data['srate']=$row->srate;
					$data['vat_per']=$row->vat_per;
					$data['ed']=$row->ed;
					$data['subtotal']=$row->subtotal;
					$data['disc_per']=$row->disc_per;
				}
				
			
			
		}
		
		if(isset($_POST) and $displaytype=='save')
		{
			
			//HEADER ENTRY part
			
			$save_hdr['invoice_no']=$this->input->post('invoice_no');;
			$save_hdr['challan_no']=$this->input->post('challan_no');
			$save_hdr['orderno']=$this->input->post('orderno');
			$save_hdr['trno']=$this->input->post('trno');
			$save_hdr['lrno']=$this->input->post('lrno');
			$save_hdr['destination']=$this->input->post('destination');
			$save_hdr['no_of_case']=$this->input->post('no_of_case');
			$save_hdr['comment']=$this->input->post('comment');
			$save_hdr['invoice_date']=$this->input->post('invoice_date');
			$save_hdr['challan_date']=$this->input->post('challan_date');
			$save_hdr['orderdate']=$this->input->post('orderdate');
			$save_hdr['trdate']=$this->input->post('trdate');
			$save_hdr['lrdate']=$this->input->post('lrdate');	
			$save_hdr['product_type']=$this->input->post('product_type');
			$save_hdr['tbl_party_id']=$this->input->post('tbl_party_id');	
			$save_hdr['bank_charge_chqno']=$this->input->post('bank_charge_chqno');
			$save_hdr['bank_charge_chqdate']=$this->input->post('bank_charge_chqdate');
			$save_hdr['bank_charge_chqamt']=$this->input->post('bank_charge_chqamt');
			$save_hdr['bank_charge_fine']=$this->input->post('bank_charge_fine');
			$save_hdr['interest_charge']=$this->input->post('interest_charge');
			$save_hdr['freight_charge']=$this->input->post('freight_charge');
			$save_hdr['status']=$this->input->post('status');
			$save_hdr['product_type']=$this->input->post('product_type');	
			
			//checking part
			if($save_hdr['tbl_party_id']=="" or $save_hdr['invoice_no']=="" or
			$save_hdr['invoice_date']=="" )
				{
					$this->session->set_userdata('alert_msg',
					'Please Enter Party , Invoice No and Invoice Date');
					redirect('primary_sale_controller/sell_rtn_stockist_section/list/0/0/');
				}
				
						
			
			if($this->input->post('hq_id')<>'')
			{
				$save_hdr['hq_id']=$this->input->post('hq_id');
				
				$save_hdr['emp_id']=0;			
				$sql="select a.id 
				from tbl_employee_mstr a,tbl_hierarchy_org b
				where a.id=b.employee_id and  b.id=".$save_hdr['hq_id']." ";
				$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
				foreach ($rowrecord as $row1)
				{$save_hdr['emp_id']=$row1->id;}
			}	
								
			//credit date calculation
			$CREDIT_LIMIT=0;
			$CREDIT_DAYS=0;
			$TRANSPORTER='';
			$BILL_TYPE='VATBILL';
			$sql="select * from stockist where id=".$save_hdr['tbl_party_id']." ";
			$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
			foreach ($rowrecord as $row1)
			{
				$CREDIT_LIMIT=$row1->CREDIT_LIMIT;
				$CREDIT_DAYS=$row1->CREDIT_DAYS;
				$BILL_TYPE=$row1->BILL_TYPE;
				$TRANSPORTER=$row1->TRANSPORTER;
			}
											
			$save_hdr['due_payment_date']=
			$this->general_library->get_date($save_hdr['lrdate'],
			$CREDIT_DAYS,0,0);	
			
			$save_hdr['BILL_TYPE']=$BILL_TYPE;
			$save_hdr['transporter']=$TRANSPORTER;
			$save_hdr['pending_credit_limit']='';
			
			$save_hdr['disc_per']=$this->input->post('disc_per');
			$save_hdr['cash_disc']=$this->input->post('cash_disc');
				
						
		
			if($id_header==0) 
			{					
				$this->projectmodel->save_records_model($id_header,
				'invoice_summary',$save_hdr);
				$id_header=$this->db->insert_id();
				$this->session->set_userdata('alert_msg',
				'One Record Inserted Successfully');
			}	
			
			if($id_header>0)// update data....
			{
				$this->projectmodel->save_records_model($id_header,
				'invoice_summary',$save_hdr);
				$this->session->set_userdata('alert_msg', 
				'One Record Updated Successfully');						
			}
				
			//HEADER ENTRY part		
				
				
			//tran details
			$inv_details['invoice_summary_id']=$id_header;
			$inv_details['id']=$id_detail;
			$inv_details['product_id']=$this->input->post('product_id');
			
			$inv_details['mrp_incl_tax']=0;
			
			if($inv_details['product_id']>0)
			{
				$sql="select * from brands where id=".$inv_details['product_id']." ";
				$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
				foreach ($rowrecord as $row1)
				{$inv_details['mrp_incl_tax']=$row1->mrp_incl_tax;}
				
				$inv_details['status']=$this->input->post('status');
				$inv_details['batchno']=$this->input->post('batchno');
				$inv_details['exp_monyr']=$this->input->post('exp_monyr');	
				$inv_details['mfg_monyr']=$this->input->post('mfg_monyr');	
				$inv_details['qnty']=$this->input->post('qnty');
				
				if($inv_details['batchno']=="" )
				{
					$this->session->set_userdata('alert_msg',
					'Please Enter batch and Qnty');
					
					redirect('primary_sale_controller/sell_section/addeditview/'.
					$id_header.'/0/');
				}
				
				
				$inv_details['freeqty']=$this->input->post('freeqty');	
				$inv_details['replace_qnty']=$this->input->post('replace_qnty');	
				$inv_details['totqnty']=$inv_details['qnty']+
				$inv_details['freeqty']+$inv_details['replace_qnty'];
				$inv_details['srate']=$inv_details['rate']=
				$this->input->post('rate');	
				$inv_details['ptr']=$this->input->post('ptr');
				$inv_details['mrp']=$this->input->post('mrp');
				$inv_details['ed']=$this->input->post('ed');
				$totamt=$inv_details['qnty']*$inv_details['rate'];
				$inv_details['subtotal']=round($totamt,2);	
				$inv_details['vat_ledger_id']=$this->input->post('vat_ledger_id');
				$inv_details['disc_per']=$this->input->post('disc_per');
				
				$tax_per=$inv_details['vat_per']=0;
				$sql="select default_value from acc_group_ledgers where 
				id=".$inv_details['vat_ledger_id']." ";			
				$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
				foreach ($rowrecord as $row1)
				{$tax_per=$inv_details['vat_per']=$row1->default_value;}
				
				$inv_details['vatamt']=0;
				
						
				if($id_detail==0) 
				{					
					$this->projectmodel->save_records_model('',
					'invoice_details',$inv_details);
					//$id_detail=$this->db->insert_id();
					$this->session->set_userdata('alert_msg',
					'One Record Inserted Successfully');
				}	
				
				if($id_detail>0)// update data....
				{
					$this->projectmodel->save_records_model($id_detail,
					'invoice_details',$inv_details);
					$this->session->set_userdata('alert_msg', 
					'One Record Updated Successfully');						
				}
			}
			
			$this->transaction_update($id_header,'sale');	
			
			$this->accounts_model->ledger_transactions($id_header,'SELL');
			
			redirect('primary_sale_controller/sell_section/addeditview/'.$id_header.'/0/');
		
		}		
		
		
		
		if($displaytype=='delete')
		{
		$sql="delete from invoice_details  where id=".$id_detail;
		$this->db->query($sql);
		$this->transaction_update($id_header,'sale');		
		$this->accounts_model->ledger_transactions_delete($id_header,'SELL');
		redirect('primary_sale_controller/sell_section/addeditview/'.$id_header.'/0/');
		}
		
		
		//DELETE ALL 	SC/C/1195/16-17
		if($displaytype=='deleteAll')
		{
			$sql="delete from  invoice_details  where invoice_summary_id=".$id_header;
			$this->db->query($sql);	
			$this->session->set_userdata('alert_msg','Invoice has been deleted!');
					
			$sql="delete from  invoice_summary  where id=".$id_header;
			$this->db->query($sql);	
		    $this->accounts_model->ledger_transactions_delete($id_header,'SELL');
			redirect('primary_sale_controller/sell_section/list/0/0/');
		}
		
		$this->page_layout_display($view_path_name,$data);
}


public function sell_rtn_stockist_section($displaytype='list',$id=0)	
	 {
	 	
		$layout_data=array();
		$data=array();
		/*CHANGE HERE*/
		$viewname='sell_rtn_from_stockist';
		$table_name='invoice_summary';
		$redirectlist='primary_sale_controller/sell_rtn_stockist_section/'.
		$this->uri->segment(2).'/'.$displaytype.'/';
		
		$viewnamepath='primary_sale_view/transaction/'.$viewname;
		$data['product_del'] = ADMIN_BASE_URL.
		"primary_sale_controller/sell_rtn_stockist_section/";
			
		/*CHANGE HERE*/
		$data['product_addedit'] = 
		ADMIN_BASE_URL.'primary_sale_controller/sell_rtn_stockist_section/addeditview/'; 
		
		$data['INVOICE_ADJUST'] = 
		ADMIN_BASE_URL.'primary_sale_controller/sell_rtn_stockist_section/INVOICE_ADJUST/'; 
		
		$data['print_view'] = 
		ADMIN_BASE_URL.'primary_sale_controller/sell_rtn_stockist_section/print_view/'; 
		
		$where_array = array('id >' => 0);
		$data['vendorlist'] = $this->projectmodel->get_all_record('stockist',$where_array);
					
		$where_array = array('status' => 'SELL_RTN');
		$data['projectlist'] = $this->projectmodel->get_all_record('invoice_summary',
		$where_array);
						
		$where_array = array('id >' => 0,'brandtype '=> 'BRAND');
		$data['productlist'] = $this->projectmodel->get_all_record('brands',$where_array);
		$data['user_name'] = $this->session->userdata('user_name');
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
		
		
		$data['deleteall_link'] = 
		ADMIN_BASE_URL.'primary_sale_controller/sell_rtn_stockist_section/deleteall/'; 
		
		if($displaytype=='deleteall')
		{
		
		
		$sql="delete from  invoice_details  where invoice_summary_id=".$id;
		$this->db->query($sql);	
		
		$sql="delete from  invoice_summary  where id=".$id;
		$this->db->query($sql);	
		
		$sql="update   invoice_summary set rtn_invoice_summary_id1=0 
		  where rtn_invoice_summary_id1=".$id;
		$this->db->query($sql);
		
		$sql="update   invoice_summary set rtn_invoice_summary_id2=0 
		  where rtn_invoice_summary_id2=".$id;
		$this->db->query($sql);	
		
		$sql="update   invoice_summary set rtn_invoice_summary_id3=0 
		  where rtn_invoice_summary_id3=".$id;
		$this->db->query($sql);	
		
		$sql="update   invoice_summary set rtn_invoice_summary_id4=0 
		  where rtn_invoice_summary_id4=".$id;
		$this->db->query($sql);		
		
		
		
		
		$this->session->set_userdata('alert_msg','CN has been deleted!');
							
		redirect('primary_sale_controller/sell_rtn_stockist_section/addeditview/'.
		$id.'/0/');
		}
		
		
		
		if($this->uri->segment(6)=='delete')
		{
		$invoice_summary_id_del=$this->uri->segment(4);
		$invoice_detail_id_del=$this->uri->segment(5);
		$transaction_status=$this->uri->segment(6);
		$sql="delete from invoice_details  where id=".$invoice_detail_id_del;
		$this->db->query($sql);
		
		$sqlqty="select * 
		from invoice_summary where id=".$invoice_summary_id_del;
		$avlqty = $this->projectmodel->get_records_from_sql($sqlqty);
		foreach ($avlqty as $rowq)
		{	
		$disc_per=$rowq->disc_per;
		$tbl_party_id=$rowq->tbl_party_id;
		}	
		$sqlqty="select * from stockist where id=".$tbl_party_id;
		$avlqty = $this->projectmodel->get_records_from_sql($sqlqty);
		foreach ($avlqty as $rowq)
		{$BILL_TYPE=$rowq->BILL_TYPE;}		
		
		$this->update_invoice_sum_table($invoice_summary_id_del,$disc_per=0,$BILL_TYPE);
														
		redirect('primary_sale_controller/sell_rtn_stockist_section/addeditview/'.
		$invoice_summary_id_del.'/0/');
		}
		
		
	
		
		if($displaytype=='INVOICE_ADJUST')
		{
		  $invoice_summary_id=$this->uri->segment(4);
		  $transaction_status=$this->uri->segment(6);
				
			if($transaction_status=='delete_invoice')
			{
				$sell_invoice_id=$this->uri->segment(5);
				//SC/C/0346/16-17 
				  $query ="update  invoice_summary set
				  rtn_invoice_summary_id1=0, total_adjust_amt=0 where 
				  id=".$sell_invoice_id; 
				  $this->db->query($query);			
				
			}
			else
			{
			
			$invoice_for_adjust=
			$this->input->post('invoice_for_adjust');
			
			$available_balance_to_adjust=
			$this->input->post('available_balance_to_adjust');
			
			 $query ="update  invoice_summary set
			  rtn_invoice_summary_id1=".$invoice_summary_id.",
			  total_adjust_amt=".$available_balance_to_adjust." where 
			  id=".$invoice_for_adjust; 
			  $this->db->query($query);			
			
			}
												
		/*redirect('primary_sale_controller/sell_rtn_stockist_section/INVOICE_ADJUST/'.
		$invoice_summary_id.'/0/');*/
		
		}
		
		
		
						
		if($displaytype=='list')
				{
					$data['records']="";
					$data['productid'] ="0";
					//redirect('primary_sale_controller/purchase_section/list/');
				}
		if($displaytype=='addeditview')
				{
					
					$where_array = array('id' => $id);
					$data['records'] = 
					$this->projectmodel->get_all_record($table_name,$where_array);
					$data['productid'] =$id;
				}
		if($displaytype=='addedit') //add --update
				{
			$where_array = array('id' => $id);
			$data['records'] = 
			$this->projectmodel->get_all_record($table_name,$where_array);			
			$data['productid'] =$id;
			
			// add edit section start
			if(isset($_POST))
			{	
				
				$values=$this->input->post();
				$data['productid'] =$values['id'];
				$TRANTYPE=$this->input->post('status');
				$invoice_summary_id=$this->input->post('id');
				$invoice_details_id=$this->input->post('invoice_details_id');
					
			//if($TRANTYPE<>'SELL')
			//{
			//$this->form_validation->set_rules('invoice_no','Invoice No','required');}
			$this->form_validation->set_rules('invoice_date','Invoice Date','required');
			$this->form_validation->set_rules('tbl_party_id','Party Name','required');
				
			if($this->form_validation->run()==FALSE )
			{
				$this->session->set_userdata('alert_msg', validation_errors());
				redirect('primary_sale_controller/sell_rtn_stockist_section/'.
						$invoice_summary_id.'/'.$invoice_details_id.'/');
			}
			else  //validation pass
			{
				
					$save_data['id']=$this->input->post('id');
					$save_data['status']=$this->input->post('status');
					
					$save_data['invoice_no']=$this->input->post('invoice_no');
					$save_data['invoice_date']=$this->input->post('invoice_date');
					$save_data['challan_no']=$this->input->post('challan_no');	
					$save_data['challan_date']=$this->input->post('challan_date');	
					$save_data['orderno']=$this->input->post('orderno');	
					$save_data['orderdate']=$this->input->post('orderdate');	
					$save_data['trno']=$this->input->post('trno');	
					$save_data['trdate']=$this->input->post('trdate');						
					$save_data['tbl_party_id']=$this->input->post('tbl_party_id');
					$save_data['vehicle_no']=$this->input->post('vehicle_no');
					$save_data['comment']=$this->input->post('comment');
					$save_data['product_type']=$this->input->post('product_type');
					
									
					$save_data['total_amt']=$this->input->post('total_amt');	
					$disc_per_sum=$save_data['disc_per']=
					$this->input->post('disc_per_sum');	
					$save_data['tot_discount']=$this->input->post('tot_discount');	
					$save_data['totvatamt']=$this->input->post('totvatamt');	
					$freight_charge=
					$save_data['freight_charge']=$this->input->post('freight_charge');	
					
					$save_data['grandtot']=$this->input->post('grandtot');	
					/*$save_data['rtn_invoice_summary_id1']=$this->input->post('cn1');
					$save_data['rtn_invoice_summary_id2']=$this->input->post('cn2');
					$save_data['rtn_invoice_summary_id3']=$this->input->post('cn3');
					$save_data['rtn_invoice_summary_id4']=$this->input->post('cn4');*/
					
					if($this->input->post('hq_id')<>'')
					{$save_data['hq_id']=$this->input->post('hq_id');}	
					
								
					if($values['id']==0) // insert data....
					{
						$TRANTYPE=$this->input->post('status');
						
					/*$finyr=$this->general_library->get_fin_yr($save_data['invoice_date']);
						$invoice_no=$this->create_invoice_no($finyr,$TRANTYPE,
						$save_data['tbl_party_id']);
						$save_data['invoice_no']=$invoice_no;*/
						
						$this->projectmodel->save_records_model($values['id'],
						$table_name,$save_data);
						$invoiceid=$this->db->insert_id();
						$this->session->set_userdata('alert_msg',
						'One Record Inserted Successfully');
					}	
					
					if($values['id']>0)// update data....
					{
						$this->projectmodel->save_records_model($values['id'],
						$table_name,$save_data);
						$invoiceid=$values['id'];
						$this->session->set_userdata('alert_msg', 
						'One Record Updated Successfully');						
					}
			
				
				//INVOICE DETAIL DECTION
		
				$inv_details['status']=$save_data['status'];
				$inv_details['batchno']=$this->input->post('batchno');
				$inv_details['exp_monyr']=$this->input->post('exp_monyr');	
				$inv_details['mfg_monyr']=$this->input->post('mfg_monyr');	
				$inv_details['qnty']=$this->input->post('qnty');
				//$inv_details['freeqty']=$this->input->post('freeqty');	
				$inv_details['totqnty']=$inv_details['qnty'];
				$inv_details['srate']=$inv_details['rate']=$this->input->post('srate');	
				$inv_details['disc_per']=$this->input->post('disc_per');
				$inv_details['ptr']=$this->input->post('ptr');
				$inv_details['mrp']=$this->input->post('mrp');	
				$inv_details['vat_per']=$this->input->post('vat_per');
				//$inv_details['ed']=$this->input->post('ed');
				
				$totamt=$inv_details['qnty']*$inv_details['rate'];
				$inv_details['subtotal']=round($totamt,2);
				
				$inv_details['disc_amt']=$inv_details['subtotal']*
				$inv_details['disc_per']/100;
				
					
				$inv_details['invoice_summary_id']=$invoiceid;
				$inv_details['id']=$this->input->post('invoice_detail_id');
				$inv_details['product_id']=$this->input->post('product_id');
				
				$inv_details['vatamt']=
				$inv_details['totqnty']*$inv_details['mrp']*
				$this->input->post('vat_per')/100;
				
				if($inv_details['product_id']<>'')
				{
				$pieces_ids = explode("-", $inv_details['product_id']);
				$inv_details['pkg']=$pieces_ids[0];
				$inv_details['product_id']=$pieces_ids[1];
				$this->projectmodel->save_records_model($inv_details['id'],
				'invoice_details',$inv_details);
				}	
			
			
				/*$inv_details['vatamt']=
				$inv_details['totqnty']*$inv_details['mrp']*
				$this->input->post('vat_per')/100;*/
				
				$subtotal=0;
				$totvatamt=0;
				$grandtot=0;
				$tot_discount2=$tot_discount1=$tot_discount=0;
				
				$sqlqty="select SUM(subtotal) subtotal,SUM(vatamt) vatamt,
				SUM(disc_amt) disc_amt
				from invoice_details where invoice_summary_id=".$invoiceid;
				$avlqty = $this->projectmodel->get_records_from_sql($sqlqty);
				foreach ($avlqty as $rowq){	
				$subtotal=$rowq->subtotal;
				$tot_discount1=$rowq->disc_amt;
				$tot_discount2=$subtotal*$disc_per_sum/100;
				$tot_discount=$tot_discount1+$tot_discount2;
				$totvatamt=$rowq->vatamt;
				$grandtot=$subtotal-$tot_discount+$totvatamt+$freight_charge;
				}
				
				$grandtot=sprintf("%01.2f",$grandtot);
				$grandtot1=sprintf("%01.0f",$grandtot);
				$rnd=$grandtot-$grandtot1;
				$rnd=sprintf("%01.2f",$rnd);
				
				if($rnd>=.5)
				{ $grandtot=$grandtot+$rnd;	}
				else
				{ $grandtot=$grandtot-$rnd;	}
								
				$sql="update invoice_summary set 
				 total_amt='$subtotal',tot_discount='$tot_discount',
				 totvatamt='$totvatamt',grandtot='$grandtot',rndoff='$rnd' 
				 where id=".$invoiceid;
				$this->db->query($sql);
			
					
				redirect('primary_sale_controller/sell_rtn_stockist_section/addeditview/'.
				$invoiceid.'/0/');
				
		}
	  }		
	}
			
		$layout_data['data_info'] = $this->load->view($viewnamepath,$data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout', $layout_data);
		$this->session->set_userdata('alert_msg', '');	
}
	
	/*SELL RETURN SECTION END */	


/*SELL RETURN BREKEGE SECTION*/

public function sell_rtn_stockist_section_brekege($displaytype='list',$id=0)	
	 {
	 	
		$layout_data=array();
		$data=array();
		/*CHANGE HERE*/
		$viewname='sell_rtn_stockist_brekege';
		$table_name='invoice_summary';
		$redirectlist='primary_sale_controller/sell_rtn_stockist_section_brekege/'.
		$this->uri->segment(2).'/'.$displaytype.'/';
		
		$viewnamepath='primary_sale_view/transaction/'.$viewname;
		$data['product_del'] = ADMIN_BASE_URL.
		"primary_sale_controller/sell_rtn_stockist_section_brekege/";
			
		/*CHANGE HERE*/
		$data['product_addedit'] = 
		ADMIN_BASE_URL.'primary_sale_controller/sell_rtn_stockist_section_brekege/addeditview/'; 
		
		$data['INVOICE_ADJUST'] = 
		ADMIN_BASE_URL.'primary_sale_controller/sell_rtn_stockist_section_brekege/INVOICE_ADJUST/'; 
		
		$data['print_view'] = 
		ADMIN_BASE_URL.'primary_sale_controller/sell_rtn_stockist_section_brekege/print_view/'; 
		
		$where_array = array('id >' => 0);
		$data['vendorlist'] = $this->projectmodel->get_all_record('stockist',$where_array);
					
		$where_array = array('status' => 'SELL_RTN_EXP');
		$data['projectlist'] = $this->projectmodel->get_all_record('invoice_summary',
		$where_array);
						
		$where_array = array('id >' => 0,'brandtype '=> 'BRAND');
		$data['productlist'] = $this->projectmodel->get_all_record('brands',$where_array);
		$data['user_name'] = $this->session->userdata('user_name');
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
		
		//DELETE ALL 
		$data['deleteall_link'] = 
		ADMIN_BASE_URL.'primary_sale_controller/sell_rtn_stockist_section_brekege/deleteall/'; 
		
		if($displaytype=='deleteall')
		{
		$sql="delete from  invoice_details  where invoice_summary_id=".$id;
		$this->db->query($sql);	
		
		$sql="delete from  invoice_summary  where id=".$id;
		$this->db->query($sql);	
		
		$sql="update   invoice_summary set rtn_invoice_summary_id1=0 
		  where rtn_invoice_summary_id1=".$id;
		$this->db->query($sql);
		
		$sql="update   invoice_summary set rtn_invoice_summary_id2=0 
		  where rtn_invoice_summary_id2=".$id;
		$this->db->query($sql);	
		
		$sql="update   invoice_summary set rtn_invoice_summary_id3=0 
		  where rtn_invoice_summary_id3=".$id;
		$this->db->query($sql);	
		
		$sql="update   invoice_summary set rtn_invoice_summary_id4=0 
		  where rtn_invoice_summary_id4=".$id;
		$this->db->query($sql);		
		
		
		$this->session->set_userdata('alert_msg','CN has been deleted!');
							
		redirect('primary_sale_controller/sell_rtn_stockist_section_brekege/addeditview/'.
		$id.'/0/');
		}
		//DELETE ALL 
		
		
		
		if($this->uri->segment(6)=='delete')
		{
		$invoice_summary_id_del=$this->uri->segment(4);
		$invoice_detail_id_del=$this->uri->segment(5);
		$transaction_status=$this->uri->segment(6);
		$sql="delete from invoice_details  where id=".$invoice_detail_id_del;
		$this->db->query($sql);
		
		$sqlqty="select * 
		from invoice_summary where id=".$invoice_summary_id_del;
		$avlqty = $this->projectmodel->get_records_from_sql($sqlqty);
		foreach ($avlqty as $rowq)
		{	
		$disc_per=$rowq->disc_per;
		$tbl_party_id=$rowq->tbl_party_id;
		}	
		$sqlqty="select * from stockist where id=".$tbl_party_id;
		$avlqty = $this->projectmodel->get_records_from_sql($sqlqty);
		foreach ($avlqty as $rowq)
		{$BILL_TYPE=$rowq->BILL_TYPE;}		
		
		$this->update_invoice_sum_table($invoice_summary_id_del,$disc_per=0,$BILL_TYPE);
														
		redirect('primary_sale_controller/sell_rtn_stockist_section_brekege/addeditview/'.
		$invoice_summary_id_del.'/0/');
		
		}
		
		
		
		
		if($displaytype=='INVOICE_ADJUST')
		{
		  $invoice_summary_id=$this->uri->segment(4);
		  $transaction_status=$this->uri->segment(6);
				
			if($transaction_status=='delete_invoice')
			{
				$sell_invoice_id=$this->uri->segment(5);
				//SC/C/0346/16-17 
				  $query ="update  invoice_summary set
				  rtn_invoice_summary_id1=0, total_adjust_amt=0 where 
				  id=".$sell_invoice_id; 
				  $this->db->query($query);			
				
			}
			else
			{
			
			$invoice_for_adjust=
			$this->input->post('invoice_for_adjust');
			
			$available_balance_to_adjust=
			$this->input->post('available_balance_to_adjust');
			
			 $query ="update  invoice_summary set
			  rtn_invoice_summary_id1=".$invoice_summary_id.",
			  total_adjust_amt=".$available_balance_to_adjust." where 
			  id=".$invoice_for_adjust; 
			  $this->db->query($query);			
			
			}
												
		redirect('primary_sale_controller/sell_rtn_stockist_section_brekege/addeditview/'.
		$invoice_summary_id.'/0/');
		
		}
		
		
		
						
		if($displaytype=='list')
				{
					$data['records']="";
					$data['productid'] ="0";
					//redirect('primary_sale_controller/purchase_section/list/');
				}
		if($displaytype=='addeditview')
				{
					
					$where_array = array('id' => $id);
					$data['records'] = 
					$this->projectmodel->get_all_record($table_name,$where_array);
					$data['productid'] =$id;
				}
		if($displaytype=='addedit') //add --update
				{
			$where_array = array('id' => $id);
			$data['records'] = 
			$this->projectmodel->get_all_record($table_name,$where_array);			
			$data['productid'] =$id;
			
			// add edit section start
			if(isset($_POST))
			{	
				
				$values=$this->input->post();
				$data['productid'] =$values['id'];
				$TRANTYPE=$this->input->post('status');
				$invoice_summary_id=$this->input->post('id');
				$invoice_details_id=$this->input->post('invoice_details_id');
					
			//if($TRANTYPE<>'SELL')
			//{
			$this->form_validation->set_rules('invoice_no','Invoice No','required');
			$this->form_validation->set_rules('invoice_date','Invoice Date','required');
			$this->form_validation->set_rules('tbl_party_id','Party Name','required');
				
			if($this->form_validation->run()==FALSE )
			{
				$this->session->set_userdata('alert_msg', validation_errors());
				redirect('primary_sale_controller/sell_rtn_stockist_section_brekege/'.
						$invoice_summary_id.'/'.$invoice_details_id.'/');
			}
			else  //validation pass
			{
				
					$save_data['id']=$this->input->post('id');
					$save_data['status']=$this->input->post('status');
					
					$save_data['invoice_no']=$this->input->post('invoice_no');
					$save_data['invoice_date']=$this->input->post('invoice_date');
					$save_data['challan_no']=$this->input->post('challan_no');	
					$save_data['challan_date']=$this->input->post('challan_date');	
					$save_data['orderno']=$this->input->post('orderno');	
					$save_data['orderdate']=$this->input->post('orderdate');	
					$save_data['trno']=$this->input->post('trno');	
					$save_data['trdate']=$this->input->post('trdate');						
					$save_data['tbl_party_id']=$this->input->post('tbl_party_id');
					$save_data['vehicle_no']=$this->input->post('vehicle_no');
					$save_data['comment']=$this->input->post('comment');
					$save_data['product_type']=$this->input->post('product_type');
									
					$save_data['total_amt']=$this->input->post('total_amt');	
					$disc_per_sum=$save_data['disc_per']=$this->input->post('disc_per');	
					$save_data['tot_discount']=$this->input->post('tot_discount');	
					$save_data['totvatamt']=$this->input->post('totvatamt');	
					$save_data['grandtot']=$this->input->post('grandtot');	
					
					if($this->input->post('hq_id')<>'')
					{$save_data['hq_id']=$this->input->post('hq_id');}	
					
				/*	$save_data['rtn_invoice_summary_id1']=$this->input->post('cn1');
					$save_data['rtn_invoice_summary_id2']=$this->input->post('cn2');
					$save_data['rtn_invoice_summary_id3']=$this->input->post('cn3');
					$save_data['rtn_invoice_summary_id4']=$this->input->post('cn4');*/
										
					if($values['id']==0) // insert data....
					{
						$TRANTYPE=$this->input->post('status');
						
						/*$finyr=$this->general_library->get_fin_yr($save_data['invoice_date']);
						$invoice_no=$this->create_invoice_no($finyr,'SELL_RTN',
						$save_data['tbl_party_id']);
						$save_data['invoice_no']=$invoice_no;*/
						
						$this->projectmodel->save_records_model($values['id'],
						$table_name,$save_data);
						$invoiceid=$this->db->insert_id();
						$this->session->set_userdata('alert_msg',
						'One Record Inserted Successfully');
					}	
					
					if($values['id']>0)// update data....
					{
						$this->projectmodel->save_records_model($values['id'],
						$table_name,$save_data);
						$invoiceid=$values['id'];
						$this->session->set_userdata('alert_msg', 
						'One Record Updated Successfully');						
					}
			
				
				//INVOICE DETAIL DECTION
		
				$inv_details['status']=$save_data['status'];
				$inv_details['batchno']=$this->input->post('batchno');
				$inv_details['exp_monyr']=$this->input->post('exp_monyr');	
				$inv_details['mfg_monyr']=$this->input->post('mfg_monyr');	
				$inv_details['qnty']=$this->input->post('qnty');
				//$inv_details['freeqty']=$this->input->post('freeqty');	
				$inv_details['totqnty']=$inv_details['qnty'];
				$inv_details['srate']=$inv_details['rate']=$this->input->post('srate');	
				$inv_details['disc_per']=$this->input->post('disc_per');
				$inv_details['ptr']=$this->input->post('ptr');
				$inv_details['mrp']=$this->input->post('mrp');	
				$inv_details['vat_per']=$this->input->post('vat_per');
				//$inv_details['ed']=$this->input->post('ed');
				
				$totamt=$inv_details['qnty']*$inv_details['rate'];
				$inv_details['subtotal']=round($totamt,2);
				
				$inv_details['disc_amt']=$inv_details['subtotal']*
				$inv_details['disc_per']/100;
				
					
				$inv_details['invoice_summary_id']=$invoiceid;
				$inv_details['id']=$this->input->post('invoice_detail_id');
				$inv_details['product_id']=$this->input->post('product_id');
				
				$inv_details['vatamt']=
				$inv_details['totqnty']*$inv_details['mrp']*
				$this->input->post('vat_per')/100;
				
				if($inv_details['product_id']<>'')
				{
				$pieces_ids = explode("-", $inv_details['product_id']);
				$inv_details['pkg']=$pieces_ids[0];
				$inv_details['product_id']=$pieces_ids[1];
				$this->projectmodel->save_records_model($inv_details['id'],
				'invoice_details',$inv_details);
				}	
			
			
				/*$inv_details['vatamt']=
				$inv_details['totqnty']*$inv_details['mrp']*
				$this->input->post('vat_per')/100;*/
				
				$subtotal=0;
				$totvatamt=0;
				$grandtot=0;
				$tot_discount2=$tot_discount1=$tot_discount=0;
				
				$sqlqty="select SUM(subtotal) subtotal,SUM(vatamt) vatamt,
				SUM(disc_amt) disc_amt
				from invoice_details where invoice_summary_id=".$invoiceid;
				$avlqty = $this->projectmodel->get_records_from_sql($sqlqty);
				foreach ($avlqty as $rowq){	
				$subtotal=$rowq->subtotal;
				$tot_discount1=$rowq->disc_amt;
				$tot_discount2=0;
				$tot_discount=$tot_discount1+$tot_discount2;
				$totvatamt=$rowq->vatamt;
				$grandtot=$subtotal-$tot_discount+$totvatamt;
				}
				
				$grandtot=sprintf("%01.2f",$grandtot);
				$grandtot1=sprintf("%01.0f",$grandtot);
				$rnd=$grandtot-$grandtot1;
				$rnd=sprintf("%01.2f",$rnd);
				
				if($rnd>=.5)
				{ $grandtot=$grandtot+$rnd;	}
				else
				{ $grandtot=$grandtot-$rnd;	}
								
				$sql="update invoice_summary set 
				 total_amt='$subtotal',tot_discount='$tot_discount',
				 totvatamt='$totvatamt',grandtot='$grandtot',rndoff='$rnd' 
				 where id=".$invoiceid;
				$this->db->query($sql);
			
					
				redirect('primary_sale_controller/sell_rtn_stockist_section_brekege/addeditview/'.
				$invoiceid.'/0/');
				
		}
	  }		
	}
			
		$layout_data['data_info'] = $this->load->view($viewnamepath,$data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout', $layout_data);
		$this->session->set_userdata('alert_msg', '');	
}
	
	/*SELL RETURN BREKEGE SECTION END */	

	
		
	//Barcode generation function, using Zend library
     function barcode($visitor_id) 
     {
        $this->load->library('zend');
        $this->load->library('Zend/Barcode');
        Zend_Barcode::render('code39', 'image', array('text' => $visitor_id), array());
     } 
	 //End of Barcode generation function
	 
	 	

	/*LOGIN PROCESS */	
	public function index($msg='')
	{	
	$layout_data = array();
	$data = array();
	$layout_date['body'] = $this->load->view('login',$data,true);
	$this->load->view('login', $layout_date);
	}
	
	public function login_process(){
      
        // Validate the user can login
        $result = $this->projectmodel->validate();
        // Now we verify the result
        if(! $result){
            // If user did not validate, then show them login page again
            $this->index();
        }else{
            // If user did validate, 
            // Send them to members area
			
           //$this->home();		   
		   $this->dashboard();
        }    		
    }
	
	private function home()
	{
		$layout_data = array();
		$data = array();
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
		$layout_data['data_info'] = $this->load->view('adminindex', $data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout', $layout_data);
	}
	
	public function logout(){
		$this->projectmodel->logout(); 
	}
	
	/*LOGIN PROCESS END*/	
	
	
	
/*INVOICE SECTION */


	
	public function invoice_purchase_ajax()
	{
		//echo $this->input->post('barcodeval');
		$data_list['ajaxname'] ='PURCHASE';
		 $data_list['product_id'] =$this->input->post('productid');
		 $data_list['fldsrl'] =$this->input->post('fldsrl');
		$this->load->view('primary_sale_view/ajax_view', $data_list);
	
	}
	
	public function invoice_sellrtn_ajax()
	{
		//echo $this->input->post('barcodeval');
		 $data_list['ajaxname'] ='SELL_RTN';
		 $data_list['batchno'] =$this->input->post('batchno');
		 $data_list['product_id'] =$this->input->post('productid');
		 $data_list['fldsrl'] =$this->input->post('fldsrl');
		$this->load->view('primary_sale_view/ajax_view', $data_list);
	
	}
		
	
	
	public function invoice_srtn_ajax()
	{
	//echo $this->input->post('barcodeval');
	$data_list['ajaxname'] ='SALE_RTN';
	$data_list['batchno'] =$this->input->post('batchno');
	$data_list['product_id'] =$this->input->post('productid');
	$data_list['fldsrl'] =$this->input->post('fldsrl');
	$data_list['tbl_party_id'] =$this->input->post('tbl_party_id');
	
	$this->load->view('primary_sale_view/ajax_view', $data_list);
	}	
	
	
	
	public function invoice_ajax()
	{
	//echo $this->input->post('barcodeval');
	$data_list['ajaxname'] ='SALE';
	$data_list['batchno'] =$this->input->post('batchno');
	$data_list['product_id'] =$this->input->post('productid');
	$data_list['fldsrl'] =$this->input->post('fldsrl');
	$this->load->view('primary_sale_view/ajax_view', $data_list);
	}
	
	public function ajax_prchs_rtn()
	{
	//echo $this->input->post('barcodeval');
	$data_list['ajaxname'] ='PRCHS_RTN';
	$data_list['barcodeval'] =$this->input->post('barcodeval');
	$data_list['fldsrl'] =$this->input->post('fldsrl');
	$this->load->view('primary_sale_view/ajax_view', $data_list);
	}
	
	public function ajax_sell_rtn()
	{
	//echo $this->input->post('barcodeval');
	$data_list['ajaxname'] ='SELL_RTN';
	$data_list['barcodeval'] =$this->input->post('barcodeval');
	$data_list['fldsrl'] =$this->input->post('fldsrl');
	$this->load->view('primary_sale_view/ajax_view', $data_list);
	}
	
	
	
	
	 /*Invoice details start */

	
		 
	
		 
	 /*Invoice details end */
	
	
	public function lookup(){  
        // process posted form data  
        $keyword = $this->input->post('term');  
		echo $keyword;
		
        $data['response'] = 'false'; //Set default response  
        $query = $this->Product_model->lookup($keyword); //Search DB  
        if( ! empty($query) )  
        {  
            $data['response'] = 'true'; //Set response  
            $data['message'] = array(); //Create array  
            foreach( $query as $row )  
            {  
                $data['message'][] = array(   
                                        'id'=>$row->id,  
                                        'value' => $row->rcv_exp_name,  
                                        ''  
                                     );  //Add a row to array  
            }  
        }  
        if('IS_AJAX')  
        {  
            echo json_encode($data); //echo json string if ajax request  
               
        }  
       /* else  
        {  
            $this->load->view('autocomplete/index',$data); //Load html view of search results  
        }  */
		
    }  
	
	
	
		
	 
	
	/*Product Section*/
	public function productlisting($page='',$msg='')	
	 {
	 	$layout_data=array();
		$data=array();
		
		$data['user_name'] = $this->session->userdata('user_name');
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
		//$data['productlist'] = $this->productmodel->productlisting();
		//$data['productlist'] = $this->projectmodel->get_all_record('p_product');
		
		$where_array = array('id >' => 0);
		$data['productlist'] = $this->projectmodel->get_all_record('p_product',$where_array);
		
		if($this->uri->segment(3)<>'')
		{
		$data['records'] = $this->projectmodel->get_single_record('p_product',$this->uri->segment(3));
		//$data['records'] = $this->productmodel->productlisting($this->uri->segment(3));
		
			$data['productid'] =$this->uri->segment(3);
			$data['datalistdisplay'] ='N';
		}
		else
		{
			$data['records']="";
			$data['productid'] ="0";
			$data['datalistdisplay'] ='Y';
		}
				
		$data['product_addedit'] = ADMIN_BASE_URL."product/productlisting/"; 
		// product class->addedit_product function
		$data['product_del'] = ADMIN_BASE_URL."product/delete_record_controller/";
		// product class->delete_product function
		
		$layout_data['data_info'] = $this->load->view('primary_sale_view/productlist', $data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout', $layout_data);
		$this->session->set_userdata('alert_msg', '');	
		
	 }
	  	
	
	/*Party  Section*/
	public function party_listing($page='',$msg='')	
	 {
	 	$layout_data=array();
		$data=array();
		/*CHANGE HERE*/
		$table_name='tbl_party';
		
		$data['user_name'] = $this->session->userdata('user_name');
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
		$where_array = array('id >' => 0);
		$data['projectlist'] = $this->projectmodel->get_all_record($table_name,$where_array);
		
		if($this->uri->segment(3)<>'')
		{
			$data['records'] = $this->projectmodel->get_single_record($table_name,$this->uri->segment(3));
			//$data['records'] = $this->productmodel->productlisting($this->uri->segment(3));
			$data['productid'] =$this->uri->segment(3);
			$data['datalistdisplay'] ='N';
		}
		else
		{
			$data['records']="";
			$data['productid'] ="0";
			$data['datalistdisplay'] ='Y';
		}
				
		
         $data['product_del'] = ADMIN_BASE_URL."primary_sale_controller/delete_record_controller/";
		// product class->delete_product function
		
		/*CHANGE HERE*/
		$data['product_addedit'] = ADMIN_BASE_URL."primary_sale_controller/party_listing/"; 
		
		// product class->addedit_product function
		$layout_data['data_info'] = $this->load->view('primary_sale_view/partyview',$data, true);
		
		//$layout_data['data_info'] = $this->load->view('primary_sale_view/productlist', $data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout', $layout_data);
		$this->session->set_userdata('alert_msg', '');	
		
	 }
	 	 
		 
		 
		 
	 public function party_save_records_controller()
		{	
			
			if(isset($_POST))
			{	
				
				$layout_data=array();
				$data=array();
				$save_data=array();
				/*CHANGE HERE*/
				$table_name='tbl_party';
				$redirectlist='party_listing/';
				
				$data['user_name'] = $this->session->userdata('user_name');
				$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
				$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
				$data['productid'] =$this->uri->segment(3);
				$data['datalistdisplay'] ='N';
				
				//print_r($this->input->post());
				$values=$this->input->post();
				$data['productid'] =$values['id'];
				
				/*CHANGE HERE*/
				
				if($values['id']==0) // insert data....
					{
					$this->form_validation->set_rules('party_name','party_name ','required|is_unique[tbl_party.party_name]');
					}
					else
					{
					$this->form_validation->set_rules('party_name','party_name ','required');					
					}
				
				$this->form_validation->set_rules('billing_party','Billing Party','required');
				$this->form_validation->set_rules('status','status','required');
				
				
				/*$this->form_validation->set_rules('address','address','required');
				$this->form_validation->set_rules('contact_person','contact_person','required');
				$this->form_validation->set_rules('contact_no','contact_no','required');*/
				
				
				if($this->form_validation->run()==FALSE )
				{
					$this->session->set_userdata('alert_msg', validation_errors());
					redirect('primary_sale_controller/'.$redirectlist.$values['id']);
				}
				else  //validation pass
				{
				
					$save_data['id']=$this->input->post('id');
					
					/*CHANGE HERE*/
					$save_data['party_name']=$this->input->post('party_name');
					$save_data['billing_party']=$this->input->post('billing_party');
					$save_data['address']=$this->input->post('address');
					$save_data['contact_person']=$this->input->post('contact_person');
					$save_data['contact_no']=$this->input->post('contact_no');
					$save_data['city1']=$this->input->post('city1');
					$save_data['pin1']=$this->input->post('pin1');
					$save_data['address2']=$this->input->post('address2');
					$save_data['city2']=$this->input->post('city2');
					$save_data['pin2']=$this->input->post('pin2');
					$save_data['mobno']=$this->input->post('mobno');
					$save_data['contact_person2']=$this->input->post('contact_person2');
					$save_data['status']=$this->input->post('status');
					
									
					if($values['id']==0) // insert data....
					{
						$this->projectmodel->save_records_model($values['id'],$table_name,$save_data);
						$this->session->set_userdata('alert_msg', 'One Record Inserted Successfully');
						redirect('primary_sale_controller/'.$redirectlist);
					}
					if($values['id']>0)// update data....
					{
						$this->projectmodel->save_records_model($values['id'],$table_name,$save_data);
						$this->session->set_userdata('alert_msg', 'One Record Updated Successfully');
						redirect('primary_sale_controller/'.$redirectlist);		
						
					}
					
					//$this->productlisting();
			  }		
		}
		
		
	 }

	/*Party Section End*/	 

	 
 /*Master Receive-Exp  Section*/
 
	public function mst_rcvexp_listing($page='',$msg='')	
	 {
	 	$layout_data=array();
		$data=array();
		/*CHANGE HERE*/
		$table_name='mst_rcv_exp';
		
		$data['user_name'] = $this->session->userdata('user_name');
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
		$where_array = array('id >' => 0);
		$data['projectlist'] = $this->projectmodel->get_all_record($table_name,$where_array);
		
		if($this->uri->segment(3)<>'')
		{
			$data['records'] = $this->projectmodel->get_single_record($table_name,$this->uri->segment(3));
			//$data['records'] = $this->productmodel->productlisting($this->uri->segment(3));
			$data['productid'] =$this->uri->segment(3);
			$data['datalistdisplay'] ='N';
		}
		else
		{
			$data['records']="";
			$data['productid'] ="0";
			$data['datalistdisplay'] ='Y';
		}
				
		
         $data['product_del'] = ADMIN_BASE_URL."primary_sale_controller/delete_record_controller/";
		// product class->delete_product function
		
		/*CHANGE HERE*/
		$data['product_addedit'] = ADMIN_BASE_URL."primary_sale_controller/mst_rcvexp_listing/"; 
		
		// product class->addedit_product function
		$layout_data['data_info'] = $this->load->view('primary_sale_view/mst_rcvexp_view',$data, true);
		
		//$layout_data['data_info'] = $this->load->view('primary_sale_view/productlist', $data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout', $layout_data);
		$this->session->set_userdata('alert_msg', '');	
		
	 }
	 	 
	 public function mst_rcvexp_save_records_controller()
		{	
			
			if(isset($_POST))
			{	
				
				$layout_data=array();
				$data=array();
				$save_data=array();
				/*CHANGE HERE*/
				$table_name='mst_rcv_exp';
				$redirectlist='mst_rcvexp_listing/';
				
				$data['user_name'] = $this->session->userdata('user_name');
				$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
				$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
				$data['productid'] =$this->uri->segment(3);
				$data['datalistdisplay'] ='N';
				
				//print_r($this->input->post());
				$values=$this->input->post();
				$data['productid'] =$values['id'];
				
				/*CHANGE HERE*/
				$this->form_validation->set_rules('rcv_exp_name','Name','required');
				$this->form_validation->set_rules('rcv_exp_substatus','Sub Status','required');
				$this->form_validation->set_rules('status','Status','required');
				//$this->form_validation->set_rules('contact_no','contact_no','required');
				
				
				if($this->form_validation->run()==FALSE )
				{
					$this->session->set_userdata('alert_msg', validation_errors());
					redirect('primary_sale_controller/'.$redirectlist.$values['id']);
				}
				else  //validation pass
				{
				
					$save_data['id']=$this->input->post('id');
					
					/*CHANGE HERE*/
					$save_data['rcv_exp_name']=$this->input->post('rcv_exp_name');
					$save_data['rcv_exp_substatus']=$this->input->post('rcv_exp_substatus');
					$save_data['status']=$this->input->post('status');
										
									
					if($values['id']==0) // insert data....
					{
						$this->projectmodel->save_records_model($values['id'],$table_name,$save_data);
						$this->session->set_userdata('alert_msg', 'One Record Inserted Successfully');
						redirect('primary_sale_controller/'.$redirectlist);
					}
					if($values['id']>0)// update data....
					{
						$this->projectmodel->save_records_model($values['id'],$table_name,$save_data);
						$this->session->set_userdata('alert_msg', 'One Record Updated Successfully');
						redirect('primary_sale_controller/'.$redirectlist);		
						
					}
					
					//$this->productlisting();
			  }		
		}
		
		
	 }

	 /*Master Receive-Exp  Section End*/

	 
	

	 
	 
	

	
	 /*Transaction Rcv-expense */
 
	public function trn_rcvexp_listing($page='',$msg='')	
	 {
	 	$layout_data=array();
		$data=array();
		/*CHANGE HERE*/
		$table_name='trn_rcv_expense';
		$redirectlist='trn_rcvexp_listing/';
		$viewname='trn_rcv_view';
		
		$data['user_name'] = $this->session->userdata('user_name');
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
		$where_array = array('id >' => 0);
		$data['projectlist'] = $this->projectmodel->get_all_record($table_name,$where_array);
		
		if($this->uri->segment(3)<>'')
		{
			$data['records'] = $this->projectmodel->get_single_record($table_name,$this->uri->segment(3));
			//$data['records'] = $this->productmodel->productlisting($this->uri->segment(3));
			$data['productid'] =$this->uri->segment(3);
			$data['datalistdisplay'] ='N';
		}
		else
		{
			$data['records']="";
			$data['productid'] ="0";
			$data['datalistdisplay'] ='Y';
		}
				
		
         $data['product_del'] = ADMIN_BASE_URL."primary_sale_controller/delete_record_controller/";
		// product class->delete_product function
		
		/*CHANGE HERE*/
		$data['product_addedit'] = ADMIN_BASE_URL."primary_sale_controller/".$redirectlist; 
		// product class->addedit_product function
		$layout_data['data_info'] = $this->load->view('primary_sale_view/'.$viewname,$data, true);
		
		//$layout_data['data_info'] = $this->load->view('primary_sale_view/productlist', $data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout', $layout_data);
		$this->session->set_userdata('alert_msg', '');	
		
	 }
	 	 
	 public function trn_rcvexp_save_records_controller()
		{	
			
			if(isset($_POST))
			{	
				
				$layout_data=array();
				$data=array();
				$save_data=array();
				
				/*CHANGE HERE*/
				$table_name='trn_rcv_expense';
				$redirectlist='trn_rcvexp_listing/';
				$viewname='trn_rcv_view';
				
				$data['user_name'] = $this->session->userdata('user_name');
				$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
				$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
				$data['productid'] =$this->uri->segment(3);
				$data['datalistdisplay'] ='N';
				
				//print_r($this->input->post());
				$values=$this->input->post();
				$data['productid'] =$values['id'];
				
				/*CHANGE HERE*/
				$this->form_validation->set_rules('mst_rcv_exp_id','Transaction Name','required');
				//$this->form_validation->set_rules('rcv_exp_substatus','Sub Status','required');
			
				
				
				
				if($this->form_validation->run()==FALSE )
				{
					$this->session->set_userdata('alert_msg', validation_errors());
					redirect('primary_sale_controller/'.$redirectlist.$values['id']);
				}
				else  //validation pass
				{
				
					$save_data['id']=$this->input->post('id');
					
					/*CHANGE HERE*/
					$save_data['lorry_no']=$this->input->post('lorry_no');
					$save_data['description']=$this->input->post('description');
					$save_data['driver_name']=$this->input->post('driver_name');
					$save_data['contact_no']=$this->input->post('contact_no');
														
									
					if($values['id']==0) // insert data....
					{
						$this->projectmodel->save_records_model($values['id'],$table_name,$save_data);
						$this->session->set_userdata('alert_msg', 'One Record Inserted Successfully');
						redirect('primary_sale_controller/'.$redirectlist);
					}
					if($values['id']>0)// update data....
					{
						$this->projectmodel->save_records_model($values['id'],$table_name,$save_data);
						$this->session->set_userdata('alert_msg', 'One Record Updated Successfully');
						redirect('primary_sale_controller/'.$redirectlist);		
						
					}
			  	}		
			}
				
		 }

	 /*Transaction Rcv-expense  End*/
	
	
	 /*Transaction Payment section   */
	 
public function payment_section($viewname='',
$table_name='',$displaytype='list',$id=0)	
	 {
	 	
		$layout_data=array();
		$data=array();
		/*CHANGE HERE*/
		//$table_name='purchase_header';
		$redirectlist='primary_sale_controller/'.$this->uri->segment(2).'/'.$viewname.'/'.
		$table_name.'/'.$displaytype.'/'.$id.'/';
		$viewnamepath='primary_sale_view/transaction/'.$viewname;
		
		$data['product_del'] = ADMIN_BASE_URL.
		"primary_sale_controller/delete_record_controller/";
		// product class->delete_product function
		
		/*CHANGE HERE*/
		$data['product_addedit'] = ADMIN_BASE_URL.'primary_sale_controller/'.$this->uri->segment(2).'/'.$viewname.'/'.$table_name.'/'; 
		
		$sqlinv="select * from  acc_group_ledgers 
		where acc_type='LEDGER'	and parent_id in 
		(select id from acc_group_ledgers where VOUCHER_TYPE='CASH_ACCOUNT' 
		or VOUCHER_TYPE='BANK_ACCOUNT') order by  acc_name ";
		$data['ledger_account1'] =$this->projectmodel->get_records_from_sql($sqlinv);
		
		$where_array = array('status' => 'Expense');
		$data['rcv_exp_master'] = $this->projectmodel->get_all_record('mst_rcv_exp',$where_array);
					
		$data['user_name'] = $this->session->userdata('user_name');
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
		
		
			$sql="select a.tbl_party_id,a.broker_id,a.id,b.rcv_exp_name 
			rcvexpname,a.rcpt_amt rcpt_amt,a.paydate paydate 
		    from trn_rcv_expense a, mst_rcv_exp b 
		    where a.mst_rcv_exp_id=b.id and b.status='Expense'  order by a.id ";
		
		   $data['projectlist'] = $this->projectmodel->get_records_from_sql($sql);
						
				if($displaytype=='list')
				{
					$data['records']="";
					$data['productid'] ="0";
				}
				if($displaytype=='addeditview')
				{
					$where_array = array('id' => $id);
					$data['records'] = 
					$this->projectmodel->get_all_record($table_name,$where_array);
					$data['productid'] =$id;
				}
				
				if($displaytype=='addedit') //add --update
				{
					$where_array = array('id' => $id);
					$data['records'] = 
					$this->projectmodel->get_all_record($table_name,$where_array);
					$data['productid'] =$id;
					
					// add edit section start
					
					if(isset($_POST))
					{	
				
				$values=$this->input->post();
				$data['productid'] =$values['id'];
				//echo $data['productid'];
				$this->form_validation->set_rules('mst_rcv_exp_id','Payment Name',
				'required');
				$this->form_validation->set_rules('tbl_party_id','Vendor name','required');
				$this->form_validation->set_rules('rcpt_amt','Payment Amount','required');
				$this->form_validation->set_rules('paydate','Payment Date','required');
								
				if($this->form_validation->run()==FALSE )
				{
					$this->session->set_userdata('alert_msg', validation_errors());
					redirect('primary_sale_controller/payment_section/trn_pay_vendor_view/trn_rcv_expense/list/0');
				}
				else  //validation pass
				{
				
					$save_data['id']=$this->input->post('id');
					
					$save_data['mst_rcv_exp_id']=$this->input->post('mst_rcv_exp_id');
					$save_data['tbl_party_id']=$this->input->post('tbl_party_id');
					$save_data['paydate']=$this->input->post('paydate');
					$save_data['chqdate']=$this->input->post('chqdate');
					$save_data['bankname']=$this->input->post('bankname');
					$save_data['chqno']=$this->input->post('chqno');
					$save_data['transaction_desc']=$this->input->post('transaction_desc');
					$save_data['rcv_exp_name']=$this->input->post('rcv_exp_name');
					$save_data['broker_id']=$this->input->post('broker_id');
					$save_data['status']=$this->input->post('status');
					$save_data['rcpt_amt']=$this->input->post('rcpt_amt');
					$save_data['paymode']=$this->input->post('paymode');
					$save_data['chqstatus']=$this->input->post('chqstatus');
					
					$save_data['ledger_account_header']=
					$this->input->post('ledger_account_header');

					
					if($save_data['paymode']=='Cash' or $save_data['paymode']=='NEFT-RTGS')
					{$save_data['chqstatus']='CLEAR';}		
					
					$id_header='';						
					if($values['id']==0) // insert data....
					{
			$this->projectmodel->save_records_model($values['id'],$table_name,$save_data);
			$id_header=$this->db->insert_id();
			$this->session->set_userdata('alert_msg', 'One Record Inserted Successfully');
					}
					if($values['id']>0)// update data....
					{
			$this->projectmodel->save_records_model($values['id'],$table_name,$save_data);
			$id_header=$values['id'];
			$this->session->set_userdata('alert_msg', 'One Record Updated Successfully');
					}
			echo $id_header.' tt';			
			$this->accounts_model->ledger_transactions($id_header,'Expense');
					
				/*	redirect('primary_sale_controller/payment_section/trn_pay_vendor_view/trn_rcv_expense/list/0');*/
					
				  		}		
					}
					// add edit section end
					
				}
      			//echo $displaytype;
				if($displaytype=='del') //add --update
				{
					$query ="delete from trn_rcv_expense WHERE id=".$id;;
					$this->db->query($query);
					$query ="delete from trn_rcv_expense_details 
					WHERE trn_rcv_expense_id=".$id;
					$this->db->query($query);	
					
					$this->accounts_model->ledger_transactions_delete($id,'Expense');
					
				$this->session->set_userdata('alert_msg', 'One Record Deleted Successfully');
				redirect('primary_sale_controller/payment_section/trn_pay_vendor_view/trn_rcv_expense/list/0');	
				}
		
		// product class->addedit_product function
		$layout_data['data_info'] = $this->load->view($viewnamepath,$data, true);
		
		//$layout_data['data_info'] = $this->load->view('primary_sale_view/productlist', $data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout', $layout_data);
		$this->session->set_userdata('alert_msg', '');	
		
	 }
	
	 
/*Transaction Payment section  end */
	
		
	
/*Transaction Rcv section */
 
public function rcv_section($viewname='',$table_name='',
	$displaytype='list',$id=0,$stockistid=0,$trantype=0)	
	 {
	 	
		$layout_data=array();
		$data=array();
		/*CHANGE HERE*/
		//$table_name='purchase_header';
		$redirectlist='primary_sale_controller/'.$this->uri->segment(2).'/'.$viewname.'/'.$table_name.'/'.$displaytype.'/'.$id.'/';
		$viewnamepath='primary_sale_view/transaction/'.$viewname;
		$data['product_del'] = ADMIN_BASE_URL."primary_sale_controller/delete_record_controller/";
		// product class->delete_product function
		
		$sqlinv="select * from  acc_group_ledgers 
		where acc_type='LEDGER'	and parent_id in 
		(select id from acc_group_ledgers where VOUCHER_TYPE='CASH_ACCOUNT' 
		or VOUCHER_TYPE='BANK_ACCOUNT') order by  acc_name ";
		$data['ledger_account1'] =$this->projectmodel->get_records_from_sql($sqlinv);
		
		
		/*CHANGE HERE*/
		$data['product_addedit'] = ADMIN_BASE_URL.'primary_sale_controller/'.$this->uri->segment(2).'/'.$viewname.'/'.$table_name.'/'; 
		
		$data['record_delete'] = ADMIN_BASE_URL.'primary_sale_controller/rcv_section/trn_rcv_view/trn_rcv_expense/del/'; 
				
		$where_array = array('status' => 'Receive');
		$data['rcv_exp_master'] = $this->projectmodel->get_all_record('mst_rcv_exp',$where_array);
					
		$data['user_name'] = $this->session->userdata('user_name');
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
		
			
		$sql="select a.tbl_party_id,a.id,b.rcv_exp_name rcvexpname,a.rcpt_amt 	
		rcpt_amt,a.paydate paydate,a.invoice_summary_id invoice_summary_id 
		from trn_rcv_expense a, mst_rcv_exp b 
		where a.mst_rcv_exp_id=b.id and b.status='Receive' order by a.paydate,a.id  ";
		
		$data['projectlist'] = $this->projectmodel->get_records_from_sql($sql);
		
				
				if($displaytype=='list')
				{
					$data['records']="";
					$data['productid'] ="0";
				}
				if($displaytype=='addeditview')
				{
					$where_array = array('id' => $id);
					$data['records'] = 
					$this->projectmodel->get_all_record($table_name,$where_array);
					//$data['records'] = $this->projectmodel->get_single_record($table_name,$id);
					$data['productid'] =$id;
				}
				
				if($displaytype=='del')
				{
					$query ="delete from trn_rcv_expense WHERE id=".$id;;
					$this->db->query($query);
					$query ="delete from trn_rcv_expense_details 
					WHERE trn_rcv_expense_id=".$id;
					$this->db->query($query);	
					$this->accounts_model->ledger_transactions_delete($id,'Receive');
					
				}
								
				if($displaytype=='addedit') //add --update
				{
					$where_array = array('id' => $id);
					$data['records'] = 
					$this->projectmodel->get_all_record($table_name,$where_array);
					$data['productid'] =$id;
										
					if(isset($_POST))
					{	
				
				$values=$this->input->post();
				$data['productid'] =$values['id'];
				//echo $data['productid'];
				$this->form_validation->set_rules('mst_rcv_exp_id','Receive name','required');
				$this->form_validation->set_rules('tbl_party_id','Party Name','required');
				$this->form_validation->set_rules('rcpt_amt','Receipt Amount','required');
				$this->form_validation->set_rules('paydate','Receive Date','required');
				//$this->form_validation->set_rules('invoice_summary_id','Invoice','required');
						
				
				if($this->form_validation->run()==FALSE )
				{
					$this->session->set_userdata('alert_msg', validation_errors());
					redirect('primary_sale_controller/rcv_section/trn_rcv_view/trn_rcv_expense/list/0');
				}
				else  //validation pass
				{
				
					$save_data['id']=$this->input->post('id');
					
					$save_data['mst_rcv_exp_id']=$this->input->post('mst_rcv_exp_id');
					$save_data['tbl_party_id']=$this->input->post('tbl_party_id');
					$save_data['paydate']=$this->input->post('paydate');
					$save_data['rcpt_amt']=$this->input->post('rcpt_amt');
					$save_data['chqdate']=$this->input->post('chqdate');
					$save_data['bankname']=$this->input->post('bankname');
					$save_data['chqno']=$this->input->post('chqno');
					$save_data['transaction_desc']=$this->input->post('transaction_desc');
					$save_data['rcv_exp_name']=$this->input->post('rcv_exp_name');
					$save_data['status']=$this->input->post('status');
					$save_data['paymode']=$this->input->post('paymode');
					$save_data['ledger_account_header']=
					$this->input->post('ledger_account_header');
					
					//$save_data['invoice_summary_id']=$this->input->post('invoice_summary_id');
					
					$save_data['chqstatus']=$this->input->post('chqstatus');					
					if($save_data['paymode']=='Cash' or $save_data['paymode']=='NEFT-RTGS')
					{$save_data['chqstatus']='CLEAR';}		
														
									
					if($values['id']==0) // insert data....
					{
						$this->projectmodel->save_records_model($values['id'],
						$table_name,$save_data);
						$receipt_id=$this->db->insert_id();
						$this->session->set_userdata('alert_msg', 
						'One Record Inserted Successfully');						
					}
					if($values['id']>0)// update data....
					{
						$this->projectmodel->save_records_model($values['id'],
						$table_name,$save_data);
						$receipt_id=$values['id'];
						$this->session->set_userdata('alert_msg', 
						'One Record Updated Successfully');
					}
								
					 $rem_amt=$save_data['rcpt_amt'];
					
					$selectfields=$this->input->post('invoice_summary_id');
					if (count($selectfields) > 0) {
					for ($i=0;$i<count($selectfields);$i++) {
					 $selectedfield=$selectfields[$i];
					
						if($selectedfield<>'')
						{	
							
						 $invoicedue=
						$this->projectmodel->invoice_wise_due($selectedfield);
							
							if($rem_amt>=$invoicedue)
							{
							$trn_rcv_expense_details['trn_rcv_expense_id']=$receipt_id;
							$trn_rcv_expense_details['invoice_summary_id']=$selectedfield;
							$trn_rcv_expense_details['amt']=$invoicedue;
							}
							else
							{
							$trn_rcv_expense_details['trn_rcv_expense_id']=$receipt_id;
							$trn_rcv_expense_details['invoice_summary_id']=$selectedfield;
							$trn_rcv_expense_details['amt']=$rem_amt;
							}
							//echo $rem_amt;							
							if($rem_amt>0)
							{
							$this->projectmodel->save_records_model('',
							'trn_rcv_expense_details',$trn_rcv_expense_details);
							$rem_amt=$rem_amt-$invoicedue;
							}
							
							
						}		
					
					}} 
					
					$this->accounts_model->ledger_transactions($receipt_id,'Receive');
					
					redirect('primary_sale_controller/rcv_section/trn_rcv_addedit/trn_rcv_expense/addeditview/0');
				  		}		
					}
					// add edit section end
					
				}
      			
				
				
			if($displaytype=='addeditview')
			{
				$layout_data['data_info'] = $this->load->view($viewnamepath,$data, true);
				$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
				$this->load->view('layout_only_body', $layout_data);
				$this->session->set_userdata('alert_msg', '');
			}
			else
			{
				$view_path_name=$viewnamepath;				
				$this->page_layout_display($view_path_name,$data);
			}
				
		
}
	
/*public function rcv_section($operation_type='listing',$id=0)
{
				
		if($operation_type=='listing')
		{
			$stockist=$data['tbl_party_id']=$this->input->post('tbl_party_id');	
			$startingdate=$data['startingdate']=$this->input->post('startingdate');
			$closingdate=$data['closingdate']=$this->input->post('closingdate');
			$hq_id=$data['report_type']=$this->input->post('report_type');
				
		}
			
		if(isset($_POST))
		{
			$stockist=$data['tbl_party_id']=$this->input->post('tbl_party_id');	
			$startingdate=$data['startingdate']=$this->input->post('startingdate');
			$closingdate=$data['closingdate']=$this->input->post('closingdate');
			$hq_id=$data['report_type']=$this->input->post('report_type');		
		
		}
		
	   $view_path_name='primary_sale_view/transaction/trn_rcv_view';
	   $this->page_layout_display($view_path_name,$data);
	
}*/
	
	
/*Transaction Rcv section end  */
			
public function invoice_print_function($id=0,$invoicetype='')	
{
	 		
			$layout_data=array();
			$data=array();
					
			$viewname='invoice_view_sell';
			$table_name='invoice_summary';
			$data_print['table_name']=$table_name;
			$data_print['table_id']=$id;			
			
			//FOR DIAMOND DRUG
			$report_path='primary_sale_view/invoice_other_print_diamond/';
			
			//FOR UNITED LAB
			//$report_path='primary_sale_view/';
			
			$sql="select * from invoice_summary where id=".$id." ";
			$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
			foreach ($rowrecord as $row1)
			{ 
				$invno=$row1->invoice_no;
				$tbl_party_id=$row1->tbl_party_id;
				$invoice_date=$row1->invoice_date; 
				$grandtot=$row1->grandtot;
				$APPROVE_STATUS=$row1->APPROVE_STATUS;
				
			}
			
			$sql="select * from stockist where id=".$tbl_party_id." ";
			$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
			foreach ($rowrecord as $row1)
			{ $stockistname=$row1->retail_name;}
			
			if($invoicetype=='SELL')
			 {	
			
			$this->pdf->load_view($report_path.'invoice_print_sell', $data_print);
			
				
		/*	$this->pdf->load_view('primary_sale_view/invoice_print_sell', $data_print);*/
				
				
				$this->pdf->render();
				$this->pdf->stream("pdf/invoice.pdf");				
				write_file("pdf/invoice.pdf", $this->pdf->output());
			 }
				
			 $sqlemp="select * from company_details where id=1";
			 $rowrecordemp = $this->projectmodel->get_records_from_sql($sqlemp);	
			 foreach ($rowrecordemp as $rowemp)
			 { 
				 $COMPNAME=$rowemp->NAME;
				 $MOB_NOS=$rowemp->MOB_NOS;
				 $emailid=$rowemp->EMAIL_IDS;
				 $company_mailid=$rowemp->company_mailid;
				 $authKey=$rowemp->SMS_KEY;
				 $senderId=$rowemp->SMS_SENDERID;
			 }	
							 
		if($invoicetype=='SELL' && $APPROVE_STATUS=='APPROVED')
		 {							
			$this->email->initialize(array('mailtype' => 'html')); 
			$this->email->from($company_mailid,$COMPNAME);
			$this->email->to($emailid); 
			//$this->email->cc('ashokedas@gmail.com'); 
			//$this->email->bcc('them@their-example.com');
			$this->email->subject('Sell Invoice:#'.$invno.' /'.$invoice_date);
		   
		    $email =$this->load->view($report_path.'invoice_print_sell',
			$data_print, TRUE);
			
			/*
			$email =$this->load->view('primary_sale_view/invoice_print_sell', 
			$data_print, TRUE);*/
			
			
			$this->email->message($email);	
			$this->email->attach('pdf/invoice.pdf');    
			$this->email->send();
			
			
			
		} 
		 
		 
		 
		if($invoicetype=='PRCHS_RTN')
		 {
			$this->pdf->load_view('primary_sale_view/invoice_print_purchase_rtn', 
			$data_print);
			$this->pdf->render();
			$this->pdf->stream("purchasecn_".$invno.".pdf");
		 }
		
		if($invoicetype=='SELL_RTN')
		 {
			$this->pdf->load_view($report_path.'/invoice_print_sell_rtn', 
			$data_print);
			$this->pdf->render();
			$this->pdf->stream("sellcn_".$invno.".pdf");
		 } 
		 
		 if($invoicetype=='PURCHASE')
		 {
			$this->pdf->load_view('primary_sale_view/invoice_print', $data_print);
			$this->pdf->render();
			$this->pdf->stream("purchase_".$invno.".pdf");
		 }
		
		
}	 
	 
	
	
	private function add_date($givendate,$day=0,$mth=0,$yr=0) 
	{
      	$cd = strtotime($givendate);
      	$newdate = date('Y-m-d h:i:s', mktime(date('h',$cd),
		date('i',$cd), date('s',$cd), date('m',$cd)+$mth,
		date('d',$cd)+$day, date('Y',$cd)+$yr));
		  return $newdate;
    } 
	public function dateDifference($startDate, $endDate)
        {
           			
			$startDate = strtotime($startDate);
            $endDate = strtotime($endDate);
            if ($startDate === false || $startDate < 0 || $endDate === false || $endDate < 0 || $startDate > $endDate)
                return false;
               
            $years = date('Y', $endDate) - date('Y', $startDate);
            $endMonth = date('m', $endDate);
            $startMonth = date('m', $startDate);
           
            // Calculate months
            $months = $endMonth - $startMonth;
            if ($months <= 0)  {
                $months += 12;
                $years--;
            }
            if ($years < 0)
                return false;
           
            // Calculate the days
                        $offsets = array();
                        if ($years > 0)
                            $offsets[] = $years . (($years == 1) ? ' year' : ' years');
                        if ($months > 0)
                            $offsets[] = $months . (($months == 1) ? ' month' : ' months');
                        $offsets = count($offsets) > 0 ? '+' . implode(' ', $offsets) : 'now';

                        $days = $endDate - strtotime($offsets, $startDate);
                        $days = date('z', $days);   
                      
					   //echo $days;
					   //return $months;
					   //return $days;
					   
            return array($years, $months, $days);
			
        } 	
		
			  
	public function invoiceprint_function($viewname='',$table_name='',$displaytype='list',$id=0)	
	 {
		$layout_data=array();
		$data=array();
		/*CHANGE HERE*/
		$redirectlist='primary_sale_controller/'.$this->uri->segment(2).'/'.$viewname.'/'.$table_name.'/'.$displaytype.'/'.$id.'/';
		$viewnamepath='reports/'.$viewname;
		
		$where_array = array('id' => $this->uri->segment(6));
		$data['records'] = $this->projectmodel->get_all_record($table_name,$where_array);
		
		$where_array = array('invoice_id' => $this->uri->segment(6));
		$data['builtylist'] = $this->projectmodel->get_all_record('tbl_builty',$where_array);
		
		//$sql="select a. from tbl_builty 	where invoice_id<>0  ";
		//$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
		
				
		$this->load->view('primary_sale_view/invoice_print', $data);
	
		/*$this->pdf->load_view('primary_sale_view/invoice_print', $data);
		$this->pdf->render();
		$this->pdf->stream("Invoice.pdf");*/
		
		//$this->session->set_userdata('alert_msg', '');	
		
	 }
		
			
	/* ALL REPORT PRINT SECTION*/
	public function print_function($viewname='',$table_name='',$displaytype='list',$id=0)	
	 {
	 	//http://pdfcrowd.com/web-html-to-pdf-php/
		//http://www.php-guru.in/2013/html-to-pdf-conversion-in-codeigniter/
		//https://github.com/EllisLab/CodeIgniter/wiki/PDF-generation-using-dompdf
		
		$layout_data=array();
		$data=array();
		/*CHANGE HERE*/
		//$table_name='purchase_header';
		$redirectlist='primary_sale_controller/'.$this->uri->segment(2).'/'.$viewname.'/'.$table_name.'/'.$displaytype.'/'.$id.'/';
		$viewnamepath='primary_sale_view/reports/'.$viewname;
				
		$data['user_name'] = $this->session->userdata('user_name');
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
		$data['startingdatev']=	'';
		$data['closingdatev']='';
			
		
		// Stock Report
			if($viewname=='stock_reports')
			{	
					
				if($displaytype=='list') //add --update
				{	
					$data['startingdate']=date('Y-m-d');
					$data['closingdate']=date('Y-m-d');				
				}
			
			if($displaytype=='addedit' && $this->input->post('submit')) //add --update
				{	
				
				$this->form_validation->set_rules('startingdate','Start Date','required');
				$this->form_validation->set_rules('closingdate','Close Date','required');
						
				if($this->form_validation->run()==FALSE )
				{
					$this->session->set_userdata('alert_msg', validation_errors());
					redirect('primary_sale_controller/print_function/stock_reports/invoice_summary/list/0');
				}
						else
						{
							
							$data['startingdate']=$this->input->post('startingdate');
							$data['closingdate']=$this->input->post('closingdate');
																
							/*$sql="select * from invoice_summary a,invoice_details b,product c
							where a.id=b.invoice_summary_id and b.product_id=c.id ";
							if($data['startingdatev']<>'' and $data['closingdatev']<>'')
							{
								$sql=$sql." and invoice_date between 
								'".$save_data['startingdate']."' 
								and '".$save_data['closingdate']."' ";							
							}
									
							$sql=$sql." order by a.id";
							$data['projectlist'] = 
							$this->projectmodel->get_records_from_sql($sql);*/
							
						}
						
						
					}
				
			}
		// Stock Report End
		
		
		
		// Agent Commission Report
		
			if($viewname=='agent_comm_rpt')
			{	
					
				if($displaytype=='list') //add --update
				{	
					/*$sql="select * from invoice_summary 
					where invoice_date='".date('Y-m-d')."' 
					and status='SELL' ORDER BY ID";
					$data['projectlist'] = $this->projectmodel->get_records_from_sql($sql);*/
					$data['startingdate']=date('Y-m-d');
					$data['closingdate']=date('Y-m-d');
					//$data['tbl_party_id']=$this->input->post('tbl_party_id');	
					
				}
			
			if($displaytype=='addedit' && $this->input->post('submit')) //add --update
				{	
				
				$this->form_validation->set_rules('startingdate','Start Date','required');
				$this->form_validation->set_rules('closingdate','Close Date','required');
						
				if($this->form_validation->run()==FALSE )
				{
					$this->session->set_userdata('alert_msg', validation_errors());
					redirect('primary_sale_controller/print_function/agent_comm_rpt/invoice_summary/list/0');
				}
						else
						{
							
							$data['startingdate']=$this->input->post('startingdate');
							$data['closingdate']=$this->input->post('closingdate');
							//$data['tbl_party_id']=$this->input->post('tbl_party_id');						
														
						}
						
						
					}
				
			}
		// Agent Commission Report End
		
		
			/*// Sell section
			if($viewname=='sell_reports')
			{	
					
				if($displaytype=='list') //add --update
				{	
					$data['startingdate']=date('Y-m-d');
					$data['closingdate']=date('Y-m-d');
					$data['tbl_party_id']=0;
					$data['report_type']=1;
					
					$sql="select * from invoice_summary 
					where invoice_date='".date('Y-m-d')."' 
					and status='SELL' ORDER BY ID";
					$data['projectlist'] =$this->projectmodel->get_records_from_sql($sql);
				}
			
			if($displaytype=='addedit' && $this->input->post('submit')) //add --update
				{	
				
				$this->form_validation->set_rules('startingdate','Start Date','required');
				$this->form_validation->set_rules('closingdate','Close Date','required');
						
				if($this->form_validation->run()==FALSE )
				{
					$this->session->set_userdata('alert_msg', validation_errors());
					redirect('primary_sale_controller/print_function/sell_reports/invoice_summary/list/0');
				}
						else
						{
							
							$data['startingdate']=$this->input->post('startingdate');
							$data['closingdate']=$this->input->post('closingdate');
							$data['tbl_party_id']=$this->input->post('tbl_party_id');						
							$data['report_type']=$this->input->post('report_type');
																			
							$sql="select * from invoice_summary where status='SELL'";
							if($data['startingdate']<>'' and $data['closingdate']<>'')
							{
								$sql=$sql." and invoice_date between 
								'".$data['startingdate']."' 
								and '".$data['closingdate']."' ";							
							}
														
							if($data['tbl_party_id']<>'')
							{
								$sql=$sql." and tbl_party_id=".$data['tbl_party_id'];						
							}				
							
							$sql=$sql." order by invoice_date";
							$data['projectlist'] = 
							$this->projectmodel->get_records_from_sql($sql);
							
						}
						
						
					}
				
			}
		// Sell section End
*/		
		
		//PRODUCT -STOCKIST WISE SALES -WITHOUT TAX
			if($viewname=='sell_prd_stkist')
			{	
				if($displaytype=='list') //add --update
				{	
					$data['location']='';	
					$maxh=1;
					$sqlemp="select max(srlno) maxh from tbl_designation ";
					$rowrecordemp = $this->projectmodel->get_records_from_sql($sqlemp);	
					foreach ($rowrecordemp as $rowemp)
					{$maxh=$rowemp->maxh;}	
					
					for($ds=1;$ds<=$maxh;$ds++)
					{	$data['desig'.$ds]='';}
					
					$data['tbl_party_id']=0;
					$data['product_id']='';
					$data['startingdate']=date('Y-m-d');
					$data['closingdate']=date('Y-m-d');
										
					$sql="select * from invoice_summary 
					where invoice_date='".date('Y-m-d')."' 
					and status='SELL' ORDER BY ID";
					$data['projectlist'] =
					$this->projectmodel->get_records_from_sql($sql);
					
					$where_array = array('id >' => 0,'brandtype '=> 'BRAND');
					$data['productlist'] =
					$this->projectmodel->get_all_record('brands',$where_array);
					$data['stockist_sql'] ='';
					
					
				}
			
			if($displaytype=='addedit' && $this->input->post('submit')) //add --update
				{	
				
			$this->form_validation->set_rules('startingdate','Start Date','required');
			$this->form_validation->set_rules('closingdate','Close Date','required');
						
				if($this->form_validation->run()==FALSE )
				{
					$this->session->set_userdata('alert_msg', validation_errors());
					redirect('primary_sale_controller/print_function/sell_prd_stkist/invoice_summary/list/0');
				}
						else
						{
						
						$data['startingdate']=$this->input->post('startingdate');
						$data['closingdate']=$this->input->post('closingdate');
						$data['tbl_party_id']=$this->input->post('tbl_party_id');						
						$data['product_id']=$this->input->post('product_id');
						//$data['location']=$this->input->post('location');
						$data['location']='';
						$data['productlist'] ='';
						
						$sqlemp="select * from tbl_hierarchy_org where	employee_id=".
						$this->session->userdata('login_emp_id');
						$rowrecordemp = $this->projectmodel->get_records_from_sql($sqlemp);	
						foreach ($rowrecordemp as $rowemp)
						{
						$parentuid=$rowemp->id;
						$tbl_designation_id=$rowemp->tbl_designation_id;
						}	
						
						if($data['location']<>'')
						{
							$sql_location=" and city_id in (select id from head_q 
							where state='".$data['location']."' ) ";
						}
						else
						{
							$sql_location="";
						}	
						
						
						$sqlfield="select childuid from tbl_organisation_chain
						where  child_desig_srl=6 and parentuid='$parentuid' ";	
						
						$maxh=1;
						$sqlemp="select max(srlno) maxh from tbl_designation ";
						$rowrecordemp = $this->projectmodel->get_records_from_sql($sqlemp);	
						foreach ($rowrecordemp as $rowemp)
						{$maxh=$rowemp->maxh;}	
						
						/*echo $this->input->post('desig5');echo '5<br>';
						echo $this->input->post('desig4');echo '4<br>';
						echo $this->input->post('desig6');echo '6<br>';*/
						
						for($ds=1;$ds<=$maxh;$ds++)
						{ 		
							$data['desig'.$ds]=$this->input->post('desig'.$ds);
							if($data['desig'.$ds]<>'')
							{
							 $sqlfield="select childuid from tbl_organisation_chain
							where  child_desig_srl=6 and parentuid=".$data['desig'.$ds];
							}
						}
									
						
						$stockist_sql="select id from stockist where 
						retail_field in (".$sqlfield." )  ";
						
						if($data['tbl_party_id']<>'')
						{$stockist_sql=$stockist_sql." and id=".$data['tbl_party_id'];}	
						
						$data['stockist_sql'] =
						$this->projectmodel->get_records_from_sql($stockist_sql);
						
						
						if($data['product_id']=='')
						{
							$where_array = array('id >' => 0,'brandtype '=> 'BRAND');
							$data['productlist'] =
							$this->projectmodel->get_all_record('brands',$where_array);
						}
						else
						{
							$pieces_ids = explode("-", $data['product_id']);
							$pkg=$pieces_ids[0];
							$product_id=$pieces_ids[1];
							
							$where_array = array('id' => $product_id,
							'brandtype '=> 'BRAND');
							$data['productlist'] =
							$this->projectmodel->get_all_record('brands',$where_array);
						}
								
						
						
						//select invoice 
												
						$data['invoice_sql'] ="select * from invoice_summary 
						where tbl_party_id in (".$stockist_sql." ) 
						and status='SELL' and invoice_date between 
						'".$data['startingdate']."' and '".$data['closingdate']."' ";
												
							
						}
					}
			     }
		// PRODUCT -STOCKIST WISE SALES -WITHOUT TAX End
		
		
		
		
		// Sell return section
			/*if($viewname=='sell_rtn_rpt')
			{	
					
				if($displaytype=='list') //add --update
				{	
				
					$data['startingdate']=date('Y-m-d');
					$data['closingdate']=date('Y-m-d');
					$data['tbl_party_id']=0;
					
					$sql="select * from invoice_summary 
					where invoice_date='".date('Y-m-d')."' 
					and status='SELL_RTN' ORDER BY ID";
					$data['projectlist'] = $this->projectmodel->get_records_from_sql($sql);
				}
			
			if($displaytype=='addedit' && $this->input->post('submit')) //add --update
				{	
				
				$this->form_validation->set_rules('startingdate','Start Date','required');
				$this->form_validation->set_rules('closingdate','Close Date','required');
						
				if($this->form_validation->run()==FALSE )
				{
					$this->session->set_userdata('alert_msg', validation_errors());
					redirect('primary_sale_controller/print_function/sell_rtn_rpt/invoice_summary/list/0');
				}
						else
						{
							
							$data['startingdate']=$this->input->post('startingdate');
							$data['closingdate']=$this->input->post('closingdate');
							$data['tbl_party_id']=$this->input->post('tbl_party_id');						
																			
							$sql="select * from invoice_summary where status='SELL_RTN'";
							if($data['startingdate']<>'' and $data['closingdate']<>'')
							{
								$sql=$sql." and invoice_date between 
								'".$data['startingdate']."' 
								and '".$data['closingdate']."' ";							
							}
														
							if($data['tbl_party_id']<>'')
							{
								$sql=$sql." and tbl_party_id=".$data['tbl_party_id'];						
							}				
							
							$sql=$sql." order by id";
							$data['projectlist'] = 
							$this->projectmodel->get_records_from_sql($sql);
							
						}
						
						
					}
				
			}*/
		// Sell Return section End
		
			
		// Purchase section
			if($viewname=='purchase_report')
			{	
				$data['startingdate']=date('Y-m-d');
				$data['closingdate']=date('Y-m-d');
				$data['tbl_party_id']=0;
				
				if($displaytype=='list') //add --update
				{	
					$sql="select * from invoice_summary 
					where invoice_date='".date('Y-m-d')."' 
					and status='PURCHASE' ORDER BY ID";
					$data['projectlist'] = 
					$this->projectmodel->get_records_from_sql($sql);
				}
			
			if($displaytype=='addedit' && $this->input->post('submit')) //add --update
				{	
				
				$this->form_validation->set_rules('startingdate',
				'Start Date','required');
				
				$this->form_validation->set_rules('closingdate',
				'Close Date','required');
						
				if($this->form_validation->run()==FALSE )
				{
					$this->session->set_userdata('alert_msg', validation_errors());
					redirect('primary_sale_controller/print_function/purchase_report/invoice_summary/list/0');
				}
						else
						{
							
							$data['startingdate']=$this->input->post('startingdate');
							$data['closingdate']=$this->input->post('closingdate');
							$data['tbl_party_id']=$this->input->post('tbl_party_id');						
																			
							 $sql="select * from invoice_summary where status='PURCHASE'";
							if($data['startingdate']<>'' and $data['closingdate']<>'')
							{
								$sql=$sql." and invoice_date between 
								'".$data['startingdate']."' 
								and '".$data['closingdate']."' ";							
							}
														
							if($data['tbl_party_id']<>'')
							{
								$sql=$sql." and tbl_party_id=".$data['tbl_party_id'];						
							}				
							
							$sql=$sql." order by invoice_date";
							$data['projectlist'] = 
							$this->projectmodel->get_records_from_sql($sql);
							
						}
						
						
					}
				
			}
			// Purchase section
			
			
			
			// Purchase Return section
			if($viewname=='purchase_rtn_rpt')
			{	
					
				if($displaytype=='list') //add --update
				{	
					$data['startingdate']=date('Y-m-d');
					$data['closingdate']=date('Y-m-d');
					
					$sql="select * from invoice_summary 
					where invoice_date='".date('Y-m-d')."' 
					and status='PRCHS_RTN' ORDER BY ID";
					$data['projectlist'] = $this->projectmodel->get_records_from_sql($sql);
				}
			
			if($displaytype=='addedit' && $this->input->post('submit')) //add --update
				{	
				
				$this->form_validation->set_rules('startingdate','Start Date','required');
				$this->form_validation->set_rules('closingdate','Close Date','required');
						
				if($this->form_validation->run()==FALSE )
				{
					$this->session->set_userdata('alert_msg', validation_errors());
					redirect('primary_sale_controller/print_function/purchase_rtn_rpt/invoice_summary/list/0');
				}
						else
						{
							
							$data['startingdate']=$this->input->post('startingdate');
							$data['closingdate']=$this->input->post('closingdate');
							$data['tbl_party_id']=$this->input->post('tbl_party_id');						
																			
							$sql="select * from invoice_summary where status='PRCHS_RTN'";
							if($data['startingdate']<>'' and $data['closingdate']<>'')
							{
								$sql=$sql." and invoice_date between 
								'".$data['startingdate']."' 
								and '".$data['closingdate']."' ";							
							}
														
							if($data['tbl_party_id']<>'')
							{
								$sql=$sql." and tbl_party_id=".$data['tbl_party_id'];						
							}				
							
							$sql=$sql." order by id";
							$data['projectlist'] = 
							$this->projectmodel->get_records_from_sql($sql);
							
						}
						
						
					}
				
			}
			// Purchase Return section
			
						
			
								
			// receipt statement section
			if($viewname=='payment_report_view')
			{
						
					if($displaytype=='list') //add --update
					{	
						$data['startingdate']=date('Y-m-d');
						$data['closingdate']=date('Y-m-d');
					
						$sql="select * from trn_rcv_expense 
						where paydate='".date('Y-m-d')."' and status='Expense' ORDER BY ID ";
						$data['projectlist'] = $this->projectmodel->get_records_from_sql($sql);
					}
			
					if($displaytype=='addedit' && $this->input->post('submit')) //add --update
					{	
					
						$this->form_validation->set_rules('startingdate','Start Date','required');
						$this->form_validation->set_rules('closingdate','Close Date','required');		
						if($this->form_validation->run()==FALSE )
						{
							$this->session->set_userdata('alert_msg', validation_errors());
							redirect(	'primary_sale_controller/print_function/payment_report_view/tbl_builty/list/0');
						}
						else
						{
							
							$data['startingdate']=$this->input->post('startingdate');
							$data['closingdate']=$this->input->post('closingdate');
							$data['consignor_id']=$this->input->post('consignor_id');	
																										
							$sql="select * from trn_rcv_expense where status='Expense'";
							
							if($data['startingdate']<>'' and $data['closingdate']<>'')
							{
								 $sql=$sql." and paydate between 
								'".$data['startingdate']."' 
								and '".$data['closingdate']."' ";							
							}
														
							if($data['consignor_id']<>'')
							{
								$sql=$sql." and tbl_party_id=".$data['consignor_id'];						
							}			
							
					$sql=$sql." order by paydate";
					$data['projectlist'] = $this->projectmodel->get_records_from_sql($sql);
							
						}
						
						
					}
				
			}
			
			/*Receive Collection from party-stockist*/			
			/*if($viewname=='receive_report_view')
			{
						
					if($displaytype=='list') //add --update
					{	
						$data['startingdate']=date('Y-m-d');
						$data['closingdate']=date('Y-m-d');
						$data['tbl_party_id']=0;
						
						$sql="select * from trn_rcv_expense 
						where paydate='".date('Y-m-d')."' and status='Receive' ORDER BY ID ";
						$data['projectlist'] = $this->projectmodel->get_records_from_sql($sql);
					}
			
					if($displaytype=='addedit' && $this->input->post('submit')) //add --update
					{	
					
						$this->form_validation->set_rules('startingdate','Start Date','required');
						$this->form_validation->set_rules('closingdate','Close Date','required');		
						if($this->form_validation->run()==FALSE )
						{
							$this->session->set_userdata('alert_msg', validation_errors());
							redirect(	'primary_sale_controller/print_function/receive_report_view/tbl_builty/list/0');
						}
						else
						{
							
							$data['startingdate']=$this->input->post('startingdate');
							$data['closingdate']=$this->input->post('closingdate');
							$data['tbl_party_id']=$this->input->post('tbl_party_id');	
																										
							$sql="select * from trn_rcv_expense where status='Receive'";
							
							if($data['startingdate']<>'' and $data['closingdate']<>'')
							{
								 $sql=$sql." and paydate between 
								'".$data['startingdate']."' 
								and '".$data['closingdate']."' ";							
							}
														
							if($data['tbl_party_id']<>'')
							{
								$sql=$sql." and tbl_party_id=".$data['tbl_party_id'];						
							}			
							
					$sql=$sql." order by paydate";
					$data['projectlist'] = $this->projectmodel->get_records_from_sql($sql);
							
						}
						
						
					}
				
			}*/
			
			
			
			
			// payment statement section
			if($viewname=='payment_statement_view')
			{	
					
					if($displaytype=='list') //add --update
					{	
						$sql="select * from trn_rcv_expense 
						where paydate='".date('Y-m-d')."' and status='Expense' ORDER BY ID";
						$data['projectlist'] = $this->projectmodel->get_records_from_sql($sql);
					}
			
					if($displaytype=='addedit' && $this->input->post('submit')) //add --update
					{	
					
					$this->form_validation->set_rules('startingdate','Start Date','required');
					$this->form_validation->set_rules('closingdate','Close Date','required');
									
						
						if($this->form_validation->run()==FALSE )
						{
							$this->session->set_userdata('alert_msg', validation_errors());
							redirect('primary_sale_controller/print_function/rcpt_report_view/tbl_builty/list/0');
						}
						else
						{
							$save_data['startingdate']=$this->input->post('startingdate');
							$save_data['closingdate']=$this->input->post('closingdate');
							$data['startingdatev']=$this->input->post('startingdate');
							$data['closingdatev']=$this->input->post('closingdate');
							$data['tbl_party_id']=$this->input->post('tbl_party_id');						
							$data['mst_rcv_exp_id']=$this->input->post('mst_rcv_exp_id');
							$data['broker_id']=$this->input->post('broker_id');
												
							$sql="select * from trn_rcv_expense where status='Expense'";
							if($data['startingdatev']<>'' and $data['closingdatev']<>'')
							{
								$sql=$sql." and paydate between 
								'".$save_data['startingdate']."' 
								and '".$save_data['closingdate']."' ";							
							}
							
							if($data['mst_rcv_exp_id']<>'')
							{
								$sql=$sql." and mst_rcv_exp_id=".$data['mst_rcv_exp_id'];						
							}
							
							if($data['tbl_party_id']<>'')
							{
								$sql=$sql." and tbl_party_id=".$data['tbl_party_id'];						
							}
							
							if($data['broker_id']<>'')
							{
								$sql=$sql." and broker_id=".$data['broker_id'];						
							}
							
							
							$sql=$sql." order by id";
							$data['projectlist'] = 
							$this->projectmodel->get_records_from_sql($sql);
							
						}
						
						
					}
				
			}
			// payment statement section
							
				
			// Purchase statement section
			if($viewname=='purchase_statement')
			{		
			
					
					if($displaytype=='list') //add --update
					{	
						$data['totrcv']=0;
						$data['totexp']=0;
						$data['open_bal']=0;				
						$data['startingdate']=date('Y-m-d');
						$data['closingdate']=date('Y-m-d');
						$data['tbl_party_id']='';
					}
			
					if($displaytype=='addedit' && $this->input->post('submit')) //add --update
					{	
					
						$this->form_validation->set_rules('startingdate',
						'Start Date','required');
						$this->form_validation->set_rules('closingdate',
						'Close Date','required');						
						if($this->form_validation->run()==FALSE )
						{
							$this->session->set_userdata('alert_msg', 
							validation_errors());
							redirect('primary_sale_controller/print_function/purchase_statement/tbl_builty/list/0');
						}
						
						else
						{
							
							$startingdate=$data['startingdate']=
							$this->input->post('startingdate');
							$data['closingdate']=$this->input->post('closingdate');
							$partyid=$data['tbl_party_id']=$this->input->post('tbl_party_id');	
							$purrtn=0;
							$puramt=0;	
							$total_collection=0;	
							$data['totrcv']=0;
							$data['totexp']=0;
							$data['open_bal']=0;			
							
							 $sql="select sum(grandtot) totalsell from invoice_summary 
							where tbl_party_id='".$partyid."' and status='PURCHASE' 
							and invoice_date<'".$startingdate."' ";
							$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
							foreach ($rowrecord as $row)
							{ $puramt=$row->totalsell; }
							
							//prtn 1 
							$sql="select sum(grandtot) totalsell from invoice_summary 
							where  id in  
							(select rtn_invoice_summary_id1 from invoice_summary 
							where tbl_party_id='".$partyid."' and status='PURCHASE' 
							and invoice_date<'".$startingdate."')  ";
							$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
							foreach ($rowrecord as $row)
							{ $purrtn=$purrtn+$row->totalsell; }
							
							//prtn 2 
							
							$sql="select sum(grandtot) totalsell from invoice_summary 
							where  id in  
							(select rtn_invoice_summary_id2 from invoice_summary 
							where tbl_party_id='".$partyid."' and status='PURCHASE' 
							and invoice_date<'".$startingdate."')  ";
							$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
							foreach ($rowrecord as $row)
							{ $purrtn=$purrtn+$row->totalsell; }
							
							//prtn 3 
							$sql="select sum(grandtot) totalsell from invoice_summary 
							where  id in  
							(select rtn_invoice_summary_id3 from invoice_summary 
							where tbl_party_id='".$partyid."' and status='PURCHASE' 
							and invoice_date<'".$startingdate."')  ";
							
							$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
							foreach ($rowrecord as $row)
							{ $purrtn=$purrtn+$row->totalsell; }
							
							$data['totrcv']=$puramt-$purrtn;
							
							$sql="select sum(rcpt_amt) rcpt_amt from trn_rcv_expense 
							where tbl_party_id='".$partyid."' and status='Expense' 
							and paydate<'".$startingdate."'";
							$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
							foreach ($rowrecord as $row)
							{ $total_collection=$row->rcpt_amt; }
							$data['totexp']=$total_collection;
							
							$data['open_bal']=$data['totrcv']-$data['totexp'];	
							
							
						}
					}
				}
				// Purchase statement section
				
				
			// Sell statement section
			if($viewname=='sell_statement')
			{							
					if($displaytype=='list') //add --update
					{	
						$data['totrcv']=0;
						$data['totexp']=0;
						$data['open_bal']=0;				
						$data['startingdate']=date('Y-m-d');
						$data['closingdate']=date('Y-m-d');
						$data['tbl_party_id']='';
					}
			
					if($displaytype=='addedit' && $this->input->post('submit')) //add --update
					{	
					
						$this->form_validation->set_rules('startingdate','Start Date',
						'required');
						$this->form_validation->set_rules('closingdate','Close Date',
						'required');						
						if($this->form_validation->run()==FALSE )
						{
							$this->session->set_userdata('alert_msg', validation_errors());
							redirect(				'primary_sale_controller/print_function/sell_statement/tbl_builty/list/0');
						}
						
						else
						{
							
							$startingdate=$data['startingdate']=
							$this->input->post('startingdate');
							$data['closingdate']=$this->input->post('closingdate');
							$partyid=$data['tbl_party_id']=
							$this->input->post('tbl_party_id');	
							
							$purrtn=0;
							$puramt=0;	
							$total_collection=0;	
							$data['totrcv']=0;
							$data['totexp']=0;
							$data['open_bal']=0;			
							
							
							
							$sql="select sum(grandtot) totalsell from invoice_summary 
							where tbl_party_id='".$partyid."' and status='SELL' 
							and invoice_date<'".$startingdate."' ";
							$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
							foreach ($rowrecord as $row)
							{ $puramt=$puramt+$row->totalsell; }
							
							$sql="select sum(open_balance) open_balance from stockist 
							where id='".$partyid."' and open_date<='".$startingdate."' ";
							$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
							foreach ($rowrecord as $row)
							{ $puramt=$puramt+$row->open_balance; }
							
							
							//prtn 1 
							$sql="select sum(grandtot) totalsell from invoice_summary 
							where  id in  (select rtn_invoice_summary_id1 
							from invoice_summary 
							where tbl_party_id='".$partyid."' and status='SELL' 
							and invoice_date<'".$startingdate."')  ";
							$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
							foreach ($rowrecord as $row)
							{ $purrtn=$purrtn+$row->totalsell; }
							
							//prtn 2 
							$sql="select sum(grandtot) totalsell from invoice_summary 
							where  id in  (select rtn_invoice_summary_id2 
							from invoice_summary 
							where tbl_party_id='".$partyid."' and status='SELL' 
							and invoice_date<'".$startingdate."')  ";
							$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
							foreach ($rowrecord as $row)
							{ $purrtn=$purrtn+$row->totalsell; }
							
							//prtn 3 
							$sql="select sum(grandtot) totalsell from invoice_summary 
							where  id in  (select rtn_invoice_summary_id3 
							from invoice_summary 
							where tbl_party_id='".$partyid."' and status='SELL' 
							and invoice_date<'".$startingdate."')  ";							
							$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
							foreach ($rowrecord as $row)
							{ $purrtn=$purrtn+$row->totalsell; }
							
							$data['totrcv']=$puramt-$purrtn;
							
							$sql="select sum(rcpt_amt) rcpt_amt from trn_rcv_expense 
							where tbl_party_id='".$partyid."' and status='Receive' 
							and paydate<'".$startingdate."'";
							$rowrecord = $this->projectmodel->get_records_from_sql($sql);	
							foreach ($rowrecord as $row)
							{ $total_collection=$row->rcpt_amt; }
							$data['totexp']=$total_collection;
							
							$data['open_bal']=$data['totrcv']-$data['totexp'];	
							
							
						}
					}
				}
				// Sell statement section
				
				
		// layout section .....
		
		$data['report_parameter'] = 
		$this->load->view('primary_sale_view/reports/report_parameter',$data, true);
		
		$layout_data['data_info'] = $this->load->view($viewnamepath,$data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout', $layout_data);
		$this->session->set_userdata('alert_msg', '');	
				
	 }


public function stockist_wise_outstanding_details()
{
		$data['outstanding_report']=1;
		$view_path_name='primary_sale_view/reports/stokist_wise_outstanding_details';
	    $this->page_layout_display($view_path_name,$data);
		
}

public function sell_reports_tot_fig()
{
		$data['startingdate']=date('Y-m-d');
		$data['closingdate']=date('Y-m-d');
		$data['hq_id']=0;
		
		
		if(isset($_POST))
		{
				$startingdate=$data['startingdate']=$this->input->post('startingdate');
				$closingdate=$data['closingdate']=$this->input->post('closingdate');
				$hq_id=$data['hq_id']=$this->input->post('hq_id');
				$product_type=$data['product_type']=$this->input->post('product_type');
					
				$login_emp_id=$this->session->userdata('login_emp_id');
				$sqlemp="select * from 
				tbl_hierarchy_org where	employee_id=".$login_emp_id;
				$rowrecord = $this->projectmodel->get_records_from_sql($sqlemp);	
				foreach ($rowrecord as $row1)
				{$parentuid=$row1->id;}
					//TREEVIEW ...
					$query ="delete from structure_tree"; 
					$this->db->query($query);	
						
					$rslt=$this->modeltree->getTreeview();
					
					//echo '<table border="1">';
					 $this->modeltree->buildTree($rslt);
					//echo '</table>';
		}
				
		$view_path_name='primary_sale_view/reports/sale_hierarchy';
	    $this->page_layout_display($view_path_name,$data);
		
}



public function sell_rtn_reports()
	{
		$data['startingdate']=date('Y-m-d');
		$data['closingdate']=date('Y-m-d');
		$data['report_type']='';
		$data['product_type']='OLDDIV';
		$data['tbl_party_id']='';
		$data['desig1']='';
		$data['desig2']='';
		$data['desig3']='';
		$data['desig4']='';
		$data['desig5']='';
		
		
		$sql_start="select * from invoice_summary where id=0 ";
		$data['projectlist'] =$this->projectmodel->get_records_from_sql($sql_start);			
			
		
		if(isset($_POST) && isset($_POST['submit']) )
		{
				$startingdate=$data['startingdate']=$this->input->post('startingdate');
				$closingdate=$data['closingdate']=$this->input->post('closingdate');
				$stockist=$data['stockist']=$this->input->post('tbl_party_id');
				$status='SELL';
				$data['report_type']=$this->input->post('report_type');
				$stockist_ids=$this->session->userdata('stockist_ids');
				
				//echo $stockist_ids;
				$parentuid=0;
				$login_emp_id=$this->session->userdata('login_emp_id');
				$sqlemp="select * from 
				tbl_hierarchy_org where	employee_id=".$login_emp_id;
				$rowrecord = $this->projectmodel->get_records_from_sql($sqlemp);	
				foreach ($rowrecord as $row1)
				{$parentuid=$row1->id;}
				
				if($this->input->post('desig1')<>'')
				{$parentuid=$data['desig1']=$this->input->post('desig1');}
				
				if($this->input->post('desig2')<>'')
				{$parentuid=$data['desig2']==$this->input->post('desig2');}
				
				if($this->input->post('desig3')<>'')
				{$parentuid=$data['desig3']=$this->input->post('desig3');}
				
				if($this->input->post('desig4')<>'')
				{$parentuid=$data['desig4']=$this->input->post('desig4');}
				
				if($this->input->post('desig5')<>'')
				{$parentuid=$data['desig5']=$this->input->post('desig5');}
				
				$stockist_ids=0;
				
			  $sqlfield="select childuid from tbl_organisation_chain
			  where  child_desig_srl=6 and parentuid='$parentuid' ";	
				
				$fields = $this->projectmodel->get_records_from_sql($sqlfield);
				foreach ($fields as $field)
					{ 	
						$sql="select * from stockist ";
						$rowrecord = $this->projectmodel->get_records_from_sql($sql);
						foreach ($rowrecord as $row1)
						{ 		
							$stockist_field = explode(",",$row1->retail_field);
							if (in_array($field->childuid, $stockist_field))
							{			
							$stockist_ids=$stockist_ids.','.$row1->id;
							}
						}
					}
				
				
				if($stockist_ids=='')
				{	
					$sql="select * from invoice_summary where id>0 
					and (status='SELL_RTN' or status='SELL_RTN_EXP')  ";
				}
				else
				{
					$sql="select * from invoice_summary where id>0 
					and (status='SELL_RTN' or status='SELL_RTN_EXP')
					and  tbl_party_id in (".$stockist_ids.") ";
				}
											
				if($startingdate<>'' and $closingdate<>'')
				{
					$sql=$sql." and invoice_date between 
					'".$startingdate."' and '".$closingdate."' ";							
				}		
		
				if($stockist<>'')
				{$sql=$sql." and tbl_party_id=".$stockist;}	
				
				//echo $sql;
			
				$data['projectlist'] = 
				$this->projectmodel->get_records_from_sql($sql);
		}
		
		$data['report_parameter'] = 
		$this->load->view('primary_sale_view/reports/company_hierarchy',$data, true);
				
		$view_path_name='primary_sale_view/reports/sell_rtn_rpt';
	    $this->page_layout_display($view_path_name,$data);
		
}	
	
public function collection_report_new()
{
		$data['startingdate']=date('Y-m-d');
		$data['closingdate']=date('Y-m-d');
		$data['report_type']='';
		$data['product_type']='OLDDIV';
		$data['stockist']=$data['tbl_party_id']='';
		$data['desig1']='';
		$data['desig2']='';
		$data['desig3']='';
		$data['desig4']='';
		$data['desig5']='';
		
		
		$sql_start="select * from trn_rcv_expense where id=0 ";
		$data['projectlist'] =$this->projectmodel->get_records_from_sql($sql_start);	
		
		if(isset($_POST) && isset($_POST['submit']))
		{
				$startingdate=$data['startingdate']=$this->input->post('startingdate');
				$closingdate=$data['closingdate']=$this->input->post('closingdate');
				$stockist=$data['stockist']=$this->input->post('tbl_party_id');
				$status='SELL';
				$product_type=$data['product_type']=$this->input->post('product_type');
				$stockist_ids=$this->session->userdata('stockist_ids');
				$hqid=0;
				//echo $stockist_ids;
				$parentuid=0;
				$login_emp_id=$this->session->userdata('login_emp_id');
				$sqlemp="select * from 
				tbl_hierarchy_org where	employee_id=".$login_emp_id;
				$rowrecord = $this->projectmodel->get_records_from_sql($sqlemp);	
				foreach ($rowrecord as $row1)
				{$parentuid=$row1->id;}
				
				//$hqid=$this->projectmodel->gethierarchy_list($parentuid,'HQ');
				
				if($this->input->post('desig1')<>'')
				{$parentuid=$data['desig1']=$this->input->post('desig1');}
				
				if($this->input->post('desig2')<>'')
				{ $parentuid=$data['desig2']==$this->input->post('desig2');}
				
				if($this->input->post('desig3')<>'')
				{ $parentuid=$data['desig3']=$this->input->post('desig3');}
				
				if($this->input->post('desig4')<>'')
				{$parentuid=$data['desig4']=$this->input->post('desig4');}
				
				if($this->input->post('desig5')<>'')
				{$hqid=$parentuid=$data['desig5']=$this->input->post('desig5');}
								
				$stockist_ids=0;
				
				if($hqid<>0)
				{
					$sqlfield="select childuid from tbl_organisation_chain
					where  child_desig_srl=5 and parentuid='$parentuid' ";	
					$fields = $this->projectmodel->get_records_from_sql($sqlfield);
					foreach ($fields as $field)
						{ $hqid=$hqid.','.$field->childuid;}
				}
				
				echo $hqid;
				
				/*$fields = $this->projectmodel->get_records_from_sql($sqlfield);
				foreach ($fields as $field)
					{ 	
						$sql="select * from stockist ";
						$rowrecord = $this->projectmodel->get_records_from_sql($sql);
						foreach ($rowrecord as $row1)
						{ 		
							$stockist_field = explode(",",$row1->retail_field);
							if (in_array($field->childuid, $stockist_field))
							{			
							$stockist_ids=$stockist_ids.','.$row1->id;
							}
						}
					}*/
					
								 
				
				$invoice_summary_id=0;
				 $sqlinv="select * from invoice_summary
				where  status='SELL' and 
				product_type='$product_type' and hq_id in (".$hqid.") ";
				$rowrecordinv = 
				$this->projectmodel->get_records_from_sql($sqlinv);	
				foreach ($rowrecordinv as $rowinv)
				{ $invoice_summary_id=$invoice_summary_id.','.$rowinv->id;}
	
				
				$sql="select a.* from trn_rcv_expense a, trn_rcv_expense_details b
				where a.status='Receive' and a.id=b.trn_rcv_expense_id 
				and a.chqstatus='CLEAR' 
				and  b.invoice_summary_id in (". $invoice_summary_id." ) " ;
					
											
				if($startingdate<>'' and $closingdate<>'')
				{
					$sql=$sql." and a.paydate between 
					'".$startingdate."' and '".$closingdate."' ";							
				}		
		
				if($stockist<>'')
				{$sql=$sql." and a.tbl_party_id=".$stockist;}	
					
				
				//echo $sql;
			
				$data['projectlist'] = 
				$this->projectmodel->get_records_from_sql($sql);
				
				
				
		}
		
		$data['report_parameter'] = 
		$this->load->view('primary_sale_view/reports/company_hierarchy',$data, true);
				
		$view_path_name='primary_sale_view/reports/receive_report_view';
	    $this->page_layout_display($view_path_name,$data);
		
}



public function collection_report()
{
		$data['startingdate']=date('Y-m-d');
		$data['closingdate']=date('Y-m-d');
		$data['report_type']='';
		$data['product_type']='OLDDIV';
		$data['stockist']=$data['tbl_party_id']='';
		$data['desig1']='';
		$data['desig2']='';
		$data['desig3']='';
		$data['desig4']='';
		$data['desig5']='';
		
		
		$sql_start="select * from trn_rcv_expense where id=0 ";
		$data['projectlist'] =$this->projectmodel->get_records_from_sql($sql_start);	
		
		if(isset($_POST) && isset($_POST['submit']))
		{
				$startingdate=$data['startingdate']=$this->input->post('startingdate');
				$closingdate=$data['closingdate']=$this->input->post('closingdate');
				$stockist=$data['stockist']=$this->input->post('tbl_party_id');
				$product_type=$data['product_type']=$this->input->post('product_type');
				$status='SELL';
				//$data['report_type']=$this->input->post('report_type');
				$stockist_ids=$this->session->userdata('stockist_ids');
				
				//echo $stockist_ids;
				$parentuid=0;
				$login_emp_id=$this->session->userdata('login_emp_id');
				$sqlemp="select * from 
				tbl_hierarchy_org where	employee_id=".$login_emp_id;
				$rowrecord = $this->projectmodel->get_records_from_sql($sqlemp);	
				foreach ($rowrecord as $row1)
				{$parentuid=$row1->id;}
				
				if($this->input->post('desig1')<>'')
				{$parentuid=$data['desig1']=$this->input->post('desig1');}
				
				if($this->input->post('desig2')<>'')
				{$parentuid=$data['desig2']==$this->input->post('desig2');}
				
				if($this->input->post('desig3')<>'')
				{$parentuid=$data['desig3']=$this->input->post('desig3');}
				
				if($this->input->post('desig4')<>'')
				{$parentuid=$data['desig4']=$this->input->post('desig4');}
				
				if($this->input->post('desig5')<>'')
				{$parentuid=$data['desig5']=$this->input->post('desig5');}
				
				$stockist_ids=0;
			  				
			$stockist_ids=$this->projectmodel->gethierarchy_list($parentuid,'STOCKIST');
				
				/*$fields = $this->projectmodel->get_records_from_sql($sqlfield);
				foreach ($fields as $field)
					{ 	
						$sql="select * from stockist ";
						$rowrecord = $this->projectmodel->get_records_from_sql($sql);
						foreach ($rowrecord as $row1)
						{ 		
							$stockist_field = explode(",",$row1->retail_field);
							if (in_array($field->childuid, $stockist_field))
							{			
							$stockist_ids=$stockist_ids.','.$row1->id;
							}
						}
					}*/
				
				
				
				$invoice_summary_id=0;
				$sqlinv="select * from invoice_summary
				where  status='SELL' and 
				product_type='$product_type' and 
				tbl_party_id in (".$stockist_ids.") ";
				$rowrecordinv = 
				$this->projectmodel->get_records_from_sql($sqlinv);	
				foreach ($rowrecordinv as $rowinv)
				{ $invoice_summary_id=$invoice_summary_id.','.$rowinv->id;}
	
				
		$sql="select b.paydate,b.paymode,b.chqno,b.chqdate,b.tbl_party_id,
		a.id,a.amt,a.invoice_summary_id,b.bankname 
		from trn_rcv_expense_details a,trn_rcv_expense b
		where  a.invoice_summary_id in (".$invoice_summary_id." ) 
		and b.status='Receive' and b.id=a.trn_rcv_expense_id
		 and b.chqstatus='CLEAR' ";
				
				
				/*$trn_rcv_expense_ids=0;
				$sqlinv="select * from trn_rcv_expense_details
				where  invoice_summary_id in (". $invoice_summary_id." ) ";
				$rowrecordinv = 
				$this->projectmodel->get_records_from_sql($sqlinv);	
				foreach ($rowrecordinv as $rowinv)
				{ $trn_rcv_expense_ids=$trn_rcv_expense_ids.','.
				$rowinv->trn_rcv_expense_id;}
				
				
				 $sql="select * from trn_rcv_expense 
				where status='Receive' and chqstatus='CLEAR' 
				and  id in (".$trn_rcv_expense_ids." ) " ;*/
				
				if($stockist<>'')
				{$sql=$sql." and b.tbl_party_id=".$stockist;}	
								
											
				if($startingdate<>'' and $closingdate<>'')
				{
					$sql=$sql." and b.paydate between 
					'".$startingdate."' and '".$closingdate."' ";							
				}		
		
				
				
				//echo $sql;
			
				$data['projectlist'] = 
				$this->projectmodel->get_records_from_sql($sql);
		}
		
		$data['report_parameter'] = 
		$this->load->view('primary_sale_view/reports/company_hierarchy',$data, true);
				
		$view_path_name='primary_sale_view/reports/receive_report_view';
	    $this->page_layout_display($view_path_name,$data);
		
}



public function purchase_register()
	{
				
		$data['startingdate']=date('Y-m-d');
		$data['closingdate']=date('Y-m-d');
		$data['tbl_party_id']='';
		
		$sql="select * from invoice_summary 
		where invoice_date='".date('Y-m-d')."' 
		and status='PURCHASE' ORDER BY ID";
		$data['projectlist'] = 
		$this->projectmodel->get_records_from_sql($sql);
			
		if(isset($_POST))
		{
				 $startingdate=$data['startingdate']=$this->input->post('startingdate');
				 $closingdate=$data['closingdate']=$this->input->post('closingdate');
				 $stockist=$data['tbl_party_id']=$this->input->post('tbl_party_id');	
																			
				$sql="select * from invoice_summary where status='PURCHASE'";
				if($data['startingdate']<>'' and $data['closingdate']<>'')
				{
					$sql=$sql." and invoice_date between 
					'".$data['startingdate']."' 
					and '".$data['closingdate']."' ";							
				}
											
				if($data['tbl_party_id']<>'')
				{
					$sql=$sql." and tbl_party_id=".$data['tbl_party_id'];						
				}				
				
				$sql=$sql." order by invoice_date";
				$data['projectlist'] = 
				$this->projectmodel->get_records_from_sql($sql);
		
		}
		
				
		$view_path_name='primary_sale_view/reports/purchase_report';
	    $this->page_layout_display($view_path_name,$data);
		
}


public function sell_reports()
	{
		$data['startingdate']=date('Y-m-d');
		$data['closingdate']=date('Y-m-d');
		$data['report_type']='';
		$data['product_type']='OLDDIV';
		
		$data['tbl_party_id']='';
		$data['desig1']='';
		$data['desig2']='';
		$data['desig3']='';
		$data['desig4']='';
		$data['desig5']='';
		
		
		if(isset($_POST))
		{
				$startingdate=$data['startingdate']=$this->input->post('startingdate');
				$closingdate=$data['closingdate']=$this->input->post('closingdate');
				$stockist=$data['stockist']=$this->input->post('tbl_party_id');
				$status='SELL';
				$data['report_type']=$this->input->post('report_type');
				$data['product_type']=$this->input->post('product_type');
				$stockist_ids=$this->session->userdata('stockist_ids');
				
				//echo $stockist_ids;
				$parentuid=0;
				
				$login_emp_id=$this->session->userdata('login_emp_id');
				$sqlemp="select * from 
				tbl_hierarchy_org where	employee_id=".$login_emp_id;
				$rowrecord = $this->projectmodel->get_records_from_sql($sqlemp);	
				foreach ($rowrecord as $row1)
				{$parentuid=$row1->id;}
				
				if($this->input->post('desig1')<>'')
				{$parentuid=$data['desig1']=$this->input->post('desig1');}
				
				if($this->input->post('desig2')<>'')
				{$parentuid=$data['desig2']==$this->input->post('desig2');}
				
				if($this->input->post('desig3')<>'')
				{$parentuid=$data['desig3']=$this->input->post('desig3');}
				
				if($this->input->post('desig4')<>'')
				{$parentuid=$data['desig4']=$this->input->post('desig4');}
				
				if($this->input->post('desig5')<>'')
				{$parentuid=$data['desig5']=$this->input->post('desig5');}
				
				$stockist_ids=0;
				
			  $sqlfield="select childuid from tbl_organisation_chain
			  where  child_desig_srl=6 and parentuid='$parentuid' ";	
				
				$fields = $this->projectmodel->get_records_from_sql($sqlfield);
				foreach ($fields as $field)
					{ 	
						$sql="select * from stockist ";
						$rowrecord = $this->projectmodel->get_records_from_sql($sql);
						foreach ($rowrecord as $row1)
						{ 		
							$stockist_field = explode(",",$row1->retail_field);
							if (in_array($field->childuid, $stockist_field))
							{			
							$stockist_ids=$stockist_ids.','.$row1->id;
							}
						}
					}
				
				
				if($stockist_ids=='')
				{	
					$sql="select * from invoice_summary where id>0 
					and status='SELL'  ";
				}
				else
				{
					$sql="select * from invoice_summary where id>0 
					and status='SELL'  and  tbl_party_id in (".$stockist_ids.") ";
				}
										
				if($startingdate<>'' and $closingdate<>'')
				{
					$sql=$sql." and invoice_date between 
					'".$startingdate."' and '".$closingdate."' ";							
				}		
		
				if($stockist<>'')
				{$sql=$sql." and tbl_party_id=".$stockist;}	
				
				if($data['product_type']<>'')
				{
				 $sql=$sql." and product_type='".$data['product_type']."'";
				}
				
				
				
				//echo $sql;	
			
				$data['projectlist'] = 
				$this->projectmodel->get_records_from_sql($sql);
		}
		
		$data['report_parameter'] = 
		$this->load->view('primary_sale_view/reports/company_hierarchy',$data, true);
				
		$view_path_name='primary_sale_view/reports/sell_reports';
	    $this->page_layout_display($view_path_name,$data);
		
}
	
public function stockist_wise_sale()
{
		$data['startingdate']=date('Y-m-d');
		$data['closingdate']=date('Y-m-d');
		$data['tbl_party_id']='';
		$data['product_type']='OLDDIV';
		
		$data['stockist']=$data['desig1']='';
		$data['desig2']='';
		$data['desig3']='';
		$data['desig4']='';
		$data['desig5']='';
		
		$sql_start="select * from invoice_summary where id=0 ";
		$data['projectlist'] =$this->projectmodel->get_records_from_sql($sql_start);			
		
		if(isset($_POST) && isset($_POST['submit']))
		{
				$startingdate=$data['startingdate']=
				$this->input->post('startingdate');
				$closingdate=$data['closingdate']=$this->input->post('closingdate');
				$stockist=$data['stockist']=$this->input->post('tbl_party_id');
				$data['product_type']=$this->input->post('product_type');
				$status='SELL';
				$stockist_ids=$this->session->userdata('stockist_ids');
				
				//echo $stockist_ids;
				
				$parentuid=0;
				$login_emp_id=$this->session->userdata('login_emp_id');
				$sqlemp="select * from 
				tbl_hierarchy_org where	employee_id=".$login_emp_id;
				$rowrecord = $this->projectmodel->get_records_from_sql($sqlemp);	
				foreach ($rowrecord as $row1)
				{$parentuid=$row1->id;}
				
				$login_emp_id=$this->session->userdata('login_emp_id');
				$sqlemp="select * from 
				tbl_hierarchy_org where	employee_id=".$login_emp_id;
				$rowrecord = $this->projectmodel->get_records_from_sql($sqlemp);	
				foreach ($rowrecord as $row1)
				{$parentuid=$row1->id;}
														
				if($this->input->post('desig1')<>'')
				{$parentuid=$data['desig1']=$this->input->post('desig1');}
				
				if($this->input->post('desig2')<>'')
				{$parentuid=$data['desig2']==$this->input->post('desig2');}
				
				if($this->input->post('desig3')<>'')
				{$parentuid=$data['desig3']=$this->input->post('desig3');}
				
				if($this->input->post('desig4')<>'')
				{$parentuid=$data['desig4']=$this->input->post('desig4');}
				
				if($this->input->post('desig5')<>'')
				{$parentuid=$data['desig5']=$this->input->post('desig5');}
				
			   $stockist_ids=0;
			   $sqlfield="select childuid from tbl_organisation_chain
			   where  child_desig_srl=6 and parentuid='$parentuid' ";	
				
				$fields = $this->projectmodel->get_records_from_sql($sqlfield);
				foreach ($fields as $field)
					{ 	
						$sql="select * from stockist ";
						$rowrecord = $this->projectmodel->get_records_from_sql($sql);
						foreach ($rowrecord as $row1)
						{ 		
							$stockist_field = explode(",",$row1->retail_field);
							if (in_array($field->childuid, $stockist_field))
							{			
							$stockist_ids=$stockist_ids.','.$row1->id;
							}
						}
					}
				
				
				if($stockist_ids=='')
				{	
					$sql="select * from invoice_summary where id>0 
					and status='SELL'  ";
				}
				else
				{
					$sql="select * from invoice_summary where id>0 
					and status='SELL'  and  
					tbl_party_id in (".$stockist_ids.") ";
				}
											
				if($startingdate<>'' and $closingdate<>'')
				{
					$sql=$sql." and invoice_date between 
					'".$startingdate."' and '".$closingdate."' ";							
				}		
		
				if($stockist<>'')
				{$sql=$sql." and tbl_party_id=".$stockist;}	
			
				$sql=$sql." and product_type='".$data['product_type']."'";
			
				$data['projectlist'] = 
				$this->projectmodel->get_records_from_sql($sql);
		}
		
		$data['report_parameter'] = 
		$this->load->view('primary_sale_view/reports/company_hierarchy',$data, true);
				
		$view_path_name='primary_sale_view/reports/sell_prd_stkist';
	    $this->page_layout_display($view_path_name,$data);
		
}


public function prd_sale($prdtype){
		
	    $data['startingdate']=date('Y-m-d');
		$data['closingdate']=date('Y-m-d');
		$data['tbl_party_id']='';
		$data['product_type']='OLDDIV';
		$data['desig1']='';
		$data['desig2']='';
		$data['desig3']='';
		$data['desig4']='';
		$data['desig5']='';
		$data['stockist']='';
		
		$data['sql_inv_sum']="select id from invoice_summary where id=0 ";
		//$data['projectlist'] =$this->projectmodel->get_records_from_sql($sql_start);	
		
		
		if(isset($_POST) && isset($_POST['submit']) ){
		
		    $startingdate=$data['startingdate']=$this->input->post('startingdate');
			$closingdate=$data['closingdate']=$this->input->post('closingdate');
			$stockist=$data['stockist']=$this->input->post('tbl_party_id');
			$data['product_type']=$this->input->post('product_type');
			$status='SELL';
			$stockist_ids=$this->session->userdata('stockist_ids');
							
				$parentuid=0;
				$login_emp_id=$this->session->userdata('login_emp_id');
				$sqlemp="select * from 
				tbl_hierarchy_org where	employee_id=".$login_emp_id;
				$rowrecord = $this->projectmodel->get_records_from_sql($sqlemp);	
				foreach ($rowrecord as $row1)
				{$parentuid=$row1->id;}
				
				/*if($this->input->post('desig2')==''){$data['desig2']='ZSM';}	
				if($this->input->post('desig3')==''){$data['desig3']='RSM';}	
				if($this->input->post('desig4')==''){$data['desig4']='ASM';}	
				if($this->input->post('desig5')==''){$data['desig5']='HQ';}				
				if($stockist==''){$stockist='All_Stockist';}*/
				
				if($this->input->post('desig1')<>'')
				{$parentuid=$data['desig1']=$this->input->post('desig1');}
				
				if($this->input->post('desig2')<>'')
				{$parentuid=$data['desig2']==$this->input->post('desig2');}
				
				if($this->input->post('desig3')<>'')
				{$parentuid=$data['desig3']=$this->input->post('desig3');}
				
				if($this->input->post('desig4')<>'')
				{$parentuid=$data['desig4']=$this->input->post('desig4');}
				
				if($this->input->post('desig5')<>'')
				{$parentuid=$data['desig5']=$this->input->post('desig5');}
				
			 $stockist_ids=0;
				
			   $sqlfield="select childuid from tbl_organisation_chain
			  where  child_desig_srl=6 and parentuid='$parentuid' ";	
				
				/*$fields = $this->projectmodel->get_records_from_sql($sqlfield);
				foreach ($fields as $field)
					{ 	
						$sql="select * from stockist ";
						$rowrecord = $this->projectmodel->get_records_from_sql($sql);
						foreach ($rowrecord as $row1)
						{ 		
							$stockist_field = explode(",",$row1->retail_field);
							if (in_array($field->childuid, $stockist_field))
							{			
							$stockist_ids=$stockist_ids.','.$row1->id;
							}
						}
					}*/
				
				$fields = $this->projectmodel->get_records_from_sql($sqlfield);
				foreach ($fields as $field)
					{ 	
						$sql="select * from stockist_hq_map
						 where tbl_hierarchy_org_id=".$field->childuid;
						$rowrecord = $this->projectmodel->get_records_from_sql($sql);
						foreach ($rowrecord as $row1)
						{ 		
							$stockist_ids=$stockist_ids.','.$row1->stockist_id;
						}
					}
							
				
				if($stockist_ids=='')
				{	
					$sql="select id from invoice_summary where id>0 	
					  ";
				}
				else
				{
					$sql="select id from invoice_summary where id>0 
					 and  tbl_party_id in (".$stockist_ids.") ";
				}
											
				if($startingdate<>'' and $closingdate<>'')
				{
					$sql=$sql." and invoice_date between 
					'".$startingdate."' and '".$closingdate."' ";							
				}		
		
				if($stockist<>'')
				{$sql=$sql." and tbl_party_id=".$stockist;}	
				
				
				if($data['product_type']<>'')
				{				
				$sql=$sql." and status='SELL' 
				and product_type='".$data['product_type']."'";
				}
				
				
				if($data['product_type']<>'')
				{
				$sql_srtn=$sql." and status='SELL_RTN' 
				and product_type='".$data['product_type']."'";
				}
				else
				{
				$sql_srtn=$sql." and status='SELL_RTN' ";
				}
				
				$data['sql_inv_sum']=$sql;
				$data['sql_inv_sum_srtn']=$sql_srtn;
							
			   /*$data['sql_inv_sum']=$this->invoice_summary_table($startingdate,
				$closingdate,$hq_id,$stockist);*/
		
		}
		
		
		$data['report_parameter'] = 
		$this->load->view('primary_sale_view/reports/company_hierarchy',
		$data, true);
		$view_path_name='primary_sale_view/reports/stock_reports';
		$this->page_layout_display($view_path_name,$data);
		
}


public function stock_report_details($prdtype)
{

	    $data['startingdate']=date('Y-m-d');
		$data['closingdate']=date('Y-m-d');
		$data['tbl_party_id']='';
		$data['desig1']='';
		$data['desig2']='';
		$data['desig3']='';
		$data['desig4']='';
		$data['desig5']='';
		$data['stockist']='';
		$data['sql_inv_sum']='';
		$data['product_id']='';
	    $data['product_type']='';
		
		if(isset($_POST)){
		
		    $startingdate=$data['startingdate']=$this->input->post('startingdate');
			$closingdate=$data['closingdate']=$this->input->post('closingdate');
			$stockist=$data['stockist']=$this->input->post('tbl_party_id');
			$data['product_id']=$this->input->post('product_id');
			$status='SELL';
			$stockist_ids=$this->session->userdata('stockist_ids');
							
				$parentuid=0;
				$login_emp_id=$this->session->userdata('login_emp_id');
				$sqlemp="select * from 
				tbl_hierarchy_org where	employee_id=".$login_emp_id;
				$rowrecord = $this->projectmodel->get_records_from_sql($sqlemp);	
				foreach ($rowrecord as $row1)
				{$parentuid=$row1->id;}
								
				if($this->input->post('desig1')<>'')
				{$parentuid=$data['desig1']=$this->input->post('desig1');}
				
				if($this->input->post('desig2')<>'')
				{$parentuid=$data['desig2']==$this->input->post('desig2');}
				
				if($this->input->post('desig3')<>'')
				{$parentuid=$data['desig3']=$this->input->post('desig3');}
				
				if($this->input->post('desig4')<>'')
				{$parentuid=$data['desig4']=$this->input->post('desig4');}
				
				if($this->input->post('desig5')<>'')
				{$parentuid=$data['desig5']=$this->input->post('desig5');}
				
				$data['product_type']=$this->input->post('product_type');
				
				 $stockist_ids=0;
				 $data['stockists']=$stockist_ids = 
				 $this->projectmodel->gethierarchy_list($parentuid,'STOCKIST');
			 	
								
				$sql="select 
				a.invoice_no,a.invoice_date,a.tbl_party_id,b.product_id,
				b.batchno,b.qnty,b.rate,b.subtotal,b.freeqty,b.rate,b.mrp ,a.hq_id 
				from invoice_summary a,invoice_details b  where 
				b.invoice_summary_id=a.id	and a.status='SELL'  " ;	
				
				if($data['product_id']<>'')
				{$sql=$sql."  and  b.product_id=".$data['product_id']." ";}
				
				
				if($stockist_ids<>'')
				{$sql=$sql."  and  tbl_party_id in (".$stockist_ids.") ";}
				
											
				if($startingdate<>'' and $closingdate<>'')
				{
					$sql=$sql." and a.invoice_date between 
					'".$startingdate."' and '".$closingdate."' ";							
				}		
		
				if($stockist<>'')
				{$data['stockists']=$stockist;
				$sql=$sql." and a.tbl_party_id=".$stockist;}	
				
				
				if($data['product_type']<>'')
				{$sql=$sql." and product_type='".$data['product_type']."' ";}	
				
				$sql=$sql." order by  a.invoice_date,b.product_id ";
				
				//echo $sql;;
				
				$data['sql_inv_sum']=$sql;
							
			   /*$data['sql_inv_sum']=$this->invoice_summary_table($startingdate,
				$closingdate,$hq_id,$stockist);*/
		
		}
		
		
		$data['report_parameter'] = 
		$this->load->view('primary_sale_view/reports/company_hierarchy',
		$data, true);
		
		$view_path_name='primary_sale_view/reports/stock_reports_details';				
		$this->page_layout_display($view_path_name,$data);
		
}




	
public function primary_sale_trnd_analysis($page='',$msg='')	
	 {	 	
		$this->login_validate();
		$layout_data=array();
		$data=array();
		
			$data['startingdate']=date('Y-m-d');
			$data['closingdate']=date('Y-m-d');
			$data['stockist']=$stockist=$data['tbl_party_id']='';
			$data['desig1']='';
			$data['desig2']='';
			$data['desig3']='';
			$data['desig4']='';
			$data['desig5']='';
		   
			$data['productid'] =$this->uri->segment(3);
			$data['datalistdisplay'] ='N';
			$data['stockist']=$stockist=$data['stockist_id1']=1;
			$data['frommonth']='2014-MAR';
			$data['tomonth']='2014-MAR';
			$tomn='';		
				
			if(isset($_POST))
			{
				$values=$this->input->post();
				$data['stockist']=$stockist=$data['stockist_id1']=
				$this->input->post('stockist_id');
				
				$data['frommonth']=$this->input->post('frommonth');
				$data['tomonth']=$this->input->post('tomonth');
				
				 if(substr($data['tomonth'],0,3)=='APR'){ $tomn='04'; $todiff=1;}
				 if(substr($data['tomonth'],0,3)=='MAY'){ $tomn='05'; $todiff=2;}
				 if(substr($data['tomonth'],0,3)=='JUN'){ $tomn='06'; $todiff=3;}
				 if(substr($data['tomonth'],0,3)=='JUL'){ $tomn='07'; $todiff=4;}
				 if(substr($data['tomonth'],0,3)=='AUG'){ $tomn='08'; $todiff=5;}
				 if(substr($data['tomonth'],0,3)=='SEP'){ $tomn='09'; $todiff=6;}
				 if(substr($data['tomonth'],0,3)=='OCT'){ $tomn='10'; $todiff=7;}
				 if(substr($data['tomonth'],0,3)=='NOV'){ $tomn='11'; $todiff=8;}
				 if(substr($data['tomonth'],0,3)=='DEC'){ $tomn='12'; $todiff=9;}
				 if(substr($data['tomonth'],0,3)=='JAN'){ $tomn='01'; $todiff=10;}
				 if(substr($data['tomonth'],0,3)=='FEB'){ $tomn='02'; $todiff=11;}
				 if(substr($data['tomonth'],0,3)=='MAR'){ $tomn='03'; $todiff=12;}
				
				$data['tomonthdate']=substr($data['tomonth'],4,4).'-'.$tomn.'-01';				
				$status='SELL';
				$stockist_ids=$this->session->userdata('stockist_ids');
							
				$parentuid=0;
				$login_emp_id=$this->session->userdata('login_emp_id');
				$sqlemp="select * from 
				tbl_hierarchy_org where	employee_id=".$login_emp_id;
				$rowrecord = $this->projectmodel->get_records_from_sql($sqlemp);	
				foreach ($rowrecord as $row1)
				{$parentuid=$row1->id;}
				
				if($this->input->post('desig1')<>'')
				{$parentuid=$data['desig1']=$this->input->post('desig1');}
				
				if($this->input->post('desig2')<>'')
				{$parentuid=$data['desig2']==$this->input->post('desig2');}
				
				if($this->input->post('desig3')<>'')
				{$parentuid=$data['desig3']=$this->input->post('desig3');}
				
				if($this->input->post('desig4')<>'')
				{$parentuid=$data['desig4']=$this->input->post('desig4');}
				
				if($this->input->post('desig5')<>'')
				{$parentuid=$data['desig5']=$this->input->post('desig5');}
				
			 	  $stockist_ids=0;
				
				  $sqlfield="select childuid from tbl_organisation_chain
				  where  child_desig_srl=6 and parentuid='$parentuid' ";	
				
					$fields = $this->projectmodel->get_records_from_sql($sqlfield);
					foreach ($fields as $field)
						{ 	
							$sql="select * from stockist ";
							$rowrecord = $this->projectmodel->get_records_from_sql($sql);
							foreach ($rowrecord as $row1)
							{ 		
								$stockist_field = explode(",",$row1->retail_field);
								if (in_array($field->childuid, $stockist_field))
								{			
								$stockist_ids=$stockist_ids.','.$row1->id;
								}
							}
						}
							
				
				if($stockist_ids=='')
				{	
					$sql="select id from invoice_summary where id>0 	
					and status='SELL'  ";
				}
				else
				{
					$sql="select id from invoice_summary where id>0 
					and status='SELL'  and  tbl_party_id in (".$stockist_ids.") ";
				}
					
				if($stockist<>'')
				{$sql=$sql." and tbl_party_id=".$stockist;}	
				
				$data['sql_inv_sum']=$sql;
							
			   /*$data['sql_inv_sum']=$this->invoice_summary_table($startingdate,
				$closingdate,$hq_id,$stockist);*/
		
		}	
		
		
		$data['report_parameter'] = 
		$this->load->view('primary_sale_view/reports/company_hierarchy2',
		$data, true);
		
		$view_path_name='primary_sale_view/reports/prd_sale_monthwise';
		$this->page_layout_display($view_path_name,$data);
					
}	
	




public function prd_sale_details($desig2='',$desig3='',$desig4='',$desig5=''
,$stockistid='',$tomonth='',$brand_id=0,$pkg='')	
{	 	
		$this->login_validate();
		$layout_data=array();
		$data=array();
		
		if($stockistid=='All_Stockist'){$stockistid=''; }
		if($desig2=='ZSM'){$desig2=''; }
		if($desig3=='RSM'){$desig3=''; }
		if($desig4=='ASM'){$desig4=''; }
		if($desig5=='HQ'){$desig5=''; }
				
		$data['stockist_ids']=$stockistid;
		$desig1=$data['desig1']='';
		$data['desig2']=$desig2;
		$data['desig3']=$desig3;
		$data['desig4']=$desig4;
		$data['desig5']=$desig5;
		$data['tomonth']=$tomonth;
		
		$data['brand_id']=$brand_id;
		$data['pkg']=$pkg;
		
		$stockist_ids=$this->projectmodel->stockist_list($stockistid,$desig1,
		$desig2,$desig3,$desig4,$desig5);
		
		if($data['stockist_ids']=='')
		{ $data['stockist_ids']=$stockist_ids;}
		
		
	    $data['startingdate'] =$startingdate;
		$data['closingdate'] =$closingdate;	
		
		// layout section .....
		$viewnamepath='primary_sale_view/reports/stock_reports_detail';
		$layout_data['data_info'] = $this->load->view($viewnamepath,$data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('report_layout', $layout_data);
		$this->session->set_userdata('alert_msg', '');		
		 
		
}
	
public function company_hierarchy_fn(){
		
		$data['startingdate']=date('Y-m-d');
		$data['closingdate']=date('Y-m-d');
			
		if(isset($_POST)){
		
			$startingdate=$data['startingdate']=$this->input->post('startingdate');
			$closingdate=$data['closingdate']=$this->input->post('closingdate');
			$hq_id=$data['hq_id']=$this->input->post('hq_id');
			$stockist=$data['stockist']=$this->input->post('stockist');		
		
		}
	   $view_path_name='primary_sale_view/reports/company_hierarchy';
	   $this->page_layout_display($view_path_name,$data);
	
	}
	
	public function invoice_summary_table($startingdate,
	$closingdate,$hq_id,$stockist)
	{
				
			$sql="select id from invoice_summary where id>0  ";
			if($startingdate<>'' and $closingdate<>'')
			{
				$sql=$sql." and invoice_date between 
				'".$startingdate."' 
				and '".$closingdate."' ";							
			}
			
			if($hq_id<>'')
			{
				
				/*$sqlstk="select id from stockist where retail_field IN 
				(SELECT id from tbl_hierarchy_org 
				where under_tbl_hierarchy_org=".$hq_id.") ";	*/
				
				$sqlstk="select id from stockist where id IN 
				(select stockist_id from stockist_hq_map where 
				tbl_hierarchy_org_id in (SELECT id from tbl_hierarchy_org 
				where under_tbl_hierarchy_org=".$hq_id.")
				)";
				
				$sql=$sql." and tbl_party_id in ( ".$sqlstk." ) ";						
			}
			
			if($stockist<>'')
			{
				$sql=$sql." and tbl_party_id=".$stockist;						
			}
			return $sql=$sql." order by id";
		
	}
	
	
	
	
	
	public function batchwise_prd_sale()
	{
		$startingdate='';$closingdate='';$search='';
		if(isset($_POST)){print_r($_POST);
		$startingdate=$this->input->post('startingdate');
		$closingdate=$this->input->post('closingdate');
		$search=$this->input->post('search');		
		$data['projectlist']=$this->projectmodel->getType1Record($startingdate,$closingdate,$search);
		$data['startingdate']=$startingdate;
		$data['closingdate']=$closingdate;
		$data['search']=$search;
		}
		$viewnamepath='primary_sale_view/reports/batchwise_prd_sale';
		$data['product']=$this->projectmodel->getAllProduct();
		
		
		$layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		$layout_data['top_menu'] = $this->load->view('common/top_menu','', true);
		$layout_data['data_info'] = $this->load->view($viewnamepath,$data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout', $layout_data);
	}
	
	
	
	public function batch_product_report(){
		
		$data['startingdate']=date('Y-m-d');
		$data['closingdate']=date('Y-m-d');
		if(isset($_POST))
		{
			$data['startingdate']=$this->input->post('startingdate');
			$data['closingdate']=$this->input->post('closingdate');
			$data['opendate']=$this->general_library->get_date($data['startingdate'],-1,0,0);
						
		}
	
	   $view_path_name='primary_sale_view/reports/batch_wise_stock';
	   $this->page_layout_display($view_path_name,$data);
	}
	
	
	
	
	public function stock_balance_invoice_wise()
	{
		$data['closingdate']=date('Y-m-d');
		if(isset($_POST))
		{$data['closingdate']=$this->input->post('closingdate');}
		
		$data['startingdate']=date('Y-m-d');
		if(isset($_POST))
		{$data['startingdate']=$this->input->post('startingdate');}
	
	
	   $view_path_name='primary_sale_view/reports/stock_invoice';
	   $this->page_layout_display($view_path_name,$data);
	}
	
public function stock_balance()
	{
		$data['closingdate']=date('Y-m-d');
		if(isset($_POST))
		{$data['closingdate']=$this->input->post('closingdate');}
	
	   $view_path_name='primary_sale_view/reports/stock_balance';
	   $this->page_layout_display($view_path_name,$data);
	}
	
public function sample_ratio_report($operation_type='listing')
{
			
			$layout_data=array();
			$data=array();
			$data['hq_id']='';
			$data['from_date']=date('Y-m-d');
			$data['to_date']=date('Y-m-d');
			
			if(isset($_POST))
			{	
				if($operation_type=='listing')
				{
				  $data['from_date']=$this->input->post('from_date');
				  $data['to_date']=$this->input->post('to_date');
				}	
				if($operation_type=='save')
				{
				  $data['from_date']=$this->input->post('from_date');
				  $data['to_date']=$this->input->post('to_date');
				}
			}
			
			$view_path_name='primary_sale_view/reports/sample_ratio_report';
	   		$this->page_layout_display($view_path_name,$data);	
				   
}	



	


public function stock_balance_details($product_id='',$batchno='',$maxid='',
$closingdate='')
	{
		$data['product_id']=$product_id;
		$data['batchno']=$batchno;
		$data['maxid']=$maxid;
		$data['closingdate']=$closingdate;
				
		
		$viewnamepath='primary_sale_view/reports/stock_balance_details';
		$layout_data['data_info'] = $this->load->view($viewnamepath,$data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout_only_body', $layout_data);
		$this->session->set_userdata('alert_msg', '');
		
	   
	}


public function stock_balance_details_save( )
	{
		
		if(isset($_POST))
		{	
					
			$data['product_id']=$product_id=$this->input->post('product_id');
			$data['batchno']=$batchno=$this->input->post('batchno');
			$data['maxid']=$maxid=$this->input->post('maxid');
			$data['closingdate']=$closingdate=$this->input->post('closingdate');
			
			$sqlmain="select * 	from invoice_details where 
			product_id=".$product_id." and batchno='$batchno' 
			and invoice_summary_id in 
			(select id from invoice_summary where 		
			invoice_date between '2012-01-01' and '$closingdate' ) order by id " ;
			
			$sqllists = 
			$this->projectmodel->get_records_from_sql($sqlmain);
			foreach ($sqllists as $sqllist)
			{
				$inv_detail_id=$sqllist->id;
				$addqty= $this->input->post('addqty'.$inv_detail_id);
				$reduceqty= $this->input->post('reduceqty'.$inv_detail_id);
				$manfacdate= $this->input->post('manfacdate'.$inv_detail_id);
				$expirtdate= $this->input->post('expirtdate'.$inv_detail_id); 
				
				if($addqty>0){
				 $query ="update invoice_details 
				set qnty=qnty + ".$addqty." ,totqnty=totqnty + ".$addqty."
				where id=".$inv_detail_id." "; 
				
				$this->db->query($query);
				}
				
				if($reduceqty>0){
				$query ="update invoice_details 
				set qnty=qnty  - ".$reduceqty.",totqnty=totqnty - ".$reduceqty."
				where id=".$inv_detail_id." "; 
				
				$this->db->query($query);
				}
				
				if($manfacdate<>''){
				$query ="update invoice_details 
				set mfg_monyr='".$manfacdate."'
				where id=".$inv_detail_id." "; 
				
				$this->db->query($query);
				}
				
				if($expirtdate<>''){
				$query ="update invoice_details 
				set	exp_monyr='".$expirtdate."'
				where id=".$inv_detail_id." "; 
				
				$this->db->query($query);
				}
				
			
			}
			
		
		}
		
		
		$viewnamepath='primary_sale_view/reports/stock_balance_details';
		$layout_data['data_info'] = $this->load->view($viewnamepath,$data, true);
		$layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		$this->load->view('layout_only_body', $layout_data);
		$this->session->set_userdata('alert_msg', '');
		
	   
}

	
	
	/* REPORT PORTION COMPLETE    */
		
	public function hierarchy($viewname='',$designo='',$desigvalue='') 
	{
    
	//$viewnamepath='reports/'.$viewname; 	
	//redirect('primary_sale_controller/'.$viewnamepath.$values['id']);	
	
		if($viewname=='sell_prd_stkist')
		{
			$this->session->set_userdata($designo, $desigvalue);
			redirect(				'primary_sale_controller/print_function/sell_prd_stkist/invoice_summary/list/0');
		}
		
		
    } 	
	
	
	public function primary_cn_trnd_analysis($page='',$msg='')	
	 {	 	
		$this->login_validate();
		$layout_data=array();
		$data=array();
		
			$data['startingdate']=date('Y-m-d');
			$data['closingdate']=date('Y-m-d');
			$data['stockist']=$stockist=$data['tbl_party_id']='';
			$data['desig1']='';
			$data['desig2']='';
			$data['desig3']='';
			$data['desig4']='';
			$data['desig5']='';
		   
			$data['productid'] =$this->uri->segment(3);
			$data['datalistdisplay'] ='N';
			$data['stockist']=$stockist=$data['stockist_id1']=1;
			$data['frommonth']='2014-MAR';
			$data['tomonth']='2014-MAR';
			$status=$data['status']='';
			$tomn='';		
				
			if(isset($_POST))
			{
				$values=$this->input->post();
				$data['stockist']=$stockist=$data['stockist_id1']=
				$this->input->post('stockist_id');
				
				$data['frommonth']=$this->input->post('frommonth');
				$data['tomonth']=$this->input->post('tomonth');
				$status=$data['status']=$this->input->post('status');
				
				 if(substr($data['tomonth'],0,3)=='APR'){ $tomn='04'; $todiff=1;}
				 if(substr($data['tomonth'],0,3)=='MAY'){ $tomn='05'; $todiff=2;}
				 if(substr($data['tomonth'],0,3)=='JUN'){ $tomn='06'; $todiff=3;}
				 if(substr($data['tomonth'],0,3)=='JUL'){ $tomn='07'; $todiff=4;}
				 if(substr($data['tomonth'],0,3)=='AUG'){ $tomn='08'; $todiff=5;}
				 if(substr($data['tomonth'],0,3)=='SEP'){ $tomn='09'; $todiff=6;}
				 if(substr($data['tomonth'],0,3)=='OCT'){ $tomn='10'; $todiff=7;}
				 if(substr($data['tomonth'],0,3)=='NOV'){ $tomn='11'; $todiff=8;}
				 if(substr($data['tomonth'],0,3)=='DEC'){ $tomn='12'; $todiff=9;}
				 if(substr($data['tomonth'],0,3)=='JAN'){ $tomn='01'; $todiff=10;}
				 if(substr($data['tomonth'],0,3)=='FEB'){ $tomn='02'; $todiff=11;}
				 if(substr($data['tomonth'],0,3)=='MAR'){ $tomn='03'; $todiff=12;}
				
				$data['tomonthdate']=substr($data['tomonth'],4,4).'-'.$tomn.'-01';				
				//$status='SELL';
				$stockist_ids=$this->session->userdata('stockist_ids');
							
				$parentuid=0;
				$login_emp_id=$this->session->userdata('login_emp_id');
				$sqlemp="select * from 
				tbl_hierarchy_org where	employee_id=".$login_emp_id;
				$rowrecord = $this->projectmodel->get_records_from_sql($sqlemp);	
				foreach ($rowrecord as $row1)
				{$parentuid=$row1->id;}
				
				if($this->input->post('desig1')<>'')
				{$parentuid=$data['desig1']=$this->input->post('desig1');}
				
				if($this->input->post('desig2')<>'')
				{$parentuid=$data['desig2']==$this->input->post('desig2');}
				
				if($this->input->post('desig3')<>'')
				{$parentuid=$data['desig3']=$this->input->post('desig3');}
				
				if($this->input->post('desig4')<>'')
				{$parentuid=$data['desig4']=$this->input->post('desig4');}
				
				if($this->input->post('desig5')<>'')
				{$parentuid=$data['desig5']=$this->input->post('desig5');}
				
			 	  $stockist_ids=0;
				
				  $sqlfield="select childuid from tbl_organisation_chain
				  where  child_desig_srl=6 and parentuid='$parentuid' ";	
				
					$fields = $this->projectmodel->get_records_from_sql($sqlfield);
					foreach ($fields as $field)
						{ 	
							$sql="select * from stockist ";
							$rowrecord = $this->projectmodel->get_records_from_sql($sql);
							foreach ($rowrecord as $row1)
							{ 		
								$stockist_field = explode(",",$row1->retail_field);
								if (in_array($field->childuid, $stockist_field))
								{			
								$stockist_ids=$stockist_ids.','.$row1->id;
								}
							}
						}
							
				
				if($stockist_ids=='')
				{	
					$sql="select id from invoice_summary where id>0 and ";
					//(status='SELL_RTN' or status='SELL_RTN_EXP')
				}
				else
				{
					$sql="select id from invoice_summary where id>0 
					  and  tbl_party_id in (".$stockist_ids.")";
					// and (status='SELL_RTN' or status='SELL_RTN_EXP')	  
				}
					
				if($stockist<>'')
				{$sql=$sql." and tbl_party_id=".$stockist;}	
				
				
				if($status=='')
				{
					$sql=$sql."  
					and (status='SELL_RTN' or status='SELL_RTN_EXP')";
				}
				else
				{
					$sql=$sql." and status='".$status."' ";
				}
									
				//echo $sql;
				
				$data['sql_inv_sum']=$sql;
							
			   /*$data['sql_inv_sum']=$this->invoice_summary_table($startingdate,
				$closingdate,$hq_id,$stockist);*/
		
		}	
		
		
		$data['report_parameter'] = 
		$this->load->view('primary_sale_view/reports/company_hierarchy2',
		$data, true);
		
		$view_path_name='primary_sale_view/reports/prd_cntrend_monthwise';
		$this->page_layout_display($view_path_name,$data);
					
}	

	
	
	
	private function page_layout_display($view_path_name,$data)
	{
		
		   $data['user_name'] = $this->session->userdata('user_name');
		   $layout_data['left_bar'] = $this->load->view('common/left_bar', '', true);
		   $layout_data['top_menu'] = $this->load->view('common/top_menu', $data, true);
		   $layout_data['data_info'] = 
		   $this->load->view($view_path_name,$data, true);			
		   $layout_data['body'] = $this->load->view('common/body', $layout_data, true);
		   $this->load->view('layout', $layout_data);
		   $this->session->set_userdata('alert_msg', '');	
	
	}
	private function report_page_layout_display($view_path_name,$data)
	{
		   $layout_data['data_info'] = 
		   $this->load->view($view_path_name,$data, true);			
		   $layout_data['body'] = $this->load->view('common/body', $layout_data, true);		 
		   $this->load->view('report_layout', $layout_data);
		   $this->session->set_userdata('alert_msg', '');	
	}	
	
}

?>
